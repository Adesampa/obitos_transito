---
title: Análise das Mortes no Trânsito no Município de São Paulo
author: "Agência São Paulo de Desenvolvimento - ADE SAMPA"
date: "`r format(Sys.Date(), format='%d/%m/%Y')`"
output:
    html_document:
      theme: flatly
      self-contained: yes
      toc: yes
      toc_float: yes
      css: 
        - style.css
editor_options: 
  markdown: 
    wrap: 72
---


```{r setup, include=FALSE}

(knitr::opts_chunk$set(
	echo = FALSE,
	error = FALSE,
	message = FALSE,
	warning = FALSE
 )
) 
```


```{r}

library("ggpubr")
library("tidyverse")
library("kableExtra")
library("knitr")
library("tidylog")
library("readxl")
library("geobr")
library("sf")
library("wesanderson")
library("ggplot2")
library("stringr")
library ("abjData")
library("extrafont")
library("lubridate")
library("transformr")
library("reactable")
library("rnaturalearth")
library("plotly")
library("ggrepel")
library('googlesheets4')
library("leaflet")
library('ggthemes')
library('rmdformats')
library("janitor")
library("reactablefmtr")
library("corrplot")
library("lubridate")
library("janitor")
library("ggmap")
library("stringr")
library("stringi")
library("ggthemes")
library("ggiraph")
library("patchwork")
library("showtext")
library("htmltools")
library("gganimate")
library("gifski")
library("av")
library("scales")
library("png")
library("magick")

```



```{r include=FALSE}

# dowwnload dos dados do infosiga (https://www.infosiga.sp.gov.br/)


dados <- read.csv("C:/Users/Thais Pereira/Documents/obitos_transito/obitos.csv")

shp_distritos <- st_read("C:/Users/Thais Pereira/Documents/shapefile/distritos_cnpj_2.shp")

pop <- read_excel("C:/Users/Thais Pereira/Documents/obitos_transito/pop.xlsx")

```

```{r include=FALSE}

# Adicionar a fonte do Google Fonts
font_add_google("Lora", "Lora")

# Ativar suporte a fontes no ggplot
showtext_auto()


```

## **Resumo**


Esse relatório proprõe uma análise geoespacial detalhada dos dados de mortes no transito no município de São Paulo entre os anos de 2015 e 2024, a partir dos dados disponibilizados pelo INFOSIGA SP - Sistema de Informações Gerenciais de Acidentes de Trânsito do Estado de São Paulo. Pretendemos contribuir com uma análise que identifica um perfil da população vitimada pelos acidentes além de situações e modais de risco para cada distrito da cidade. Pretendemos contribuir com o desenvolvimento de políticas públicas baseadas em evidências das especificidades de cada região da cidade de São Paulo. 

## **Introdução**

Lançado em 2015, o INFOSIGA faz parte de um conjunto de iniciativas do Movimento Paulista de Segurança no Trânsito, lançado pelo Governo do estado de São Paulo em agosto de 2015, que tinha por objetivo reduzir pela metade as vítimas fatais em acidentes de trânsito até 2020. A meta estadual estava na época, inspirada pela resolução de março de 2010 da Assembleia-Geral das Nações Unidas, definida como “Primeira década de ação pela segurança no trânsito". A campanha tinha por objetivo conscientizar os países a adotarem medidas visando a diminuição dos números de mortalidade no trânsito, e de fato mobilizou as autoridades de diversos países, a do Brasil inclusive, que se posicionou como país signatário da iniciativa, com engajamentos diversificados por parte dos gestores de transito. Ao final da primeira década a ONU lançou em 2021 a “segunda década de ação pela segurança no trânsito” incentivando os países a estipularem novas metas para 2030. 

A situação é complicada no mundo todo, segundo dados da OMS de 2022, 1,3 milhão de pessoas morrem anualmente em acidentes de trânsito, o que supera em número de mortos doenças como o HIV/AIDS, tuberculose e doenças diarreicas, sendo esta a 8ª causa do maior número de mortes no mundo (WHO, 2018).

Em termos proporcionais à população, o Brasil tem dados alarmantes, o número de mortos por 100 mil habitantes anualmente é cerca de dez vezes maior que nos países mais seguros (IPEA, 2006, 2015), e na época do lançamento da primeira campanha da ONU eramos o quinto pais com mais mortes no transito no mundo, gerando um custo anual de cerca de de R$ 50 bilhões a preços atuais (IPEA, 2023).   

O INFOSIGA surge como uma ferramenta que possibilita a transparência das informações e o subsídio ao desenvolvimento de políticas públicas de prevenção baseado em evidências. Os dados dispobilizados mensalmente são baseados na sistematização de boletins de ocorrência da Polícia Civil do Estado de São Paulo, para o cálculo das estatísticas relativas a óbitos no transito, além dos dados que serão analisados neste relatório a plataforma INFOSIGA também disponibiliza informações de acidentes de transito com vítimas, utilizando os dados recebidos pela Polícia Militar e Polícia Rodoviária Federal.

No âmbito nacional a Lei Federal nº 13.614/18 assinada em 11 de janeiro de 2018 criou o Plano Nacional de Redução de Mortes e Lesões no Trânsito (Pnatrans), com uma série de diretrizes que visam a diminuição de mortes e lesões causadas por acidentes de trânsito. O principal objetivo é diminuir a proporção de mortos em relação à população e em relação ao número de veículos de uma localidade num prazo de dez anos. 

Tendo em vista a demonstração de preocupação por parte das autoridades federais e estatuais no que diz respeito às mortes no transito, propomos primeiramente uma análise geral da situação dos óbitos nos distritos da cidade de São Paulo, depois uma análise temporal para identificarmos mudanças e tendências gerais e por último uma análise geoespacial detalhada da população, modais de risco para cada uma dessas regiões da cidade de São Paulo, buscando sistematizar informações que podem direcionar a tomada de decisão do poder público.  


## **Estatísticas Gerais**


## 1. Mapas das mortes por distritos 

Os mapas apresentados abaixo mostram a distribuição das mortes no trânsito na cidade de São Paulo, destacando tanto os números absolutos quanto a taxa de óbitos por 100 mil habitantes. Tendo como base que segundo o IBGE São Paulo contava em 2022 com 11.451.999 habitantes, e entre 2015 e 2024 a cidade somou um total de **9.216** mortes no trânsito, temos uma taxa geral de **80,5** mortes para cada 100 mil habitantes. Em termos absolutos, os distritos com maior número de óbitos foram Jardim **Jardim Sao Luis (231)**, **Grajaú (229)** e **Cidade Dutra (196)**, enquanto os que registraram menos mortes foram **Marsilac (4)**, **Perdizes (21)** e **Bela Vista (26)**. Quando analisamos os piores distritos em termos de taxa de mortalidade proporcional à população, os destaques negativos são **Sé (314 mortes por 100 mil habitantes)**, **Jaraguá (287)** e **Butantã (201)**, enquanto os distritos com menor impacto proporcional foram **Perdizes (20)**, **Jardim Helena (27)** e **Cidade Líder (33)**. Um adenso a utilização da base de dados do Infogsiga é que para 983 mortes não foi possível encontrar o distrito de acontecimento do acidente, ou por falta de informações de latitude e longitude ou por imprecisão do dado, no entanto somamos esse caso para as estatísticas gerais. 



```{r include=FALSE}

dados_1 <- dados %>% 
  mutate(Data.do.Sinistro = dmy(Data.do.Sinistro),  
  Ano = year(Data.do.Sinistro)) %>% 
  filter(!is.na(ds_nome)) %>% 
  filter(Ano != 2012 & Ano != 2013 & Ano !=  2014 & Ano !=  2010 & Ano !=  1995 &  Ano !=  1986 & Ano !=  2000 & Ano !=  2009 & Ano !=  2011) %>% 
  clean_names() %>% 
  group_by(ds_nome) %>% 
  tally() %>% 
  mutate(ds_nome = str_to_title(ds_nome)) %>% 
  left_join(pop, by = "ds_nome") %>% 
  mutate(pct = n/sum(n)*100) %>% 
  mutate(mortes_cem_mil_hab = n/pop*100000)

# Transformar em coordenadas geográficas
shp_distritos <- st_transform(shp_distritos, crs = 4326)

shp_distritos <- shp_distritos %>% rename(ds_nome = NOME_DIST)

shp_distritos_1 <- shp_distritos %>% mutate(
    Indice = as.character(row_number()),
    ds_nome = str_trim(ds_nome),  
    ds_nome = stri_trans_general(ds_nome, "Latin-ASCII"), 
    ds_nome = str_to_title(ds_nome)  
  ) %>% 
  mutate(
    ds_nome = case_when(
      ds_nome == "Agua Rasa\n" ~ "Agua Rasa",
      ds_nome == "Alto De Pinheiros\n" ~ "Alto De Pinheiros",
      ds_nome == "Anhanguera\n" ~ "Anhanguera",
      TRUE ~ ds_nome
    )
  )

shp_distritos_2 <- shp_distritos_1 %>%
  left_join(dados_1, by = "ds_nome")


```



```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}

theme_update(plot.title = element_text(size = 24, face = "bold", hjust = 0.5, family = "Lora"))

# Criar categorias de óbitos
shp_distritos_3 <- shp_distritos_2 %>%
  mutate(group_n = cut(n, breaks = c(0, 50, 100, 150, 200, 250), include.lowest = TRUE))

# Criar categorias para o gráfico lateral
pop_n <- shp_distritos_3 %>%
  st_drop_geometry() %>%
  group_by(group_n) %>%
  summarise(score = sum(n, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_n)
  ) %>%
  na.omit()


# Criar o mapa com os distritos de São Paulo e os óbitos
pmap <- ggplot(shp_distritos_3) +
  geom_sf_interactive(aes(fill = n, geometry = geometry, 
                          data_id = group_n, 
                          tooltip = paste(ds_nome, "<br>Óbitos:", n)),  # Nome + Óbitos
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "Óbitos",
    breaks = c(50, 100, 150, 200, 250),
    direction = 1,
    palette = "Reds"
  ) +
  labs(
    title = "",
    subtitle = "",
    caption = ""
  ) +
  theme_map() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = rel(2), hjust = 0.5, family = "Lora"),
    plot.caption = element_text(size = 25, hjust = 0.5, family = "Lora")
  ) + 
  guides(fill = "none")

# Criar o gráfico de barras laterais com os percentuais
x_labels <- c("0-50", "51-100", "101-150", "151-200", "201-250+")

pcol <- ggplot(pop_n, aes(group_n, share, fill = group_n)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
    geom_text_interactive(
    aes(
      y = pmin(share + 5, max(share) - 2),  # Impede que o texto saia do gráfico
      label = label, 
      color = case_when(
        group_n == "201-250+" ~ "black",  # Apenas essa categoria ficará preta
        TRUE ~ "white"
      ), 
      data_id = data_id
    ),
    size = 8, 
    hjust = -0.1 # Mantém os textos afastados para a direita
  ) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 18),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_n$share) + 30)

# Aplicar ao gráfico
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora")) +
  coord_sf(expand = FALSE) +  # Evita cortes no mapa
  theme_void() +
    annotate("text", 
           x = mean(st_bbox(shp_distritos_3)[c("xmin", "xmax")]),  # Centraliza no eixo X
           y = st_bbox(shp_distritos_3)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_3)[c("ymin", "ymax")]),  # Move para cima
           label = "Total absoluto de mortes",
           hjust = 0.5, vjust = 1, size = 12, fontface = "bold", family = "Lora")


# Combinar o mapa e o gráfico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)

# Criar um gráfico interativo com ggiraph
interactive_plot <- girafe(
  ggobj = p_final,
  width_svg = 14,   # Aumenta a largura do gráfico lateral
  height_svg = 12,
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)


```




```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}

theme_update(plot.title = element_text(size = 24, face = "bold", hjust = 0.5, family = "Lora"))

shp_distritos_3 <- shp_distritos_2 %>%
  mutate(group_mortes = cut(mortes_cem_mil_hab, 
                            breaks = quantile(mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE), 
                            include.lowest = TRUE))


# Criar categorias para o gráfico lateral (percentual de distritos por faixa)
pop_mortes <- shp_distritos_3 %>%
  st_drop_geometry() %>%
  group_by(group_mortes) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes)
  ) %>%
  na.omit()

# Criar o mapa com os distritos de São Paulo e a taxa de óbitos
pmap <- ggplot(shp_distritos_3) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geometry, 
                          data_id = group_mortes, 
                          tooltip = paste(ds_nome, "<br>Óbitos por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "Óbitos por 100k",
    breaks = quantile(shp_distritos_3$mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE),
    direction = 1,
    palette = "Reds"
  ) +
  labs(
    title = "",
    subtitle = "",
    caption = ""
  ) +
  theme_map() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = rel(2), hjust = 0.5, family = "Lora"),
    plot.caption = element_text(size = 25, hjust = 0.5, family = "Lora")
  ) + 
  guides(fill = "none")

# Criar o gráfico de barras laterais com os percentuais de distritos por taxa de óbitos
x_labels <- c("Baixo", "Médio-Baixo", "Médio", "Médio-Alto", "Alto")

pcol <- ggplot(pop_mortes, aes(group_mortes, share, fill = group_mortes)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
  aes(
    y = pmin(share + 5, max(share) - 2),  
    label = paste0(round(share, 1), "%"),  
    color = case_when(
      as.character(group_mortes) == max(as.character(group_mortes)) ~ "black",  # Converte para caractere
      TRUE ~ "white"
    ), 
    data_id = data_id
  ),
  size = 8, 
  hjust = -0.1 
) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 30)

# Aplicar ao gráfico a fonte 'Lora' e evitar cortes
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora")
) + coord_sf(expand = FALSE) + theme_void() +
  annotate("text", 
           x = mean(st_bbox(shp_distritos_3)[c("xmin", "xmax")]),  # Centraliza no eixo X
           y = st_bbox(shp_distritos_3)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_3)[c("ymin", "ymax")]),  # Move para cima
           label = "Taxa de mortes por 100k hab.",
           hjust = 0.5, vjust = 1, size = 12, fontface = "bold", family = "Lora")


# Combinar o mapa e o gráfico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)


# Criar um gráfico interativo com ggiraph
interactive_plot_2 <- girafe(
  ggobj = p_final,
  width_svg = 14,   # Aumenta a largura do gráfico lateral
  height_svg = 12,   # Aumenta a altura do gráfico lateral
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)


```


```{r, echo=FALSE, fig.height= 14, fig.width=16, out.width="100%", results="asis"}
library(htmltools)

# Criar layout flexível para exibir os gráficos lado a lado
htmltools::browsable(
  tags$div(
    style = "display: flex; justify-content: space-between; align-items: center; width: 100%;",
    
    # Mapa interativo (primeiro gráfico)
    tags$div(style = "width: 50%;", interactive_plot),  
    
    # Gráfico lateral interativo (segundo gráfico)
    tags$div(style = "width: 50%;", interactive_plot_2)  
  )
)



```

```{r include=FALSE}

# taxa de óbitos por 100k hab. e total de óbitos absolutos

dados %>% 
  mutate(Data.do.Sinistro = dmy(Data.do.Sinistro),  
  Ano = year(Data.do.Sinistro)) %>% 
  filter(Ano != 2012 & Ano != 2013 & Ano !=  2014 & Ano !=  2010 & Ano !=  1995 &  Ano !=  1986 & Ano !=  2000 & Ano !=  2009 & Ano !=  2011) %>% 
  clean_names() %>% 
  group_by(ds_nome) %>% 
  tally() %>% 
  mutate(ds_nome = str_to_title(ds_nome)) %>% 
  left_join(pop, by = "ds_nome") %>% 
  summarise(
    total_obitos = sum(n, na.rm = TRUE),
    total_populacao = sum(pop, na.rm = TRUE),  
    taxa_obitos = (sum(n, na.rm = TRUE) / sum(pop, na.rm = TRUE)) * 100000
  )

dados_1 %>% arrange(-n)

```


## **Quantidade de mortes ao longo do Tempo**


```{r echo=FALSE}

options(bitmapType = "cairo")

# Adicionar a fonte Lora
font_add_google("Lora", "Lora")
showtext_auto()

# Criar o gráfico animado
primeiro_gif <- dados %>% 
  mutate(Data.do.Sinistro = dmy(Data.do.Sinistro),  
         Ano = as.numeric(year(Data.do.Sinistro))) %>%  # 🔹 Garante que Ano é numérico
  filter(!Ano %in% c(2012, 2013, 2014, 2010, 1995, 1986, 2000, 2009, 2011)) %>%  # 🔹 Remove anos indesejados
  group_by(Ano) %>% 
  tally() %>% 
  ggplot(aes(x = Ano, y = n)) +  
  geom_point(color = "#2F58A4", size = 5, alpha = 0.5) +  
  labs(title = "Evolução das Mortes no Trânsito",
       x = "",
       y = "") +
#  scale_x_continuous(breaks = Ano, labels = as.character(Ano))+  # 🔹 Remove ".0" dos anos
  theme_minimal() +
  scale_x_continuous(breaks=seq(2015,2024,1)) +
  theme(plot.title = element_text(family = "Lora", size = 16, face = "bold", hjust = 0.5, colour = "black"),
        text = element_text(family = "Lora"),
        axis.text = element_text(size = 11),
        axis.text.x = element_text(size = 10),
        legend.text = element_text(size = 10, face = "bold"),
        legend.title = element_text(size = 10, face = "bold"),
        legend.position = "bottom") +
  transition_reveal(Ano) +  
  shadow_trail()

png(filename = "temp.png", width = 600, height = 400)
dev.off()

# Gerar a animação
animate(
    plot = primeiro_gif,
    renderer = gifski_renderer(),
    height = 400,
    width = 600, 
    duration = 10
)



```




## **Análise Socio econômica**


## **Análise por Distrito**


## **Considerações Finais**


## **Referências**













