---
title: Análise das Mortes no Trânsito no Município de São Paulo \n Relatório Executivo
author: "Agência São Paulo de Desenvolvimento - ADE SAMPA"
date: "`r format(Sys.Date(), format='%d/%m/%Y')`"
output:
    html_document: 
      theme: flatly
      self-contained: true
      toc: true
      toc_float: true
      css: style.css
editor_options: 
  markdown: 
    wrap: 72
  chunk_output_type: inline
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(global.par = TRUE)
knitr::opts_knit$set(globalenv = TRUE)

(knitr::opts_chunk$set(
	echo = FALSE,
	error = FALSE,
	message = FALSE,
	warning = FALSE
 )
)


```


```{r}

library("ggpubr")
library("tidyverse")
library("kableExtra")
library("knitr")
library("tidylog")
library("readxl")
library("geobr")
library("sf")
library("wesanderson")
library("ggplot2")
library("stringr")
library ("abjData")
library("extrafont")
library("lubridate")
library("transformr")
library("reactable")
library("rnaturalearth")
library("plotly")
library("ggrepel")
library('googlesheets4')
library("leaflet")
library('ggthemes')
library('rmdformats')
library("janitor")
library("reactablefmtr")
library("corrplot")
library("lubridate")
library("janitor")
library("ggmap")
library("stringr")
library("stringi")
library("ggthemes")
library("ggiraph")
library("patchwork")
library("showtext")
library("htmltools")
library("gganimate")
library("gifski")
library("av")
library("scales")
library("png")
library("magick")
library("ggtext")
library("waffle")
library("MetBrewer")
library("dplyr")
library("glue")
library("marquee")
library("geobr")

```



```{r include=FALSE}

# dowwnload dos dados do infosiga (https://www.infosiga.sp.gov.br/)


dados <- read_csv("C:/Users/Thais Pereira/Documents/obitos_transito/obitos.csv", locale = locale(encoding = "UTF-8"))

dados_estado <- read_excel("C:/Users/Thais Pereira/Documents/obitos_transito/obitos_todos.xlsx")

dados_logadouro <- read_csv("C:/Users/Thais Pereira/Documents/obitos_transito/obitos_logadouro.csv", locale = locale(encoding = "UTF-8"))

shp_distritos <- st_read("C:/Users/Thais Pereira/Documents/shapefile/distritos_cnpj_2.shp")

pop <- read_excel("C:/Users/Thais Pereira/Documents/obitos_transito/pop.xlsx")

pop_estado <- read_excel("C:/Users/Thais Pereira/Documents/obitos_transito/pop_estado.xlsx")

```






```{r  include=FALSE}

# Adicionar a fonte do Google Fonts
font_add_google("Lora", "Lora")

# Ativar suporte a fontes no ggplot
showtext_auto()

dados_filtrados <- dados %>%
   mutate(`Data do Sinistro` = dmy(`Data do Sinistro`),  
   Ano = year(`Data do Sinistro`), 
   Mes = month(`Data do Sinistro`)) %>% 
   mutate(Mes = factor(Mes, levels = 1:12, labels = c("jan", "fev", "mar", "abr", "mai", "jun",
                                                     "jul", "ago", "set", "out", "nov", "dez"))) %>% 
   filter(!Ano %in% c(2012, 2013, 2014, 2010, 1995, 1986, 2000, 2009, 2011)) %>% 
   rename(locomocao = `Meio de locomoção da vítima`) %>% 
   dplyr::mutate(ds_nome = stringr::str_to_title(ds_nome)) %>% 
   left_join(pop, by = "ds_nome")

dados_locomocao <- dados_filtrados %>%
   dplyr::filter(locomocao != "NAO DISPONIVEL" & locomocao != "OUTROS") %>%
  dplyr::mutate(locomocao = stringr::str_to_title(locomocao)) %>% 
   dplyr::group_by(Ano, locomocao) %>%
   dplyr::tally()

mortes_regiao <- dados_filtrados %>% 
  filter(!is.na(ds_nome)) %>% 
  group_by(Ano, regiao) %>% 
  tally()

```

## **Resumo**


Esse relatório proprõe uma análise geoespacial detalhada dos dados de mortes no transito no município de São Paulo entre os anos de 2015 e 2024, a partir dos dados disponibilizados pelo INFOSIGA SP - Sistema de Informações Gerenciais de Acidentes de Trânsito do Estado de São Paulo. Pretendemos contribuir com uma análise que identifica um perfil da população vitimada pelos acidentes além de situações e modais de risco para cada distrito da cidade. Pretendemos contribuir com o desenvolvimento de políticas públicas baseadas em evidências das especificidades de cada região da cidade de São Paulo. 

## **Introdução**

Lançado em 2015, o INFOSIGA faz parte de um conjunto de iniciativas do Movimento Paulista de Segurança no Trânsito, lançado pelo Governo do estado de São Paulo em agosto de 2015, que tinha por objetivo reduzir pela metade as vítimas fatais em acidentes de trânsito até 2020. A meta estadual estava na época, inspirada pela resolução de março de 2010 da Assembleia-Geral das Nações Unidas, definida como “Primeira década de ação pela segurança no trânsito". A campanha tinha por objetivo conscientizar os países a adotarem medidas visando a diminuição dos números de mortalidade no trânsito, e de fato mobilizou as autoridades de diversos países, a do Brasil inclusive, que se posicionou como país signatário da iniciativa, com engajamentos diversificados por parte dos gestores de transito. Ao final da primeira década a ONU lançou em 2021 a “segunda década de ação pela segurança no trânsito” incentivando os países a estipularem novas metas para 2030. 

A situação é complicada no mundo todo, segundo dados da OMS de 2022, 1,3 milhão de pessoas morrem anualmente em acidentes de trânsito, o que supera em número de mortos doenças como o HIV/AIDS, tuberculose e doenças diarreicas, sendo esta a 8ª causa do maior número de mortes no mundo (WHO, 2018).

Em termos proporcionais à população, o Brasil tem dados alarmantes, o número de mortos por 100 mil habitantes anualmente é cerca de dez vezes maior que nos países mais seguros (IPEA, 2006, 2015), e na época do lançamento da primeira campanha da ONU eramos o quinto pais com mais mortes no transito no mundo, gerando um custo anual de cerca de de R$ 50 bilhões a preços atuais (IPEA, 2023).   

O INFOSIGA surge como uma ferramenta que possibilita a transparência das informações e o subsídio ao desenvolvimento de políticas públicas de prevenção baseado em evidências. Os dados dispobilizados mensalmente são baseados na sistematização de boletins de ocorrência da Polícia Civil do Estado de São Paulo, para o cálculo das estatísticas relativas a óbitos no transito, além dos dados que serão analisados neste relatório a plataforma INFOSIGA também disponibiliza informações de acidentes de transito com vítimas, utilizando os dados recebidos pela Polícia Militar e Polícia Rodoviária Federal.

No âmbito nacional a Lei Federal nº 13.614/18 assinada em 11 de janeiro de 2018 criou o Plano Nacional de Redução de Mortes e Lesões no Trânsito (Pnatrans), com uma série de diretrizes que visam a diminuição de mortes e lesões causadas por acidentes de trânsito. O principal objetivo é diminuir a proporção de mortos em relação à população e em relação ao número de veículos de uma localidade num prazo de dez anos. 

Tendo em vista a demonstração de preocupação por parte das autoridades federais e estatuais no que diz respeito às mortes no transito, propomos primeiramente uma análise geral da situação dos óbitos nos distritos da cidade de São Paulo, depois uma análise temporal para identificarmos mudanças e tendências gerais e por último uma análise geoespacial detalhada da população, modais de risco para cada uma dessas regiões da cidade de São Paulo, buscando sistematizar informações que podem direcionar a tomada de decisão do poder público.  


## **Estatísticas Gerais**

Mapa das mortes nos municípios do Estado de São Paulo


```{r include=FALSE}

# Substituir nomes específicos
substituicoes <- c(
  "Santa Barbara D Oeste" = "Santa Barbara dOeste",
  "Estrela D Oeste" = "Estrela dOeste",
  "Aparecida D Oeste" = "Aparecida dOeste",
  "Guarani D Oeste" = "Guarani dOeste",
  "Sao Joao Do Pau D Alho" = "Sao Joao do Pau dAlho",
  "Guarani D'oeste" = "Guarani dOeste",
  "Palmeira D'oeste" = "Palmeira dOeste",
  "Santa Rita D Oeste" = "Santa Rita dOeste",
  "Palmeira D Oeste" =	"Palmeira dOeste",		
  "Sao Luis do Paraitinga" =	"Sao Luiz do Paraitinga",
  "Santa Clara D Oeste" = "Santa Clara dOeste"
)

# Download dos Estados e Municípios: 

muni_geobr <- read_municipality(code_muni= 35, year=2020) %>%  as.tibble()

geo_ufs <- read_state(code_state = 35, year = 2020) %>% as.tibble()

pop_estado_1 <- pop_estado %>% 
  mutate(
    Município = str_trim(Mun),  
    Município = stri_trans_general(Município, "Latin-ASCII")) %>%
  filter(UF == "SP") %>% 
  select(CodMun,Município, PopMun)

dados_estados_1 <-  dados_estado %>% 
  mutate(Município = stringr::str_to_title(Município)) %>%
  mutate(Município = str_replace_all(Município, substituicoes)) %>% 
  mutate(Município = str_replace_all(Município, "\\b(Do|De|Dos|Das|Da)\\b", tolower)) %>% 
  mutate(Município = case_when(Município == "Sao Luis do Paraitinga" ~ "Sao Luiz do Paraitinga", TRUE ~ Município)) 
  

dados_mapa <-  pop_estado_1 %>% 
  left_join(dados_estados_1, by = "Município") %>% 
  group_by(CodMun, Município, PopMun) %>% 
  tally() %>% 
  mutate(mortes_cem_mil_hab = n/PopMun*100000) %>% 
  rename(code_muni = CodMun) %>% 
  left_join(muni_geobr, by = "code_muni") 
  

# Convertendo dados_mapa para um objeto sf

  dados_mapa_2 <- st_as_sf(dados_mapa)
  
 

```


```{r echo=FALSE}


# Criar categorias de óbitos por 100 mil habitantes
dados_mapa_2 <- dados_mapa_2 %>%
  mutate(
    group_mortes = cut(mortes_cem_mil_hab, 
                       breaks = c(27, 100, 200, 300, 500, 1020),  # Ajuste conforme a variação dos dados
                       include.lowest = TRUE)
  )

# Criar categorias para o gráfico lateral
pop_mortes <- dados_mapa_2 %>%
  st_drop_geometry() %>%
  group_by(group_mortes) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes)
  ) %>%
  na.omit()

# Criar o mapa interativo
pmap <- ggplot(dados_mapa_2) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geom, 
                          data_id = group_mortes, 
                          tooltip = paste(Município, "<br>Óbitos por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "Óbitos por 100k",
    breaks = c(100, 200, 300, 500, 1020),
    direction = 1,
    palette = "Reds"
  ) +
  theme_void() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = 14, hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(size = 12, hjust = 0.5)
  ) +  guides(fill = "none")

pmap <- pmap + 
  coord_sf(expand = FALSE) + 
  theme_void() + 
  theme(
    plot.margin = unit(c(100, 50, -10, 10), "pt"))

# Criar o gráfico de barras laterais com os percentuais
x_labels <- c("27-100", "101-200", "201-300", "301-500", "501-1018+")

pcol <- ggplot(pop_mortes, aes(group_mortes, share, fill = group_mortes)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
    aes(
      y = pmin(share + 5, max(share) - 2),  
      label = label, 
      color = case_when(
        group_mortes == "501-1018+" ~ "black",
        TRUE ~ "white"
      ), 
      data_id = data_id
    ),
    size = 4, 
    hjust = -0.1
  ) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 10),
    axis.text.x = element_blank()
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 15)

# Ajustar fonte e evitar cortes no mapa
 pmap <- pmap + coord_sf(expand = FALSE) +
  annotate("text", 
           x = mean(st_bbox(dados_mapa_2)[c("xmin", "xmax")]),  
           y = st_bbox(dados_mapa_2)["ymax"] + 0.05 * diff(st_bbox(dados_mapa_2)[c("ymin", "ymax")]),  
            label = "Taxa de mortes por 100k habitantes",
           hjust = 0.5, vjust = 1, size = 5, fontface = "bold", family = "Lora")

# Combinar o mapa e o gráfico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.7, bottom = 0.05, right = 1, top = 0.2)

# Criar um gráfico interativo com ggiraph
interactive_plot <- girafe(
  ggobj = p_final,
  width_svg = 10,  
  height_svg = 8,
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)

# Exibir o gráfico interativo
interactive_plot


```




Mapas das mortes por distritos 

Os mapas apresentados abaixo mostram a distribuição das mortes no trânsito na cidade de São Paulo, destacando tanto os números absolutos quanto a taxa de óbitos por 100 mil habitantes. Tendo como base que segundo o IBGE São Paulo contava em 2022 com 11.451.999 habitantes, e entre 2015 e 2024 a cidade somou um total de **9.216** mortes no trânsito, temos uma taxa geral de **80,5** mortes para cada 100 mil habitantes. Em termos absolutos, os distritos com maior número de óbitos foram Jardim **Jardim Sao Luis (231)**, **Grajaú (229)** e **Cidade Dutra (196)**, enquanto os que registraram menos mortes foram **Marsilac (4)**, **Perdizes (21)** e **Bela Vista (26)**.

Quando analisamos os piores distritos em termos de taxa de mortalidade proporcional à população, os destaques negativos são **Sé (314 mortes por 100 mil habitantes)**, **Jaraguá (287)** e **Butantã (201)**, enquanto os distritos com menor impacto proporcional foram **Perdizes (20)**, **Jardim Helena (27)** e **Cidade Líder (33)**. 

Um adendo a utilização da base de dados do Infogsiga é que para 983 mortes não foi possível encontrar o distrito de acontecimento do acidente, ou por falta de informações de latitude e longitude ou por imprecisão do dado, no entanto somamos esse caso para as estatísticas gerais. 



```{r include=FALSE}

dados_2 <- dados_filtrados %>% 
  filter(!is.na(ds_nome)) %>% 
  clean_names() %>% 
  group_by(ds_nome, pop) %>% 
  tally() %>% 
  mutate(pct = n/sum(n)*100) %>% 
  mutate(mortes_cem_mil_hab = n/pop*100000)

# Transformar em coordenadas geográficas
shp_distritos <- st_transform(shp_distritos, crs = 4326)

shp_distritos <- shp_distritos %>% rename(ds_nome = NOME_DIST)

shp_distritos_1 <- shp_distritos %>% mutate(
    Indice = as.character(row_number()),
    ds_nome = str_trim(ds_nome),  
    ds_nome = stri_trans_general(ds_nome, "Latin-ASCII"), 
    ds_nome = str_to_title(ds_nome)  
  ) %>% 
  mutate(
    ds_nome = case_when(
      ds_nome == "Agua Rasa\n" ~ "Agua Rasa",
      ds_nome == "Alto De Pinheiros\n" ~ "Alto De Pinheiros",
      ds_nome == "Anhanguera\n" ~ "Anhanguera",
      TRUE ~ ds_nome
    )
  )

shp_distritos_2 <- shp_distritos_1 %>%
  left_join(dados_2, by = "ds_nome")


```



```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}

theme_update(plot.title = element_text(size = 24, face = "bold", hjust = 0.5, family = "Lora"))

# Criar categorias de óbitos
shp_distritos_3 <- shp_distritos_2 %>%
  mutate(group_n = cut(n, breaks = c(0, 50, 100, 150, 200, 250), include.lowest = TRUE))

# Criar categorias para o gráfico lateral
pop_n <- shp_distritos_3 %>%
  st_drop_geometry() %>%
  group_by(group_n) %>%
  summarise(score = sum(n, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_n)
  ) %>%
  na.omit()


# Criar o mapa com os distritos de São Paulo e os óbitos
pmap <- ggplot(shp_distritos_3) +
  geom_sf_interactive(aes(fill = n, geometry = geometry, 
                          data_id = group_n, 
                          tooltip = paste(ds_nome, "<br>Óbitos:", n)),  # Nome + Óbitos
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "Óbitos",
    breaks = c(50, 100, 150, 200, 250),
    direction = 1,
    palette = "Reds"
  ) +
  labs(
    title = "",
    subtitle = "",
    caption = ""
  ) +
  theme_map() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = rel(2), hjust = 0.5, family = "Lora"),
    plot.caption = element_text(size = 25, hjust = 0.5, family = "Lora")
  ) + 
  guides(fill = "none")

# Criar o gráfico de barras laterais com os percentuais
x_labels <- c("0-50", "51-100", "101-150", "151-200", "201-250+")

pcol <- ggplot(pop_n, aes(group_n, share, fill = group_n)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
    geom_text_interactive(
    aes(
      y = pmin(share + 5, max(share) - 2),  # Impede que o texto saia do gráfico
      label = label, 
      color = case_when(
        group_n == "201-250+" ~ "black",  # Apenas essa categoria ficará preta
        TRUE ~ "white"
      ), 
      data_id = data_id
    ),
    size = 8, 
    hjust = -0.1 # Mantém os textos afastados para a direita
  ) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 18),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_n$share) + 30)

# Aplicar ao gráfico
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora")) +
  coord_sf(expand = FALSE) +  # Evita cortes no mapa
  theme_void() +
    annotate("text", 
           x = mean(st_bbox(shp_distritos_3)[c("xmin", "xmax")]),  # Centraliza no eixo X
           y = st_bbox(shp_distritos_3)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_3)[c("ymin", "ymax")]),  # Move para cima
           label = "Total absoluto de mortes",
           hjust = 0.5, vjust = 1, size = 12, fontface = "bold", family = "Lora")


# Combinar o mapa e o gráfico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)

# Criar um gráfico interativo com ggiraph
interactive_plot <- girafe(
  ggobj = p_final,
  width_svg = 14,   # Aumenta a largura do gráfico lateral
  height_svg = 12,
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)


```


```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}

theme_update(plot.title = element_text(size = 24, face = "bold", hjust = 0.5, family = "Lora"))

shp_distritos_3 <- shp_distritos_2 %>%
  mutate(group_mortes = cut(mortes_cem_mil_hab, 
                            breaks = quantile(mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE), 
                            include.lowest = TRUE))


# Criar categorias para o gráfico lateral (percentual de distritos por faixa)
pop_mortes <- shp_distritos_3 %>%
  st_drop_geometry() %>%
  group_by(group_mortes) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes)
  ) %>%
  na.omit()

# Criar o mapa com os distritos de São Paulo e a taxa de óbitos
pmap <- ggplot(shp_distritos_3) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geometry, 
                          data_id = group_mortes, 
                          tooltip = paste(ds_nome, "<br>Óbitos por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "Óbitos por 100k",
    breaks = quantile(shp_distritos_3$mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE),
    direction = 1,
    palette = "Reds"
  ) +
  labs(
    title = "",
    subtitle = "",
    caption = ""
  ) +
  theme_map() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = rel(2), hjust = 0.5, family = "Lora"),
    plot.caption = element_text(size = 25, hjust = 0.5, family = "Lora")
  ) + 
  guides(fill = "none")

# Criar o gráfico de barras laterais com os percentuais de distritos por taxa de óbitos
x_labels <- c("Baixo", "Médio-Baixo", "Médio", "Médio-Alto", "Alto")

pcol <- ggplot(pop_mortes, aes(group_mortes, share, fill = group_mortes)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
  aes(
    y = pmin(share + 5, max(share) - 2),  
    label = paste0(round(share, 1), "%"),  
    color = case_when(
      as.character(group_mortes) == max(as.character(group_mortes)) ~ "black",  # Converte para caractere
      TRUE ~ "white"
    ), 
    data_id = data_id
  ),
  size = 8, 
  hjust = -0.1 
) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 30)

# Aplicar ao gráfico a fonte 'Lora' e evitar cortes
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora")
) + coord_sf(expand = FALSE) + theme_void() +
  annotate("text", 
           x = mean(st_bbox(shp_distritos_3)[c("xmin", "xmax")]),  # Centraliza no eixo X
           y = st_bbox(shp_distritos_3)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_3)[c("ymin", "ymax")]),  # Move para cima
           label = "Taxa de mortes por 100k hab.",
           hjust = 0.5, vjust = 1, size = 12, fontface = "bold", family = "Lora")


# Combinar o mapa e o gráfico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)


# Criar um gráfico interativo com ggiraph
interactive_plot_2 <- girafe(
  ggobj = p_final,
  width_svg = 14,   # Aumenta a largura do gráfico lateral
  height_svg = 12,   # Aumenta a altura do gráfico lateral
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)


```


```{r, echo=FALSE, fig.height= 14, fig.width=16, out.width="300%", results="asis"}
library(htmltools)

# Criar layout flexível para exibir os gráficos lado a lado
htmltools::browsable(
  tags$div(
    style = "display: flex; justify-content: space-between; align-items: center; width: 100%;",
    
    # Mapa interativo (primeiro gráfico)
    tags$div(style = "width: 50%;", interactive_plot),  
    
    # Gráfico lateral interativo (segundo gráfico)
    tags$div(style = "width: 50%;", interactive_plot_2)  
  )
)



```

```{r include=FALSE}

# taxa de óbitos por 100k hab. e total de óbitos absolutos

dados_filtrados %>% 
  clean_names() %>% 
  group_by(ds_nome) %>% 
  tally() %>% 
  mutate(ds_nome = str_to_title(ds_nome)) %>% 
  left_join(pop, by = "ds_nome") %>% 
  summarise(
    total_obitos = sum(n, na.rm = TRUE),
    total_populacao = sum(pop, na.rm = TRUE),  
    taxa_obitos = (sum(n, na.rm = TRUE) / sum(pop, na.rm = TRUE)) * 100000
  )


```


## **Quantidade de mortes ao longo do Tempo**

O gráfico abaixo mostra a série história da quantidade absoluta de óbitos no transito de 2015 a 2024. Como podemos ver, os números estavam numa tendência de queda entre **2015 (1131)**, **2016 (976)** e **2017 (886)**, estancionando em 2018 com **895** óbitos e voltando a cair novamente em 2019 com o saldo de **860** óbitos. A queda drástica nas mortes em 2020 e 2021 podem estar associadas a pandemia de Covid-19, o isolamento social e adoção de teletrabalho em muitos setores, mas voltam a subir em 2022, **24%** a mais em relação a 2021, depois **7%** a mais em 2023 e finalmente **10%** a mais em 2024, o maior número desde 2016. Voltamos a patamares muito próximos de 2015, uma diferença de **3%** a menos, apenas. 

O gráfico também mostra os três distritos com mais óbitos em cada ano, dos 14 distritos que aparecem nessa estatística, 8 são da zona sul (Grajau, Jardim Angela, Capao Redondo, Jardim Sao Luis, Cidade Ademar, Campo Limpo, Cidade Dutra, Parelheiros), 3 da zona norte (Jaragua, Pirituba, Jacana) e 3 da zona leste (Sapopemba, Itaquera, Cangaiba). Durante os dez anos da série histórica o distrito do Grajau apareceu em 7 deles no topo do ranking, 2015, 2016, 2017 e 2019, voltando a patamares semelhantes nos últimos 3 anos (2022, 2023 e 2024). Lembrando que o grajau também é o distrito com maior população na cidade de São Paulo (384.873 habitantes segundo censo de 2022). Para efeito de comparação o distrito do Jardim Angela, apesar de população parecida (311.432) só apareceu entre os três distritos com mais óbitos em 2016. 


```{r fig.align = 'center',  fig.height= 4, fig.width=10, out.width = "80%"}

# Obter os 3 distritos com mais mortes por ano
top3_distritos <- dados_filtrados %>% 
   filter(!is.na(ds_nome)) %>% 
   group_by(Ano, ds_nome) %>%  
   tally() %>% 
   arrange(Ano, desc(n)) %>%  
   group_by(Ano) %>% 
   slice(1:3) %>%  
   summarise(Top_Distritos = paste(ds_nome, collapse = ", "), .groups = "drop") 


# base de dados para o gráfico
dados_filtrados_1 <- dados_filtrados %>% 
  group_by(Ano) %>% 
  tally() %>% 
  left_join(top3_distritos, by = "Ano")


# Criar o gráfico interativo com Plotly
grafico_interativo <- ggplot(dados_filtrados_1, aes(x = Ano, y = n, text = paste0(
  "Ano: ", Ano, "<br>",
  "Mortes: ", n, "<br>",
  "Top Distritos: ", Top_Distritos
))) +
  geom_line(color = "#f86254") +
  geom_point(color = "#f86254", size = 4, alpha = 0.7) +
  labs(title = "Evolução das Mortes no Trânsito",
       subtitle = "Número absoluto de óbitos no trânsito de 2015 a 2024",
       x = "",
       y = "") +
  scale_x_continuous(breaks = seq(2015, 2024, 1)) +  # Garante que todos os anos aparecem
  theme_minimal() +
  geom_label(aes(label = n), vjust = -0.5, fill = "white", color = "black", family = "Lora", size = 4)+
  theme(plot.title = element_text(family = "Lora", size = 10, face = "bold", hjust = 0.5, colour = "black"),
        plot.subtitle = element_text(family = "Lora", size = 14, hjust = 0.5, colour = "gray30"),
        text = element_text(family = "Lora"),
        axis.text = element_text(size = 10),
        axis.text.x = element_text(size = 9),
        legend.position = "none")

# Converter para Plotly para adicionar interatividade
grafico_interativo_plotly <- ggplotly(grafico_interativo, tooltip = "text")

# Exibir o gráfico interativo
grafico_interativo_plotly

```

No gráfico abaixo analisamos os últimos dois anos, mês a mês, para entender se existe alguma tendência geral de queda ou aumento nas mortes no transito. Sabemos que em 2024 as mortes aumentaram  **10%** em relação ao ano anterior, mas o que mais chama à atenção neste gráfico são os meses de março, abril, maio, junho e julho de 2024, eles representam juntos **46%** a mais de mortes em relação aos mesmo período do ano anterior. A partir de setembro temos uma pequena tendência de queda no número de óbitos, que são menores em relação ao mesmo período do ano anterior, em outubro, novembro e dezembro tivemos **18%** a menos de óbitos do que no mesmo período do ano anterior. De qualquer modo, ainda não é possível dizer que há uma tendência clara de queda no número de óbitos ao longo do último ano, mesmo comparativamente com 2023.  


```{r fig.align = 'center',  fig.height= 4, fig.width=10, out.width = "80%"}

titulo <- glue("Evolução das Mortes no Trânsito nos Últimos 2 anos, Mês a Mês \n <b style='color:#183047;'>2023</b> e <b style='color:#56B1F7;'>2024</b>")

# base de dados para o gráfico
dados_filtrados_1 <- dados_filtrados %>% 
  group_by(Ano, Mes) %>% 
  tally() %>% 
  left_join(top3_distritos, by = "Ano") %>% 
  filter(Ano == 2023 | Ano == 2024)


# Criar o gráfico interativo com Plotly
grafico_interativo <- ggplot(dados_filtrados_1, aes(x = Mes, y = n, color = Ano, group = Ano, text = paste0(
  "Mes: ", Mes, "<br>",
  "Ano: ", Ano, "<br>",
  "Mortes: ", n, "<br>"
))) +
  geom_line() +
  geom_point(size = 4, alpha = 0.7) +
  MetBrewer::scale_fill_met_d("Redon", direction=1)+
  labs(title = titulo,
       x = "",
       y = "") +
#  scale_x_continuous(breaks = seq(2015, 2024, 1)) +  # Garante que todos os anos aparecem
  theme_minimal() +
  geom_label(aes(label = n), vjust = -0.5, fill = "white", color = "black", family = "Lora", size = 4)+
  theme(plot.title = element_text(family = "Lora", size = 10, face = "bold", hjust = 0.5, colour = "black"),
        plot.subtitle = element_text(family = "Lora", size = 14, hjust = 0.5, colour = "gray30"),
        text = element_text(family = "Lora"),
        axis.text = element_text(size = 10),
        axis.text.x = element_text(size = 9),
        legend.position = "none")

# Converter para Plotly para adicionar interatividade
grafico_interativo_plotly <- ggplotly(grafico_interativo, tooltip = "text")

# Exibir o gráfico interativo
grafico_interativo_plotly

```



O gráfico abaixo também apresenta uma série histórica mas com a evolução das mortes por meio de locomoção da vítima. O que mais chama atenção neste gráfico é que, se até 2019 os pedestres eram as principais vítimas do transito na cidade, esse cenário mudou e os motociclistas assumiram essa posição. Desde 2020 o número de óbitos de motociclistas apenas aumentou, alcançando o patamar mais alto em 2024, com **496 óbitos**, um aumento de **38%** em relação a 2015.  

É alarmante também que as vítimas pedestres, apesar de decaírem em 2020, prrovavelmente devido a pandemia de Covid-19, também só aumentaram desde 2021. Desde então Presenciamos um aumento de **42%** em 2022 em relação a 2021, e esse números continuaram crescendo, em 2023 foram **12%** a mais e em 2024 **7%** a mais que no ano anterior. Os anos com mais mortes de pedestres foram: 2015 com **468** óbitos, 2016 com **406** óbitos e 2024 com **405**. Se comprado a 2015, em 2024 as mortes dimiuíram em **13%**. 

As mortes de ocupantes de automóveis vinha caindo de forma expressiva desde 2015 até voltarem a crescer em 2018 e estacionarem em números homogêneos até um crescimento de **19%** em 2023 e uma queda de **12%** em 2024. Se comprado a 2015, em 2024 as mortes dimiuíram em **40%**. 

As mortes de ciclistas também caíram de forma expressiva entre 2017 e 2018 (**35%**), continuaram subindo até 2021, quando caíram novamente **21%** e voltam a crescer alcançando o maior patamar da série histórica em 2024, um aumento de **64%** em relação a 2015. 

As mortes de ocupantes de caminhão vinham caindo consistentemente desde 2015, quando subiu drasticamente em 2019 (**2** para 14 mortes entre 2018 e 2019), e desde 2022 vem subindo novamente, 2024 alcançou o patamar mais alto desde 2015, com **17** mortes. 

Por fim, o meio de transporte menos letal, o ônibus, desde uma subida nos números em 2017, tem se apresentado relativamente estacionário, se comparado a 2015 em 2024 tivemos uma diminuição nas mortes em **25%**. 


```{r fig.align = 'center',  fig.height= 4, fig.width=10, out.width = "80%"}

titulo <- glue("Evolução das Mortes no Trânsito por Meio de Locomoção da Vítima \n <b style='color:#18C5C9;'>Motocicleta</b>,  <b style='color:#F46FE5;'>Pedestre</b>, <b style='color:#F8837B;'>Automóvel</b>, <b style='color:#BEA818;'>Bicicleta</b>, <b style='color:#599FED;'>Ônibus</b>, <b style='color:#04BB3B;'>Caminhão</b>")

# Criar o gráfico interativo com linhas
grafico_interativo <- ggplot(dados_locomocao, aes(x = Ano, y = n, color = locomocao, 
                                                  group = locomocao,  # 🔹 Garante que cada locomoção tenha sua própria linha
                                                  text = paste0("Ano: ", Ano, "<br>",
                                                                "Mortes: ", n, "<br>",
                                                                "Locomocao: ", locomocao, "<br>"))) +  
  geom_line(size = 0.5, alpha = 0.8) +  # 🔹 Agora com linhas conectadas
  geom_point(size = 3, alpha = 0.9) +  # 🔹 Mantém os pontos para destaque
  labs(title = titulo,
       x = "",
       y = "") +
  scale_x_continuous(breaks = seq(2015, 2024, 1)) + 
  MetBrewer::scale_fill_met_d("Redon", direction=1) +
  theme_minimal() +
  theme(plot.title = element_text(family = "Lora", size = 10, face = "bold", hjust = 0.5, colour = "black"),
        text = element_text(family = "Lora"),
        axis.text = element_text(size = 9),
        axis.text.x = element_text(size = 9),
        legend.position = "none")


# Converter para Plotly para adicionar interatividade
grafico_interativo_plotly <- ggplotly(grafico_interativo, tooltip = "text")

# Exibir o gráfico interativo
grafico_interativo_plotly



```


O gráfico abaixo mostra os mesmo dados do gráfico anterior mas nele podemos enxergar melhor as diferenças proporcionais entre a quantidade de mortes de cada meio de locomoção. A cidade de São Paulo tem sido cada vez mais perigosa para motociclistas e ciclistas, ao passo que mais segura para os ocupantes de automóveis e ônibus. Desde 2021 também têm sido consistentemente mais perigoso ser um pedestre. 


```{r echo=FALSE,  fig.height= 10, fig.width=18, out.width="100%"}

col_vec <- c(
  "Motocicleta" = "#18C5C9",
  "Pedestre" = "#F46FE5",
  "Automóvel" = "#F8837B",
  "Bicicleta" = "#BEA818",
  "Ônibus" = "#599FED",
  "Caminhão" = "#04BB3B"
)



# Criar gráfico
  ggplot(dados_locomocao, 
                               aes(fill = locomocao, values = n)) +  # 🔹 Removi `text =` daqui
  geom_waffle(color = "white", size = 0.01, n_rows = 12, flip = TRUE) +
  facet_wrap(~Ano, nrow = 1, strip.position = "bottom") +
  scale_x_discrete() + 
    scale_fill_manual(
    values = c("#18C5C9", alpha("#F46FE5", 1/3), alpha("#F8837B", 1/2), alpha("#BEA818", 1/3), alpha("#599FED", 1/2), alpha("#04BB3B", 1/3)
  ))+
  coord_equal() +
  labs(title = "Evolução das Mortes no Trânsito por Meio de Locomoção da Vítima") +
  theme_minimal() +
  theme(
      # Texto
    plot.title = element_text(family = "Lora", size = 13, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(family = "Lora", size = 14, hjust = 0.5, colour = "gray30"),
    text = element_text(family = "Lora"),
    axis.text.x = element_text(size = 35), 
    axis.text.y = element_text(size = 12), 
    legend.position = "right", 
    legend.text = element_text(size = 11),
    legend.title = element_blank(), 
    legend.spacing.x = unit(2.5, 'cm'),  # 🔹 Aumenta o espaçamento horizontal dos itens da legenda
    legend.key.width = unit(1.5, "cm"))

showtext_opts(dpi = 320)



```


O gráfico abaixo nos mostra a evolução da quantidade absoluta das mortes no transito em cada macroregião da cidade. A zona leste e a zona sul são as regiões com mais mortes em toda a série histórica. Apesar de números bem próximos, a zona sul têm sido a região mais letal da cidade em quase todos os anos. Chama à atenção também que essa região esteja presenciando a maior súbida initerrupta dos casos desde 2021 logo após uma queda consistente de 2016 a 2021. O volume de óbitos aumentou **35%** em 2022, **15%** em 2023 e **13%** em 2024. Comparativamente com 2015, tivemos um aumento de **12%** nos óbitos da zona sul em 2024. 

Na zona leste, do mesmo modo que na zona sul, os óbitos vinham caindo de forma consistente desde 2015, quando começaram a subir em 2021, para se ter uma ideia os óbitos nessa região subiram **49%** em 2022, o que pode, assim como nas outras regiões, marcar a passagem do período de pandemia para o de abertura do isolamento social na cidade, os anos posteriores tiveram aumentos também mas consideravelmente menores, **3%** em 2023 e **6%** em 2024. Comparativamente com 2015, os óbitos na zona leste diminíram **17%** em 2024. 

A zona norte é terceira região com mais óbitos em termos absolutos. A região também presenciou uma queda nos números entre 2015 e 2017, quando começa a subir até cair novamente durante o periodo da pandemia. Desde 2020 os óbitos tem aumentado de forma consistente, tendo permanecido estável em 2023 até subir **24%** em 2024. Comparativamente com 2015, os óbitos permaneceram estáveis em 2024, tendo caído apenas **0.5%**. 

A zona oeste e o centro têm séries históricas parecidas, acompanharam a tendência geral da cidade de queda nos óbitos entre 2015 e 2017, voltando a subir para novamente cair na época da pandemia. A zona oeste viveu um aumento significativo em 2022 (**70%**), o maior pós pandemia comparativamente com as outras regiões, mas tem caído na quantidade de óbitos mesmo que de forma sutíl, 2023 teve **4%** a menos e 2024  também **4%*** a menos que o ano anterior. Comparativamente com 2015, os óbitos na zona oeste
diminuíram em **37%**, no centro essa diminuição foi de **60%**. 



```{r fig.align = 'center',  fig.height= 4, fig.width=10, out.width = "80%"}

titulo <- glue("Evolução das Mortes no Trânsito por Região de São Paulo \n <b style='color:#E271F2;'>Sul</b>,  <b style='color:#AAAE27;'>Leste</b>, <b style='color:#40C48A;'>Norte</b>, <b style='color:#49B6F5;'>Oeste</b>, <b style='color:#F1877E;'>Centro</b>")

# Criar o gráfico interativo com linhas
grafico_interativo <- ggplot(mortes_regiao, aes(x = Ano, y = n, color = regiao, 
                                                  group = regiao,  # 🔹 Garante que cada locomoção tenha sua própria linha
                                                  text = paste0("Ano: ", Ano, "<br>",
                                                                "Mortes: ", n, "<br>",
                                                                "regiao: ", regiao, "<br>"))) +  
  geom_line(size = 0.5, alpha = 0.8) +  # 🔹 Agora com linhas conectadas
  geom_point(size = 3, alpha = 0.9) +  # 🔹 Mantém os pontos para destaque
  labs(title = titulo,
       x = "",
       y = "") +
  scale_x_continuous(breaks = seq(2015, 2024, 1)) + 
  MetBrewer::scale_fill_met_d("Redon", direction=1) +
  theme_minimal() +
  theme(plot.title = element_text(family = "Lora", size = 10, face = "bold", hjust = 0.5, colour = "black"),
        text = element_text(family = "Lora"),
        axis.text = element_text(size = 9),
        axis.text.x = element_text(size = 9),
        legend.position = "none")


# Converter para Plotly para adicionar interatividade
grafico_interativo_plotly <- ggplotly(grafico_interativo, tooltip = "text")

# Exibir o gráfico interativo
grafico_interativo_plotly



```


## **Análise por Distrito**

O objetivo desta análise é entender quais são os distritos mais perigosos para pedestres, motociclistas, usuários de automóveis e ciclistas. Para isso estamos comparando os distritos a partir de sua taxa de óbitos, em cada um desses meios de locomoção, por 100 mil habitantes. 

No primeiro mapa é possível verificar que os distritos mais periogosos para pedestres (com taxa de mortes entre 41.5 e 227 por 100 mil hab.), classificados no mapa abaixo como 'Alto' risco,  por ordem de taxa de óbitos são: **Sé,	Bom Retiro, Jaguará, Jacanã, República, Brás, Butantã, Pari, Consolação e Santo Amaro**. A Sé se destaca em relação aos outros distritos com uma taxa de 226, para se ter uma ideia o Bom Retiro mesmo ocupando o segundo lugar do ranking tem uma taxa de 110 mortes. De forma geral 


```{r eval=FALSE, include=FALSE}

shp_distritos_pedestres %>%  as.data.frame() %>% 
  filter(group_mortes_pedestres == ("(41.5,227]")) %>% 
  arrange(-mortes_cem_mil_hab) %>% 
  distinct(ds_nome)

```



```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}

dados_pedestres <- dados_filtrados %>% 
  filter(!is.na(ds_nome)) %>% 
  clean_names() %>% 
  group_by(ds_nome, pop, locomocao) %>% 
  tally() %>% 
  filter(locomocao == "PEDESTRE") %>% 
  mutate(mortes_cem_mil_hab = n/pop*100000)


shp_distritos_2 <- shp_distritos_1 %>%
  left_join(dados_pedestres, by = "ds_nome")

shp_distritos_pedestres <- shp_distritos_2 %>%
  mutate(group_mortes_pedestres = cut(mortes_cem_mil_hab, 
                            breaks = quantile(mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE), 
                            include.lowest = TRUE))

# Criar categorias para o gráfico lateral (percentual de distritos por faixa)
pop_mortes <- shp_distritos_pedestres %>%
  st_drop_geometry() %>%
  group_by(group_mortes_pedestres) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes_pedestres)
  ) %>%
  na.omit()

# Criar o mapa com os distritos de São Paulo e a taxa de óbitos
pmap <- ggplot(shp_distritos_pedestres) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geometry, 
                          data_id = group_mortes_pedestres, 
                          tooltip = paste(ds_nome, "<br>Óbitos de pedestres por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "Óbitos por 100k",
    breaks = quantile(shp_distritos_pedestres$mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE),
    direction = 1,
    palette = "Reds"
  ) +
  labs(
    title = "",
    subtitle = "",
    caption = ""
  ) +
  theme_map() +
  guides(fill = "none")

# Criar o gráfico de barras laterais com os percentuais de distritos por taxa de óbitos
x_labels <- c("Baixo", "Médio-Baixo", "Médio", "Médio-Alto", "Alto")


pcol <- ggplot(pop_mortes, aes(group_mortes_pedestres, share, fill = group_mortes_pedestres)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
  aes(
    y = pmin(share + 5, max(share) - 2),  
    label = paste0(round(share, 1), "%"),  
    color = case_when(
      as.character(group_mortes_pedestres) == max(as.character(group_mortes_pedestres)) ~ "black",  # Converte para caractere
      TRUE ~ "white"
    ), 
    data_id = data_id
  ),
  size = 8, 
  hjust = -0.1 
) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 40)


# Aplicar ao gráfico a fonte 'Lora' e evitar cortes
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora")
) + coord_sf(expand = FALSE) + theme_void() +
  annotate("text", 
           x = mean(st_bbox(shp_distritos_pedestres)[c("xmin", "xmax")]),  # Centraliza no eixo X
           y = st_bbox(shp_distritos_pedestres)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_pedestres)[c("ymin", "ymax")]),  # Move para cima
           label = "Mortes de Pedestres p/ 100k hab.",
           hjust = 0.5, vjust = 1, size = 10, fontface = "bold", family = "Lora")

# Combinar o mapa e o gráfico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)


# Criar um gráfico interativo com ggiraph
interactive_plot_pedestres <- girafe(
  ggobj = p_final,
  width_svg = 14,   # Aumenta a largura do gráfico lateral
  height_svg = 12,   # Aumenta a altura do gráfico lateral
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)



interactive_plot_pedestres

```


```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}

dados_motos <- dados_filtrados %>% 
  filter(!is.na(ds_nome)) %>% 
  clean_names() %>% 
  group_by(ds_nome, pop, locomocao) %>% 
  tally() %>% 
  filter(locomocao == "MOTOCICLETA") %>% 
  mutate(mortes_cem_mil_hab = n/pop*100000)


shp_distritos_2 <- shp_distritos_1 %>%
  left_join(dados_motos, by = "ds_nome")

shp_distritos_motos <- shp_distritos_2 %>%
  mutate(group_mortes_motos = cut(mortes_cem_mil_hab, 
                            breaks = quantile(mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE), 
                            include.lowest = TRUE))

# Criar categorias para o gráfico lateral (percentual de distritos por faixa)
pop_mortes <- shp_distritos_motos %>%
  st_drop_geometry() %>%
  group_by(group_mortes_motos) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes_motos)
  ) %>%
  na.omit()


# Criar o mapa com os distritos de São Paulo e a taxa de óbitos
pmap <- ggplot(shp_distritos_motos) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geometry, 
                          data_id = group_mortes_motos, 
                          tooltip = paste(ds_nome, "<br>Óbitos de motociclistas por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "Óbitos por 100k",
    breaks = quantile(shp_distritos_motos$mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE),
    direction = 1,
    palette = "Reds"
  ) +
  theme_map() +
  guides(fill = "none")

pcol <- ggplot(pop_mortes, aes(group_mortes_motos, share, fill = group_mortes_motos)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
  aes(
    y = pmin(share + 5, max(share) - 2),  
    label = paste0(round(share, 1), "%"),  
    color = case_when(
      as.character(group_mortes_motos) == max(as.character(group_mortes_motos)) ~ "black",  # Converte para caractere
      TRUE ~ "white"
    ), 
    data_id = data_id
  ),
  size = 8, 
  hjust = -0.1 
) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 40)

# Aplicar ao gráfico a fonte 'Lora' e evitar cortes
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora") +
  guides(fill = "none")) + coord_sf(expand = FALSE) + theme_void() +
  annotate("text", 
           x = mean(st_bbox(shp_distritos_motos)[c("xmin", "xmax")]),  
           y = st_bbox(shp_distritos_motos)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_motos)[c("ymin", "ymax")]),  
           label = "Mortes de Motociclistas p/ 100k hab.",
           hjust = 0.5, vjust = 1, size = 10, fontface = "bold", family = "Lora")

# Combinar o mapa e o gráfico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)

interactive_plot_2_moto <- girafe(
  ggobj = p_final,
  width_svg = 14,  
  height_svg = 12,   
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)





```


```{r, echo=FALSE, fig.height= 14, fig.width=16, out.width="200%", results="asis"}
library(htmltools)

# Criar layout flexível para exibir os gráficos lado a lado
htmltools::browsable(
  tags$div(
    style = "display: flex; justify-content: space-between; align-items: center; width: 100%;",
    
    # Mapa interativo (primeiro gráfico)
    tags$div(style = "width: 50%;", interactive_plot_pedestres),  
    
    # Gráfico lateral interativo (segundo gráfico)
    tags$div(style = "width: 50%;", interactive_plot_2_moto)  
  )
)



```


```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}


dados_automovel <- dados_filtrados %>% 
  filter(!is.na(ds_nome)) %>% 
  clean_names() %>% 
  group_by(ds_nome, pop, locomocao) %>% 
  tally() %>% 
  filter(locomocao == "AUTOMOVEL") %>% 
  mutate(mortes_cem_mil_hab = n/pop*100000) %>% 
    bind_rows(
    data.frame(ds_nome = "Marsilac", mortes_cem_mil_hab = 0),
    data.frame(ds_nome = "Perdizes", mortes_cem_mil_hab = 0),
    data.frame(ds_nome = "Bela Vista", mortes_cem_mil_hab = 0)
  )

shp_distritos_2 <- shp_distritos_1 %>%
  left_join(dados_automovel, by = "ds_nome")

shp_distritos_automovel <- shp_distritos_2 %>%
  mutate(group_mortes_automovel = cut(mortes_cem_mil_hab, 
                            breaks = quantile(mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE), 
                            include.lowest = TRUE))

# Criar categorias para o gráfico lateral (percentual de distritos por faixa)
pop_mortes <- shp_distritos_automovel %>%
  st_drop_geometry() %>%
  group_by(group_mortes_automovel) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes_automovel)
  ) %>%
  na.omit()


# Criar o mapa com os distritos de São Paulo e a taxa de óbitos
pmap <- ggplot(shp_distritos_automovel) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geometry, 
                          data_id = group_mortes_automovel, 
                          tooltip = paste(ds_nome, "<br>Óbitos de condutores de automóvel por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
scale_fill_fermenter(
    name = "Óbitos por 100k",
    breaks = quantile(shp_distritos_automovel$mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE),
    direction = 1,
    palette = "Reds"
  ) +
  theme_map() +
  guides(fill = "none")

pcol <- ggplot(pop_mortes, aes(group_mortes_automovel, share, fill = group_mortes_automovel)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
  aes(
    y = pmin(share + 5, max(share) - 2),  
    label = paste0(round(share, 1), "%"),  
    color = case_when(
      as.character(group_mortes_automovel) == max(as.character(group_mortes_automovel)) ~ "black",  # Converte para caractere
      TRUE ~ "white"
    ), 
    data_id = data_id
  ),
  size = 8, 
  hjust = -0.1 
) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 40)

# Aplicar ao gráfico a fonte 'Lora' e evitar cortes
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora") +
  guides(fill = "none")) + coord_sf(expand = FALSE) + theme_void() +
  annotate("text", 
           x = mean(st_bbox(shp_distritos_automovel)[c("xmin", "xmax")]),  
           y = st_bbox(shp_distritos_automovel)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_automovel)[c("ymin", "ymax")]),  
           label = "Mortes de condutores de automóveis \n p/ 100k hab.",
           hjust = 0.5, vjust = 1, size = 10, fontface = "bold", family = "Lora")

# Combinar o mapa e o gráfico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)

interactive_plot_2_auto <- girafe(
  ggobj = p_final,
  width_svg = 14,  
  height_svg = 12,   
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)




```


```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}


dados_ciclistas <- dados_filtrados %>% 
  filter(!is.na(ds_nome)) %>% 
  clean_names() %>% 
  group_by(ds_nome, pop, locomocao) %>% 
  tally() %>% 
  filter(locomocao == "BICICLETA") %>% 
  mutate(mortes_cem_mil_hab = n/pop*100000) %>% 
  bind_rows(
    data.frame(ds_nome = "Marsilac", mortes_cem_mil_hab = 0),
    data.frame(ds_nome = "Morumbi", mortes_cem_mil_hab = 0), 
    data.frame(ds_nome = "Rio Pequeno", mortes_cem_mil_hab = 0),
    data.frame(ds_nome = "Sao Domingos", mortes_cem_mil_hab = 0), 
    data.frame(ds_nome = "Liberdade", mortes_cem_mil_hab = 0), 
    data.frame(ds_nome = "Cidade Lider", mortes_cem_mil_hab = 0)
  )

shp_distritos_2 <- shp_distritos_1 %>%
  left_join(dados_ciclistas, by = "ds_nome")


shp_distritos_ciclistas <- shp_distritos_2 %>%
  mutate(group_mortes_ciclistas = cut(mortes_cem_mil_hab, 
                            breaks = quantile(mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE), 
                            include.lowest = TRUE))

# Criar categorias para o gráfico lateral (percentual de distritos por faixa)
pop_mortes <- shp_distritos_ciclistas %>%
  st_drop_geometry() %>%
  group_by(group_mortes_ciclistas) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes_ciclistas)
  ) %>%
  na.omit()

# Criar o mapa com os distritos de São Paulo e a taxa de óbitos
pmap <- ggplot(shp_distritos_ciclistas) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geometry, 
                          data_id = group_mortes_ciclistas, 
                          tooltip = paste(ds_nome, "<br>Óbitos de ciclistas por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
scale_fill_fermenter(
    name = "Óbitos por 100k",
    breaks = quantile(shp_distritos_ciclistas$mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE),
    direction = 1,
    palette = "Reds"
  ) +
  theme_map() +
  guides(fill = "none")


pcol <- ggplot(pop_mortes, aes(group_mortes_ciclistas, share, fill = group_mortes_ciclistas)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
  aes(
    y = pmin(share + 5, max(share) - 2),  
    label = paste0(round(share, 1), "%"),  
    color = case_when(
      as.character(group_mortes_ciclistas) == max(as.character(group_mortes_ciclistas)) ~ "black",  # Converte para caractere
      TRUE ~ "white"
    ), 
    data_id = data_id
  ),
  size = 8, 
  hjust = -0.1 
) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 40)


# Aplicar ao gráfico a fonte 'Lora' e evitar cortes
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
) + coord_sf(expand = FALSE) + theme_void() +
  guides(fill = "none") +
  annotate("text", 
           x = mean(st_bbox(shp_distritos_ciclistas)[c("xmin", "xmax")]),  # Centraliza no eixo X
           y = st_bbox(shp_distritos_ciclistas)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_ciclistas)[c("ymin", "ymax")]),  # Move para cima
           label = "Mortes de Ciclistas p/ 100k hab.",
           hjust = 0.5, vjust = 1, size = 10, fontface = "bold", family = "Lora")


# Combinar o mapa e o gráfico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)

interactive_plot_2_ciclistas <- girafe(
  ggobj = p_final,
  width_svg = 14,   # Aumenta a largura do gráfico lateral
  height_svg = 12,   # Aumenta a altura do gráfico lateral
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)




```



```{r, echo=FALSE, fig.height= 14, fig.width=16, out.width="150%", results="asis"}
library(htmltools)

# Criar layout flexível para exibir os gráficos lado a lado
htmltools::browsable(
  tags$div(
    style = "display: flex; justify-content: space-between; align-items: center; width: 100%;",
    
    # Mapa interativo (primeiro gráfico)
    tags$div(style = "width: 50%;", interactive_plot_2_auto),  
    
    # Gráfico lateral interativo (segundo gráfico)
    tags$div(style = "width: 50%;", interactive_plot_2_ciclistas)  
  )
)



```


## **Considerações Finais**


## **Referências**



&nbsp;
<hr />
<p style="text-align: center;">
  <strong>Equipe Técnica:</strong> <br />
  Hugo Nicolau Barbosa de Gusmão <br />
  Joaquim Lemos Ornellas <br />
  Luiza Mayare Reis Soares <br />
  Robson Cesar Zanovelo <br />
  Thais Fernandes Pereira
</p>

<p style="text-align: center;">
  <span style="color: #2F58A4;">
    <em>Relatório Executivo <br /> ADE SAMPA - 2025</em>
  </span>
</p>

&nbsp;









