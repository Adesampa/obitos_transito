---
title: Análise das Mortes no Trânsito no Município de São Paulo
author: "Agência São Paulo de Desenvolvimento - ADE SAMPA"
date: "`r format(Sys.Date(), format='%d/%m/%Y')`"
output:
    html_document: 
      theme: flatly
      self-contained: true
      toc: true
      toc_float: true
      css: style.css
editor_options: 
  markdown: 
    wrap: 72
  chunk_output_type: inline
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(global.par = TRUE)
knitr::opts_knit$set(globalenv = TRUE)

(knitr::opts_chunk$set(
	echo = FALSE,
	error = FALSE,
	message = FALSE,
	warning = FALSE
 )
)


```


```{r}

library("ggpubr")
library("tidyverse")
library("kableExtra")
library("knitr")
library("tidylog")
library("readxl")
library("geobr")
library("sf")
library("wesanderson")
library("ggplot2")
library("stringr")
library ("abjData")
library("extrafont")
library("lubridate")
library("transformr")
library("reactable")
library("rnaturalearth")
library("plotly")
library("ggrepel")
library('googlesheets4')
library("leaflet")
library('ggthemes')
library('rmdformats')
library("janitor")
library("reactablefmtr")
library("corrplot")
library("lubridate")
library("janitor")
library("ggmap")
library("stringr")
library("stringi")
library("ggthemes")
library("ggiraph")
library("patchwork")
library("showtext")
library("htmltools")
library("gganimate")
library("gifski")
library("av")
library("scales")
library("png")
library("magick")
library("ggtext")
library("waffle")
library("MetBrewer")
library("dplyr")
library("glue")
library("marquee")
library("geobr")

```



```{r include=FALSE}

# dowwnload dos dados do infosiga (https://www.infosiga.sp.gov.br/)


dados <- read_csv("C:/Users/Thais Pereira/Documents/obitos_transito/obitos.csv", locale = locale(encoding = "UTF-8"))

dados_estado <- read_excel("C:/Users/Thais Pereira/Documents/obitos_transito/obitos_todos.xlsx")

dados_logadouro <- read_csv("C:/Users/Thais Pereira/Documents/obitos_transito/obitos_logadouro.csv", locale = locale(encoding = "UTF-8"))

shp_distritos <- st_read("C:/Users/Thais Pereira/Documents/shapefile/distritos_cnpj_2.shp")

pop <- read_excel("C:/Users/Thais Pereira/Documents/obitos_transito/pop.xlsx")

pop_estado <- read_excel("C:/Users/Thais Pereira/Documents/obitos_transito/pop_estado.xlsx")

pop_estado_2 <- read_excel("C:/Users/Thais Pereira/Documents/obitos_transito/pop_estado.xlsx", sheet = 2)

```


```{r  include=FALSE}

# Adicionar a fonte do Google Fonts
font_add_google("Lora", "Lora")

# Ativar suporte a fontes no ggplot
showtext_auto()

dados_filtrados <- dados %>%
   mutate(`Data do Sinistro` = dmy(`Data do Sinistro`),  
   Ano = year(`Data do Sinistro`), 
   Mes = month(`Data do Sinistro`)) %>% 
   mutate(Mes = factor(Mes, levels = 1:12, labels = c("jan", "fev", "mar", "abr", "mai", "jun",
                                                     "jul", "ago", "set", "out", "nov", "dez"))) %>% 
   filter(!Ano %in% c(2012, 2013, 2014, 2010, 1995, 1986, 2000, 2009, 2011)) %>% 
   rename(locomocao = `Meio de locomoção da vítima`) %>% 
   dplyr::mutate(ds_nome = stringr::str_to_title(ds_nome)) %>% 
   left_join(pop, by = "ds_nome")

dados_locomocao <- dados_filtrados %>%
   dplyr::filter(locomocao != "NAO DISPONIVEL" & locomocao != "OUTROS") %>%
   dplyr::mutate(locomocao = stringr::str_to_title(locomocao)) %>% 
   dplyr::group_by(Ano, locomocao) %>%
   dplyr::tally()

mortes_regiao <- dados_filtrados %>% 
  filter(!is.na(ds_nome)) %>% 
  group_by(Ano, regiao) %>% 
  tally()

```

## **Resumo**


Esse relatório proprõe uma análise geoespacial detalhada dos dados de mortes no trânsito no município de São Paulo entre os anos de 2015 e 2024, a partir dos dados disponibilizados pelo INFOSIGA SP - Sistema de Informações Gerenciais de Acidentes de Trânsito do Estado de São Paulo. Desenvolvemos uma análise que identifica aspectos gerais das mortes no trânsito, tendências dos últimos dez anos com recorte por modal e por região da cidade, além de  modais de risco para cada distrito e as avenidas com mais mortes. Esperamos contribuir com o desenvolvimento de políticas públicas baseadas em dados das especificidades de cada região da cidade de São Paulo. 

## **Introdução**

Lançado em 2015, o INFOSIGA faz parte de um conjunto de iniciativas do Movimento Paulista de Segurança no Trânsito, lançado pelo Governo do Estado de São Paulo em agosto de 2015, que tinha por objetivo reduzir pela metade as vítimas fatais em acidentes de trânsito até 2020. A meta estadual estava na época, inspirada pela resolução de março de 2010 da Assembleia-Geral das Nações Unidas, definida como “Primeira década de ação pela segurança no trânsito". A campanha tinha por objetivo conscientizar os países a adotarem medidas visando a diminuição dos números de mortalidade no trânsito, e de fato mobilizou as autoridades de diversos países, a do Brasil inclusive, que se posicionou como país signatário da iniciativa, com engajamentos diversificados por parte dos gestores de trânsito. Ao final da primeira década a ONU lançou em 2021 a “segunda década de ação pela segurança no trânsito” incentivando os países a estipularem novas metas para 2030. 

A situação é complicada no mundo todo, segundo dados da OMS de 2022, 1,3 milhão de pessoas morrem anualmente em acidentes de trânsito, o que supera em número de mortos doenças como o HIV/AIDS, tuberculose e doenças diarreicas, sendo esta a 8ª causa do maior número de mortes no mundo (WHO, 2018).

Em termos proporcionais à população o Brasil tem dados alarmantes, o número de mortos por 100 mil habitantes anualmente é cerca de dez vezes maior que nos países mais seguros (IPEA, 2006, 2015), e na época do lançamento da primeira campanha da ONU eramos o quinto pais com mais mortes no trânsito no mundo, gerando um custo anual de cerca de de R$ 50 bilhões a preços atuais (IPEA, 2023).   

O INFOSIGA surge como uma ferramenta que possibilita a transparência das informações e o subsídio ao desenvolvimento de políticas públicas de prevenção baseado em evidências. Os dados disponibilizados mensalmente são baseados na sistematização de boletins de ocorrência da Polícia Civil do Estado de São Paulo, para o cálculo das estatísticas relativas a óbitos no trânsito, além dos dados que serão analisados neste relatório a plataforma INFOSIGA também disponibiliza informações de acidentes de trânsito com vítimas, utilizando os dados recebidos pela Polícia Militar e Polícia Rodoviária Federal.

No âmbito nacional a Lei Federal nº 13.614/18 assinada em 11 de janeiro de 2018 criou o Plano Nacional de Redução de Mortes e Lesões no Trânsito (Pnatrans), com uma série de diretrizes que visam a diminuição de mortes e lesões causadas por acidentes de trânsito. O principal objetivo é diminuir a proporção de mortos em relação à população e em relação ao número de veículos de uma localidade num prazo de dez anos. 

Tendo em vista a demonstração de preocupação por parte das autoridades federais e estatuais no que diz respeito às mortes no trânsito, propomos primeiramente uma análise geral da situação dos óbitos nos distritos da cidade de São Paulo, depois uma análise temporal para identificarmos mudanças e tendências gerais e por último uma análise geoespacial detalhada da população, modais de risco para cada uma dessas regiões da cidade de São Paulo, buscando sistematizar informações que podem direcionar a tomada de decisão do poder público.  


## **Estatísticas Gerais**

Mapa das mortes nos municípios do Estado de São Paulo

O Estado de São Paulo tem 645 municípios e para o mapa abaixo fizemos a taxa de mortes no trânsito por 100 mil habitantes para cada uma das cidades, usando a série histórica disponibilizada pelo Infosiga, de 2015 a 2024. Como podemos ver no gráfico ao lado do mapa, **8%** das cidades tem uma taxa de mortes muito alta sendo Barra do Turvo, localizado na região sul, a cidade com a maior taxa do Estado. São Paulo no entanto, comparativamente aos outros municípios está muito bem posicionado, em termos proporcionais ao tamanho da população. Se fizermos um ranking das cidades por taxa de mortes no trânsito São Paulo estaria na posição 600, com uma taxa de **80** mortes por 100 mil hab. Apenas **3.8%** dos municípios paulistanos tem uma taxa de morte entre **27** e **100** mortes, a cidade com a menor taxa é Rio Grande Da Serra, localizada na região metropolitana de São Paulo.    


```{r include=FALSE}

# Substituir nomes específicos
substituicoes <- c(
  "Santa Barbara D Oeste" = "Santa Barbara dOeste",
  "Estrela D Oeste" = "Estrela dOeste",
  "Aparecida D Oeste" = "Aparecida dOeste",
  "Guarani D Oeste" = "Guarani dOeste",
  "Sao Joao Do Pau D Alho" = "Sao Joao do Pau dAlho",
  "Guarani D'oeste" = "Guarani dOeste",
  "Palmeira D'oeste" = "Palmeira dOeste",
  "Santa Rita D Oeste" = "Santa Rita dOeste",
  "Palmeira D Oeste" =	"Palmeira dOeste",		
  "Sao Luis do Paraitinga" =	"Sao Luiz do Paraitinga",
  "Santa Clara D Oeste" = "Santa Clara dOeste"
)

# Download dos Estados e Municípios: 

muni_geobr <- read_municipality(code_muni= 35, year=2020) %>%  as.tibble()

geo_ufs <- read_state(code_state = 35, year = 2020) %>% as.tibble()

pop_estado_1 <- pop_estado %>% 
  mutate(Município = str_trim(Mun), 
         Município = stri_trans_general(Município, "Latin-ASCII")) %>%
  filter(UF == "SP") %>% 
  select(CodMun,Município, PopMun)

dados_estados_1 <-  dados_estado %>% 
  mutate(`Data do Sinistro` = dmy(`Data do Sinistro`), 
  Ano = year(`Data do Sinistro`)) %>% 
  filter(!Ano %in% c(2012, 2013, 2014, 2010, 1995, 1986, 2000, 2009, 2011)) %>% 
  mutate(Município = stringr::str_to_title(Município)) %>%
  mutate(Município = str_replace_all(Município, substituicoes)) %>% 
  mutate(Município = str_replace_all(Município, "\\b(Do|De|Dos|Das|Da)\\b", tolower)) %>% 
  mutate(Município = case_when(Município == "Sao Luis do Paraitinga" ~ "Sao Luiz do Paraitinga", TRUE ~ Município)) 
  

dados_mapa <-  pop_estado_1 %>% 
  left_join(dados_estados_1, by = "Município") %>% 
  group_by(CodMun, Município, PopMun) %>% 
  tally() %>% 
  mutate(mortes_cem_mil_hab = n/PopMun*100000) %>% 
  rename(code_muni = CodMun) %>% 
  left_join(muni_geobr, by = "code_muni") 
  

# Convertendo dados_mapa para um objeto sf

  dados_mapa_2 <- st_as_sf(dados_mapa)
  

```


```{r echo=FALSE}


# Criar categorias de óbitos por 100 mil habitantes
dados_mapa_2 <- dados_mapa_2 %>%
  mutate(
    group_mortes = cut(mortes_cem_mil_hab, 
                       breaks = c(27, 100, 200, 300, 500, 1020),  # Ajuste conforme a variação dos dados
                       include.lowest = TRUE)
  )

# Criar categorias para o gráfico lateral
pop_mortes <- dados_mapa_2 %>%
  st_drop_geometry() %>%
  group_by(group_mortes) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes)
  ) %>%
  na.omit()

# Criar o mapa interativo
pmap <- ggplot(dados_mapa_2) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geom, 
                          data_id = group_mortes, 
                          tooltip = paste(Município, "<br>Óbitos por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "Óbitos por 100k",
    breaks = c(100, 200, 300, 500, 1020),
    direction = 1,
    palette = "Reds"
  ) +
  theme_void() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = 14, hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(size = 12, hjust = 0.5)
  ) +  guides(fill = "none")

pmap <- pmap + 
  coord_sf(expand = FALSE) + 
  theme_void() + 
  theme(
    plot.margin = unit(c(100, 50, -10, 10), "pt"))

# Criar o gráfico de barras laterais com os percentuais
x_labels <- c("27-100", "101-200", "201-300", "301-500", "501-1018+")

pcol <- ggplot(pop_mortes, aes(group_mortes, share, fill = group_mortes)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
    aes(
      y = pmin(share + 5, max(share) - 2),  
      label = label, 
      color = case_when(
        group_mortes == "501-1018+" ~ "black",
        TRUE ~ "white"
      ), 
      data_id = data_id
    ),
    size = 4, 
    hjust = -0.1
  ) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 10),
    axis.text.x = element_blank()
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 15)

# Ajustar fonte e evitar cortes no mapa
 pmap <- pmap + coord_sf(expand = FALSE) +
  annotate("text", 
           x = mean(st_bbox(dados_mapa_2)[c("xmin", "xmax")]),  
           y = st_bbox(dados_mapa_2)["ymax"] + 0.05 * diff(st_bbox(dados_mapa_2)[c("ymin", "ymax")]),  
            label = "Taxa de mortes por 100k habitantes",
           hjust = 0.5, vjust = 1, size = 5, fontface = "bold", family = "Lora")

# Combinar o mapa e o gráfico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.7, bottom = 0.05, right = 1, top = 0.2)

# Criar um gráfico interativo com ggiraph
interactive_plot <- girafe(
  ggobj = p_final,
  width_svg = 10,  
  height_svg = 8,
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)

# Exibir o gráfico interativo
interactive_plot


```

Mapas das mortes por distritos 

Os mapas apresentados abaixo mostram a distribuição das mortes no trânsito na cidade de São Paulo, destacando tanto os números absolutos quanto a taxa de óbitos por 100 mil habitantes. Tendo como base que segundo o IBGE São Paulo contava em 2022 com 11.451.999 habitantes, e entre 2015 e 2024 a cidade somou um total de **9.216** mortes no trânsito, temos uma taxa geral de **80,7** mortes para cada 100 mil habitantes. Em termos absolutos, os distritos com maior número de óbitos foram Jardim **Jardim Sao Luis (231)**, **Grajaú (229)** e **Cidade Dutra (196)**, enquanto os que registraram menos mortes foram **Marsilac (4)**, **Perdizes (21)** e **Bela Vista (26)**.

Quando analisamos os piores distritos em termos de taxa de mortalidade proporcional à população, os destaques negativos são **Sé (314 mortes por 100 mil habitantes)**, **Jaguará (287)** e **Butantã (201)**, enquanto os distritos com menor impacto proporcional foram **Perdizes (20)**, **Jardim Helena (27)** e **Cidade Líder (33)**. 

Um adendo a utilização da base de dados do Infogsiga é que para 983 mortes não foi possível encontrar o distrito de acontecimento do acidente, ou por falta de informações de latitude e longitude ou por imprecisão do dado, no entanto somamos esses casos para as estatísticas gerais. 


```{r include=FALSE}

dados_2 <- dados_filtrados %>% 
  filter(!is.na(ds_nome)) %>% 
  clean_names() %>% 
  group_by(ds_nome, pop) %>% 
  tally() %>% 
  mutate(pct = n/sum(n)*100) %>% 
  mutate(mortes_cem_mil_hab = n/pop*100000)

# Transformar em coordenadas geográficas
shp_distritos <- st_transform(shp_distritos, crs = 4326)

shp_distritos <- shp_distritos %>% rename(ds_nome = NOME_DIST)

shp_distritos_1 <- shp_distritos %>% mutate(
    Indice = as.character(row_number()),
    ds_nome = str_trim(ds_nome),  
    ds_nome = stri_trans_general(ds_nome, "Latin-ASCII"), 
    ds_nome = str_to_title(ds_nome)  
  ) %>% 
  mutate(
    ds_nome = case_when(
      ds_nome == "Agua Rasa\n" ~ "Agua Rasa",
      ds_nome == "Alto De Pinheiros\n" ~ "Alto De Pinheiros",
      ds_nome == "Anhanguera\n" ~ "Anhanguera",
      TRUE ~ ds_nome
    )
  )

shp_distritos_2 <- shp_distritos_1 %>%
  left_join(dados_2, by = "ds_nome")


```



```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}

theme_update(plot.title = element_text(size = 24, face = "bold", hjust = 0.5, family = "Lora"))

# Criar categorias de óbitos
shp_distritos_3 <- shp_distritos_2 %>%
  mutate(group_n = cut(n, breaks = c(0, 50, 100, 150, 200, 250), include.lowest = TRUE))

# Criar categorias para o gráfico lateral
pop_n <- shp_distritos_3 %>%
  st_drop_geometry() %>%
  group_by(group_n) %>%
  summarise(score = sum(n, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_n)
  ) %>%
  na.omit()


# Criar o mapa com os distritos de São Paulo e os óbitos
pmap <- ggplot(shp_distritos_3) +
  geom_sf_interactive(aes(fill = n, geometry = geometry, 
                          data_id = group_n, 
                          tooltip = paste(ds_nome, "<br>Óbitos:", n)),  # Nome + Óbitos
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "Óbitos",
    breaks = c(50, 100, 150, 200, 250),
    direction = 1,
    palette = "Reds"
  ) +
  labs(
    title = "",
    subtitle = "",
    caption = ""
  ) +
  theme_map() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = rel(2), hjust = 0.5, family = "Lora"),
    plot.caption = element_text(size = 25, hjust = 0.5, family = "Lora")
  ) + 
  guides(fill = "none")

# Criar o gráfico de barras laterais com os percentuais
x_labels <- c("0-50", "51-100", "101-150", "151-200", "201-250+")

pcol <- ggplot(pop_n, aes(group_n, share, fill = group_n)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
    geom_text_interactive(
    aes(
      y = pmin(share + 5, max(share) - 2),  # Impede que o texto saia do gráfico
      label = label, 
      color = case_when(
        group_n == "201-250+" ~ "black",  # Apenas essa categoria ficará preta
        TRUE ~ "white"
      ), 
      data_id = data_id
    ),
    size = 8, 
    hjust = -0.1 # Mantém os textos afastados para a direita
  ) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 18),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_n$share) + 30)

# Aplicar ao gráfico
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora")) +
  coord_sf(expand = FALSE) +  # Evita cortes no mapa
  theme_void() +
    annotate("text", 
           x = mean(st_bbox(shp_distritos_3)[c("xmin", "xmax")]),  # Centraliza no eixo X
           y = st_bbox(shp_distritos_3)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_3)[c("ymin", "ymax")]),  # Move para cima
           label = "Total absoluto de mortes",
           hjust = 0.5, vjust = 1, size = 12, fontface = "bold", family = "Lora")


# Combinar o mapa e o gráfico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)

# Criar um gráfico interativo com ggiraph
interactive_plot <- girafe(
  ggobj = p_final,
  width_svg = 14,   # Aumenta a largura do gráfico lateral
  height_svg = 12,
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)


```


```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}

theme_update(plot.title = element_text(size = 24, face = "bold", hjust = 0.5, family = "Lora"))

shp_distritos_3 <- shp_distritos_2 %>%
  mutate(group_mortes = cut(mortes_cem_mil_hab, 
                            breaks = quantile(mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE), 
                            include.lowest = TRUE))


# Criar categorias para o gráfico lateral (percentual de distritos por faixa)
pop_mortes <- shp_distritos_3 %>%
  st_drop_geometry() %>%
  group_by(group_mortes) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes)
  ) %>%
  na.omit()

# Criar o mapa com os distritos de São Paulo e a taxa de óbitos
pmap <- ggplot(shp_distritos_3) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geometry, 
                          data_id = group_mortes, 
                          tooltip = paste(ds_nome, "<br>Óbitos por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "Óbitos por 100k",
    breaks = quantile(shp_distritos_3$mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE),
    direction = 1,
    palette = "Reds"
  ) +
  labs(
    title = "",
    subtitle = "",
    caption = ""
  ) +
  theme_map() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = rel(2), hjust = 0.5, family = "Lora"),
    plot.caption = element_text(size = 25, hjust = 0.5, family = "Lora")
  ) + 
  guides(fill = "none")

# Criar o gráfico de barras laterais com os percentuais de distritos por taxa de óbitos
x_labels <- c("Baixo", "Médio-Baixo", "Médio", "Médio-Alto", "Alto")

pcol <- ggplot(pop_mortes, aes(group_mortes, share, fill = group_mortes)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
  aes(
    y = pmin(share + 5, max(share) - 2),  
    label = paste0(round(share, 1), "%"),  
    color = case_when(
      as.character(group_mortes) == max(as.character(group_mortes)) ~ "black",  # Converte para caractere
      TRUE ~ "white"
    ), 
    data_id = data_id
  ),
  size = 8, 
  hjust = -0.1 
) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 30)

# Aplicar ao gráfico a fonte 'Lora' e evitar cortes
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora")
) + coord_sf(expand = FALSE) + theme_void() +
  annotate("text", 
           x = mean(st_bbox(shp_distritos_3)[c("xmin", "xmax")]),  # Centraliza no eixo X
           y = st_bbox(shp_distritos_3)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_3)[c("ymin", "ymax")]),  # Move para cima
           label = "Taxa de mortes por 100k hab.",
           hjust = 0.5, vjust = 1, size = 12, fontface = "bold", family = "Lora")


# Combinar o mapa e o gráfico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)


# Criar um gráfico interativo com ggiraph
interactive_plot_2 <- girafe(
  ggobj = p_final,
  width_svg = 14,   # Aumenta a largura do gráfico lateral
  height_svg = 12,   # Aumenta a altura do gráfico lateral
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)


```


```{r, echo=FALSE, fig.height= 14, fig.width=16, out.width="300%", results="asis"}
library(htmltools)

# Criar layout flexível para exibir os gráficos lado a lado
htmltools::browsable(
  tags$div(
    style = "display: flex; justify-content: space-between; align-items: center; width: 100%;",
    
    # Mapa interativo (primeiro gráfico)
    tags$div(style = "width: 50%;", interactive_plot),  
    
    # Gráfico lateral interativo (segundo gráfico)
    tags$div(style = "width: 50%;", interactive_plot_2)  
  )
)



```

```{r include=FALSE}

# taxa de óbitos por 100k hab. e total de óbitos absolutos

dados_filtrados %>% 
  clean_names() %>% 
  group_by(ds_nome) %>% 
  tally() %>% 
  mutate(ds_nome = str_to_title(ds_nome)) %>% 
  left_join(pop, by = "ds_nome") %>% 
  summarise(
    total_obitos = sum(n, na.rm = TRUE),
    total_populacao = sum(pop, na.rm = TRUE),  
    taxa_obitos = (sum(n, na.rm = TRUE) / sum(pop, na.rm = TRUE)) * 100000
  )


```


## **Mortes ao longo do Tempo**

O gráfico abaixo mostra a evolução da taxa de mortes no trânsito por 100 mil habitantes nos últimos dez anos no município de São Paulo. Para essa estatística e as demais estamos utilizando a Data do Sinistro presente nos dados do Infosiga, e as estimativas de tamanho da população produzidas anualmente pelo IBGE, como não tivemos estimativa para 2023 utilizou-se o dado do censo de 2022. Ao passar o mouse pelos pontos do gráfico é possível ver a taxa discriminada por meios de locomoção da vítima. 


```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, out.extra='style="float: left;"'}

library(ggiraph)
library(gdtools)


# 🔹 Garantir que a fonte "Lora" seja reconhecida
invisible(gdtools::register_gfont("Lora"))

# 🔹 Garantir que cada ano tenha um único valor de PopMun
pop_estado_2 <- pop_estado_2 %>%
  group_by(Ano) %>%
  summarise(PopMun = max(PopMun), .groups = "drop")

# Calcular a taxa geral de mortes por ano
dados_taxa_geral <- dados_filtrados %>%
  group_by(Ano) %>%
  tally() %>%
  left_join(pop_estado_2, by = "Ano") %>%
  mutate(mortes_cem_mil_hab = round(n / PopMun * 100000, 2)) %>%
  ungroup()

# Calcular a taxa de mortes separada por meio de locomoção (para o tooltip)
dados_taxa_locomocao <- dados_filtrados %>%
  group_by(Ano, locomocao) %>%
  tally() %>%
  left_join(pop_estado_2, by = "Ano") %>%
  mutate(mortes_cem_mil_hab = round(n / PopMun * 100000, 2)) %>%
  ungroup()

# Criar um tooltip formatado com a taxa por meio de locomoção
tooltip_data <- dados_taxa_locomocao %>%
  group_by(Ano) %>%
  summarise(tooltip_text = paste0(
    "<b>Ano: ", Ano, "</b><br>",
    paste0(locomocao, ": ", mortes_cem_mil_hab, collapse = "<br>")
  ), .groups = "drop")

# Unir os tooltips ao dataframe principal
dados_interativo <- dados_taxa_geral %>%
  left_join(tooltip_data, by = "Ano")

# Criar gráfico interativo com ggiraph
grafico_interativo <- ggplot(dados_interativo, aes(
    x = Ano, 
    y = mortes_cem_mil_hab, 
    group = 1,
    tooltip = tooltip_text,  # 🔹 Tooltip mostra os valores detalhados
    data_id = Ano  # 🔹 Destaca apenas o ano atual
  )) +
  geom_line_interactive(color = "#f86254", size = 1) +  # Linha interativa
  geom_point_interactive(color = "#f86254", size = 3, alpha = 0.8) +  # Pontos interativos
  geom_text_interactive(
    aes(label = mortes_cem_mil_hab, tooltip = " "),  # 🔹 Remove tooltip do rótulo
    vjust = -0.4,  # 🔹 Ajusta a posição do rótulo acima do ponto
    size = 3.5, 
    color = "black",
    family = "Lora"
  ) +
  labs(title = "Evolução da Taxa de Mortes no Trânsito por 100k hab.",
       x = "",
       y = "") +
  scale_x_continuous(breaks = seq(2015, 2024, 1)) +
  theme_minimal() +
  theme(
    plot.title = element_text(family = "Lora", size = 11, face = "bold", hjust = 0.5, colour = "black"),
    text = element_text(family = "Lora"),
    axis.text = element_text(size = 12),
    axis.text.x = element_text(size = 11),
    legend.position = "none"
  )

# Converter para objeto interativo com ggiraph
girafe(
  ggobj = grafico_interativo, 
  width_svg = 6, height_svg = 4,
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_sizing(rescale = FALSE, width = 0.8)  # 🔹 Reduz o tamanho no HTML
  )
)




```



```{r eval=FALSE, include=FALSE, out.width="75%"}

dados_filtrados_taxa <- dados_filtrados %>% 
  group_by(Ano) %>% 
  tally() %>% 
  left_join(pop_estado_2, by = "Ano") %>% 
  mutate(mortes_cem_mil_hab = round(n/PopMun*100000, 2))

ggplot(dados_filtrados_taxa, aes(x = Ano, y = mortes_cem_mil_hab, group = 1, text = paste0(
  "Ano: ", Ano, "<br>",
  "Taxa: ", mortes_cem_mil_hab, "<br>"
))) +
  geom_line(color = "#f86254", size = 1) +
  geom_point(color = "#f86254", size = 5, alpha = 0.5) +
  labs(title = "Evolução da Taxa de Mortes no Trânsito por 100k hab.",
       x = "",
       y = "") +
  scale_x_continuous(breaks = seq(2015, 2024, 1)) + 
  theme_minimal() +
  geom_text(aes(label = round(mortes_cem_mil_hab, 2)), vjust = -0.6, fill = "white", color = "black", family = "Lora", size = 8)+
  theme(plot.title = element_text(family = "Lora", size = 22, face = "bold", hjust = 0.5, colour = "black"),
        text = element_text(family = "Lora"),
        axis.text = element_blank(),
        axis.text.x = element_text(size = 20),
        legend.position = "none")




```



O gráfico abaixo mostra a série história da quantidade absoluta de óbitos no trânsito de 2015 a 2024. Como podemos ver, os números estavam numa tendência de queda entre **2015 (1131)**, **2016 (976)** e **2017 (886)**, estacionando em 2018 com **895** óbitos e voltando a cair novamente em 2019 com o saldo de **860** óbitos. A queda drástica nas mortes em 2020 e 2021 podem estar associadas a pandemia de Covid-19, o isolamento social e adoção de teletrabalho em muitos setores, mas voltam a subir em 2022, **24%** a mais em relação a 2021, depois **7%** a mais em 2023 e finalmente **10%** a mais em 2024, o maior número desde 2016. Voltamos a patamares muito próximos de 2015, uma diferença de **3%** a menos, apenas. 

O gráfico também mostra os três distritos com mais óbitos em cada ano, dos 14 distritos que aparecem nessa estatística, 8 são da zona sul (Grajau, Jardim Angela, Capao Redondo, Jardim Sao Luis, Cidade Ademar, Campo Limpo, Cidade Dutra, Parelheiros), 3 da zona norte (Jaraguá, Pirituba, Jaçanã) e 3 da zona leste (Sapopemba, Itaquera, Cangaíba). Durante os dez anos da série histórica o distrito do Grajau apareceu em 7 deles no topo do ranking, 2015, 2016, 2017 e 2019, voltando a patamares semelhantes nos últimos 3 anos (2022, 2023 e 2024). Lembrando que o grajau também é o distrito com maior população na cidade de São Paulo (384.873 habitantes segundo censo de 2022). Para efeito de comparação o distrito do Jardim Angela, apesar de população parecida (311.432) só apareceu entre os três distritos com mais óbitos em 2016. 


```{r fig.align = 'center',  fig.height= 4, fig.width=10, out.width = "80%"}

# Obter os 3 distritos com mais mortes por ano
top3_distritos <- dados_filtrados %>% 
   filter(!is.na(ds_nome)) %>% 
   group_by(Ano, ds_nome) %>%  
   tally() %>% 
   arrange(Ano, desc(n)) %>%  
   group_by(Ano) %>% 
   slice(1:3) %>%  
   summarise(Top_Distritos = paste(ds_nome, collapse = ", "), .groups = "drop") 


# base de dados para o gráfico
dados_filtrados_1 <- dados_filtrados %>% 
  group_by(Ano) %>% 
  tally() %>% 
  left_join(top3_distritos, by = "Ano")


# Criar o gráfico interativo com Plotly
grafico_interativo <- ggplot(dados_filtrados_1, aes(x = Ano, y = n, text = paste0(
  "Ano: ", Ano, "<br>",
  "Mortes: ", n, "<br>",
  "Top Distritos: ", Top_Distritos
))) +
  geom_line(color = "#f86254") +
  geom_point(color = "#f86254", size = 4, alpha = 0.7) +
  labs(title = "Evolução das Mortes no Trânsito",
       x = "",
       y = "") +
  scale_x_continuous(breaks = seq(2015, 2024, 1)) +  # Garante que todos os anos aparecem
  theme_minimal() +
  geom_label(aes(label = n), vjust = -0.5, fill = "white", color = "black", family = "Lora", size = 4)+
  theme(plot.title = element_text(family = "Lora", size = 10, face = "bold", hjust = 0.5, colour = "black"),
        plot.subtitle = element_text(family = "Lora", size = 14, hjust = 0.5, colour = "gray30"),
        text = element_text(family = "Lora"),
        axis.text = element_text(size = 10),
        axis.text.x = element_text(size = 9),
        legend.position = "none")

# Converter para Plotly para adicionar interatividade
grafico_interativo_plotly <- ggplotly(grafico_interativo, tooltip = "text")

# Exibir o gráfico interativo
grafico_interativo_plotly

```

No gráfico abaixo analisamos os últimos dois anos, mês a mês, para entender se existe alguma tendência geral de queda ou aumento nas mortes no trânsito. Sabemos que em 2024 as mortes aumentaram  **10%** em relação ao ano anterior, mas o que mais chama à atenção neste gráfico são os meses de março, abril, maio, junho e julho de 2024, eles representam juntos **46%** a mais de mortes em relação aos mesmo período do ano anterior. A partir de setembro temos uma pequena tendência de queda no número de óbitos, que são menores em relação ao mesmo período do ano anterior. Em outubro, novembro e dezembro tivemos **18%** a menos de óbitos do que no mesmo período do ano anterior. De qualquer modo, ainda não é possível dizer que há uma tendência clara de queda no número de óbitos ao longo do último ano, mesmo comparativamente com 2023.  


```{r fig.align = 'center',  fig.height= 4, fig.width=10, out.width = "80%"}

titulo <- glue("Evolução das Mortes no Trânsito nos Últimos 2 anos, Mês a Mês \n <b style='color:#183047;'>2023</b> e <b style='color:#56B1F7;'>2024</b>")

# base de dados para o gráfico
dados_filtrados_1 <- dados_filtrados %>% 
  group_by(Ano, Mes) %>% 
  tally() %>% 
  left_join(top3_distritos, by = "Ano") %>% 
  filter(Ano == 2023 | Ano == 2024)


# Criar o gráfico interativo com Plotly
grafico_interativo <- ggplot(dados_filtrados_1, aes(x = Mes, y = n, color = Ano, group = Ano, text = paste0(
  "Mes: ", Mes, "<br>",
  "Ano: ", Ano, "<br>",
  "Mortes: ", n, "<br>"
))) +
  geom_line() +
  geom_point(size = 4, alpha = 0.7) +
  MetBrewer::scale_fill_met_d("Redon", direction=1)+
  labs(title = titulo,
       x = "",
       y = "") +
#  scale_x_continuous(breaks = seq(2015, 2024, 1)) +  # Garante que todos os anos aparecem
  theme_minimal() +
  geom_label(aes(label = n), vjust = -0.5, fill = "white", color = "black", family = "Lora", size = 4)+
  theme(plot.title = element_text(family = "Lora", size = 10, face = "bold", hjust = 0.5, colour = "black"),
        plot.subtitle = element_text(family = "Lora", size = 14, hjust = 0.5, colour = "gray30"),
        text = element_text(family = "Lora"),
        axis.text = element_text(size = 10),
        axis.text.x = element_text(size = 9),
        legend.position = "none")

# Converter para Plotly para adicionar interatividade
grafico_interativo_plotly <- ggplotly(grafico_interativo, tooltip = "text")

# Exibir o gráfico interativo
grafico_interativo_plotly

```



O gráfico abaixo também apresenta uma série histórica mas com a evolução das mortes por meio de locomoção da vítima. O que mais chama atenção neste gráfico é que, se até 2019 os pedestres eram as principais vítimas do trânsito na cidade, esse cenário mudou e os motociclistas assumiram essa posição. Desde 2020 o número de óbitos de motociclistas apenas aumentou, alcançando o patamar mais alto em 2024, com **496 óbitos**, um aumento de **38%** em relação a 2015.  

É alarmante também que as vítimas pedestres, apesar de decaírem em 2020, prrovavelmente devido a pandemia de Covid-19, também só aumentaram desde 2021. Desde então Presenciamos um aumento de **42%** em 2022 em relação a 2021, e esse números continuaram crescendo, em 2023 foram **12%** a mais e em 2024 **7%** a mais que no ano anterior. Os anos com mais mortes de pedestres foram: 2015 com **468** óbitos, 2016 com **406** óbitos e 2024 com **405**. Se comparado a 2015, em 2024 as mortes dimiuíram em **13%**. 

As mortes de ocupantes de automóveis vinha caindo de forma expressiva desde 2015 até voltarem a crescer em 2018 e estacionarem em números homogêneos até um crescimento de **19%** em 2023 e uma queda de **12%** em 2024. Se comprado a 2015, em 2024 as mortes dimiuíram em **40%**. 

As mortes de ciclistas também caíram de forma expressiva entre 2017 e 2018 (**35%**), continuaram subindo até 2021, quando caíram novamente **21%** e voltam a crescer alcançando o maior patamar da série histórica em 2024, um aumento de **64%** em relação a 2015. 

As mortes de ocupantes de caminhão vinham caindo consistentemente desde 2015, quando subiu drasticamente em 2019 (**2** para 14 mortes entre 2018 e 2019), e desde 2022 vem subindo novamente, 2024 alcançou o patamar mais alto desde 2015, com **17** mortes. 

Por fim, o meio de transporte menos letal, o ônibus, desde uma subida nos números em 2017, tem se apresentado relativamente estacionário, se comparado a 2015 em 2024 tivemos uma diminuição nas mortes em **25%**. 


```{r fig.align = 'center',  fig.height= 4, fig.width=10, out.width = "80%"}

titulo <- glue("Evolução das Mortes no Trânsito por Meio de Locomoção da Vítima \n <b style='color:#18C5C9;'>Motocicleta</b>,  <b style='color:#F46FE5;'>Pedestre</b>, <b style='color:#F8837B;'>Automóvel</b>, <b style='color:#BEA818;'>Bicicleta</b>, <b style='color:#599FED;'>Ônibus</b>, <b style='color:#04BB3B;'>Caminhão</b>")

# Criar o gráfico interativo com linhas
grafico_interativo <- ggplot(dados_locomocao, aes(x = Ano, y = n, color = locomocao, 
                                                  group = locomocao,  # 🔹 Garante que cada locomoção tenha sua própria linha
                                                  text = paste0("Ano: ", Ano, "<br>",
                                                                "Mortes: ", n, "<br>",
                                                                "Locomocao: ", locomocao, "<br>"))) +  
  geom_line(size = 0.5, alpha = 0.8) +  # 🔹 Agora com linhas conectadas
  geom_point(size = 3, alpha = 0.9) +  # 🔹 Mantém os pontos para destaque
  labs(title = titulo,
       x = "",
       y = "") +
  scale_x_continuous(breaks = seq(2015, 2024, 1)) + 
  MetBrewer::scale_fill_met_d("Redon", direction=1) +
  theme_minimal() +
  theme(plot.title = element_text(family = "Lora", size = 10, face = "bold", hjust = 0.5, colour = "black"),
        text = element_text(family = "Lora"),
        axis.text = element_text(size = 9),
        axis.text.x = element_text(size = 9),
        legend.position = "none")


# Converter para Plotly para adicionar interatividade
grafico_interativo_plotly <- ggplotly(grafico_interativo, tooltip = "text")

# Exibir o gráfico interativo
grafico_interativo_plotly



```


O gráfico abaixo mostra os mesmos dados do gráfico anterior mas nele podemos enxergar melhor as diferenças proporcionais entre a quantidade de mortes de cada meio de locomoção. A cidade de São Paulo tem sido cada vez mais perigosa para motociclistas e ciclistas, ao passo que mais segura para os ocupantes de automóveis e ônibus. Desde 2021 também têm sido consistentemente mais perigoso ser um pedestre. 


```{r echo=FALSE,  fig.height= 10, fig.width=18, out.width="100%"}

col_vec <- c(
  "Motocicleta" = "#18C5C9",
  "Pedestre" = "#F46FE5",
  "Automóvel" = "#F8837B",
  "Bicicleta" = "#BEA818",
  "Ônibus" = "#599FED",
  "Caminhão" = "#04BB3B"
)



# Criar gráfico
  ggplot(dados_locomocao, 
                               aes(fill = locomocao, values = n)) +  # 🔹 Removi `text =` daqui
  geom_waffle(color = "white", size = 0.01, n_rows = 12, flip = TRUE) +
  facet_wrap(~Ano, nrow = 1, strip.position = "bottom") +
  scale_x_discrete() + 
    scale_fill_manual(
    values = c("#18C5C9", alpha("#F46FE5", 1/3), alpha("#F8837B", 1/2), alpha("#BEA818", 1/3), alpha("#599FED", 1/2), alpha("#04BB3B", 1/3)
  ))+
  coord_equal() +
  labs(title = "Evolução das Mortes no Trânsito por Meio de Locomoção da Vítima") +
  theme_minimal() +
  theme(
      # Texto
    plot.title = element_text(family = "Lora", size = 13, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(family = "Lora", size = 14, hjust = 0.5, colour = "gray30"),
    text = element_text(family = "Lora"),
    axis.text.x = element_text(size = 35), 
    axis.text.y = element_text(size = 12), 
    legend.position = "right", 
    legend.text = element_text(size = 11),
    legend.title = element_blank(), 
    legend.spacing.x = unit(2.5, 'cm'),  # 🔹 Aumenta o espaçamento horizontal dos itens da legenda
    legend.key.width = unit(1.5, "cm"))

showtext_opts(dpi = 320)



```


O gráfico abaixo nos mostra a evolução da quantidade absoluta das mortes no trânsito em cada macroregião da cidade. A zona leste e a zona sul são as regiões com mais mortes em toda a série histórica. Apesar de números bem próximos, a zona sul têm sido a região mais letal da cidade em quase todos os anos. Chama à atenção também que essa região esteja presenciando a maior súbida initerrupta dos casos desde 2021 logo após uma queda consistente de 2016 a 2021. O volume de óbitos aumentou **35%** em 2022, **15%** em 2023 e **13%** em 2024. Comparativamente com 2015, tivemos um aumento de **12%** nos óbitos da zona sul em 2024. 

Na zona leste, do mesmo modo que na zona sul, os óbitos vinham caindo de forma consistente desde 2015, quando começaram a subir em 2021, para se ter uma ideia os óbitos nessa região subiram **49%** em 2022, o que pode, assim como nas outras regiões, marcar a passagem do período de pandemia para o de abertura do isolamento social na cidade, os anos posteriores tiveram aumentos também mas consideravelmente menores, **3%** em 2023 e **6%** em 2024. Comparativamente com 2015, os óbitos na zona leste diminíram **17%** em 2024. 

A zona norte é a terceira região com mais óbitos em termos absolutos. A região também presenciou uma queda nos números entre 2015 e 2017, quando começa a subir até cair novamente durante o periodo da pandemia. Desde 2020 os óbitos tem aumentado de forma consistente, tendo permanecido estável em 2023 até subir **24%** em 2024. Comparativamente com 2015, os óbitos permaneceram estáveis em 2024, tendo caído apenas **0.5%**. 

A zona oeste e o centro têm séries históricas parecidas, acompanharam a tendência geral da cidade de queda nos óbitos entre 2015 e 2017, voltando a subir para novamente cair na época da pandemia. A zona oeste viveu um aumento significativo em 2022 (**70%**), o maior pós pandemia comparativamente com as outras regiões, mas tem caído na quantidade de óbitos mesmo que de forma sutíl, em 2023 teve **4%** a menos e 2024 também **4%*** a menos que o ano anterior. Comparativamente com 2015, os óbitos na zona oeste diminuíram em **37%**, no centro essa diminuição foi de **60%**. 



```{r fig.align = 'center',  fig.height= 4, fig.width=10, out.width = "80%"}

titulo <- glue("Evolução das Mortes no Trânsito por Região de São Paulo \n <b style='color:#E271F2;'>Sul</b>,  <b style='color:#AAAE27;'>Leste</b>, <b style='color:#40C48A;'>Norte</b>, <b style='color:#49B6F5;'>Oeste</b>, <b style='color:#F1877E;'>Centro</b>")

# Criar o gráfico interativo com linhas
grafico_interativo <- ggplot(mortes_regiao, aes(x = Ano, y = n, color = regiao, 
                                                  group = regiao,  # 🔹 Garante que cada locomoção tenha sua própria linha
                                                  text = paste0("Ano: ", Ano, "<br>",
                                                                "Mortes: ", n, "<br>",
                                                                "regiao: ", regiao, "<br>"))) +  
  geom_line(size = 0.5, alpha = 0.8) +  # 🔹 Agora com linhas conectadas
  geom_point(size = 3, alpha = 0.9) +  # 🔹 Mantém os pontos para destaque
  labs(title = titulo,
       x = "",
       y = "") +
  scale_x_continuous(breaks = seq(2015, 2024, 1)) + 
  MetBrewer::scale_fill_met_d("Redon", direction=1) +
  theme_minimal() +
  theme(plot.title = element_text(family = "Lora", size = 10, face = "bold", hjust = 0.5, colour = "black"),
        text = element_text(family = "Lora"),
        axis.text = element_text(size = 9),
        axis.text.x = element_text(size = 9),
        legend.position = "none")


# Converter para Plotly para adicionar interatividade
grafico_interativo_plotly <- ggplotly(grafico_interativo, tooltip = "text")

# Exibir o gráfico interativo
grafico_interativo_plotly



```


## **Análise por Distrito**

O objetivo desta análise é entender quais são os distritos mais perigosos para pedestres, motociclistas, usuários de automóveis e ciclistas. Para isso estamos comparando os distritos a partir de sua taxa de óbitos, em cada um desses meios de locomoção, por 100 mil habitantes. 

No primeiro mapa é possível verificar que os distritos mais perigosos para pedestres (com taxa de mortes entre **41.5** e **227** por 100 mil hab.), classificados no mapa abaixo como 'Alto' risco,  por ordem de taxa de óbitos são: **Sé,	Bom Retiro, Jaguará, Jacanã, República, Brás, Butantã, Pari, Consolação, Santo Amaro Pinheiros, Vila Leopoldina, Socorro, Barra Funda, Vila Maria, Lapa, Anhanguera, Belem, Cidade Dutra**. A Sé se destaca em relação aos outros distritos com uma taxa de 226, para se ter uma ideia o Bom Retiro mesmo ocupando o segundo lugar do ranking tem uma taxa de 110 mortes. De forma geral os distritos mais periodos para pedestres estão em sua maioria no centro da cidade.

No segundo mapa temos os distritos mais periogosos para motociclistas (com taxa de mortes entre **44.8** e **113** por 100 mil hab.), classificados no mapa abaixo como 'Alto' risco,  por ordem de taxa de óbitos são: **Jaguará, Socorro, Santo Amaro, Anhanguera, Butantã, Pari, Bom Retiro, Morumbi, Sé, Perus**. A zona oeste se destaca com três distritos no ranking de Alto risco, a zona leste por outro lado conta com apenas 1 distrito. 


No terceiro mapa temos os distritos mais periogosos para condutores de automóveis (com taxa de mortes entre **16.7** e **36.4** por 100 mil hab.), classificados no mapa abaixo como 'Alto' risco, por ordem de taxa de óbitos são: **Jaguará, Santo Amaro, Butantã, Jaguaré, Perus, Morumbi, Jaçanã, Belem, Vila Leopoldina, Tatuapé, Parque Do Carmo, Anhanguera, Cangaiba, Penha, Alto De Pinheiros, Socorro, Campo Belo, Barra Funda, Bom Retiro, Se **.  Das 20 cidades com taxas de Alto Risco, 6 são da zona oeste, 5 da zona norte, 4 são da leste, 3 da zona sul e 2 do centro de São Paulo. 

No quarto mapa temos os distritos mais periogosos para ciclistas (com taxa de mortes entre **4.45** e **12.9** por 100 mil hab.), classificados no mapa abaixo como 'Alto' risco, por ordem de taxa de óbitos são: **Brás, Jaguará, Jaçanã, Barra Funda, Sé, Anhanguera, Vila Maria, Bom Retiro, Butantã, Pari, Belém, Socorro, Cangaiba, Mooca, São Miguel, Jardim Paulista, Cachoeirinha, Pinheiros, Tremembe**.  Das 19 cidades com taxas de Alto Risco, 6 são da zona leste,  5 da zona norte, 5 são da zona oeste, 2 no centro e 1 na zona sul. 

Como havíamos mostrado nos primeiros mapas por distrito, com taxas gerais, a Sé é o distrito com mais mortes proporcionalmente a sua populaçǎo, com ênfase na mortes de pedestres. O distrito do Jaraguá é o segundo do ranking em mortes no trânsito, com essa análise mais detalhada podemos ver que esse distrito é bastante crítico no que diz respeito a mortes de motociclistas e condutores de automóveis. 


```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}

dados_pedestres <- dados_filtrados %>% 
  filter(!is.na(ds_nome)) %>% 
  clean_names() %>% 
  group_by(ds_nome, pop, locomocao) %>% 
  tally() %>% 
  filter(locomocao == "PEDESTRE") %>% 
  mutate(mortes_cem_mil_hab = n/pop*100000)


shp_distritos_2 <- shp_distritos_1 %>%
  left_join(dados_pedestres, by = "ds_nome")

shp_distritos_pedestres <- shp_distritos_2 %>%
  mutate(group_mortes_pedestres = cut(mortes_cem_mil_hab, 
                            breaks = quantile(mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE), 
                            include.lowest = TRUE))

# Criar categorias para o gráfico lateral (percentual de distritos por faixa)
pop_mortes <- shp_distritos_pedestres %>%
  st_drop_geometry() %>%
  group_by(group_mortes_pedestres) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes_pedestres)
  ) %>%
  na.omit()

# Criar o mapa com os distritos de São Paulo e a taxa de óbitos
pmap <- ggplot(shp_distritos_pedestres) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geometry, 
                          data_id = group_mortes_pedestres, 
                          tooltip = paste(ds_nome, "<br>Óbitos de pedestres por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "Óbitos por 100k",
    breaks = quantile(shp_distritos_pedestres$mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE),
    direction = 1,
    palette = "Reds"
  ) +
  labs(
    title = "",
    subtitle = "",
    caption = ""
  ) +
  theme_map() +
  guides(fill = "none")

# Criar o gráfico de barras laterais com os percentuais de distritos por taxa de óbitos
x_labels <- c("Baixo", "Médio-Baixo", "Médio", "Médio-Alto", "Alto")


pcol <- ggplot(pop_mortes, aes(group_mortes_pedestres, share, fill = group_mortes_pedestres)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
  aes(
    y = pmin(share + 5, max(share) - 2),  
    label = paste0(round(share, 1), "%"),  
    color = case_when(
      as.character(group_mortes_pedestres) == max(as.character(group_mortes_pedestres)) ~ "black",  # Converte para caractere
      TRUE ~ "white"
    ), 
    data_id = data_id
  ),
  size = 8, 
  hjust = -0.1 
) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 40)


# Aplicar ao gráfico a fonte 'Lora' e evitar cortes
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora")
) + coord_sf(expand = FALSE) + theme_void() +
  annotate("text", 
           x = mean(st_bbox(shp_distritos_pedestres)[c("xmin", "xmax")]),  # Centraliza no eixo X
           y = st_bbox(shp_distritos_pedestres)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_pedestres)[c("ymin", "ymax")]),  # Move para cima
           label = "Mortes de Pedestres p/ 100k hab.",
           hjust = 0.5, vjust = 1, size = 10, fontface = "bold", family = "Lora")

# Combinar o mapa e o gráfico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)


# Criar um gráfico interativo com ggiraph
interactive_plot_pedestres <- girafe(
  ggobj = p_final,
  width_svg = 14,   # Aumenta a largura do gráfico lateral
  height_svg = 12,   # Aumenta a altura do gráfico lateral
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)



interactive_plot_pedestres

```


```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}

dados_motos <- dados_filtrados %>% 
  filter(!is.na(ds_nome)) %>% 
  clean_names() %>% 
  group_by(ds_nome, pop, locomocao) %>% 
  tally() %>% 
  filter(locomocao == "MOTOCICLETA") %>% 
  mutate(mortes_cem_mil_hab = n/pop*100000)


shp_distritos_2 <- shp_distritos_1 %>%
  left_join(dados_motos, by = "ds_nome")

shp_distritos_motos <- shp_distritos_2 %>%
  mutate(group_mortes_motos = cut(mortes_cem_mil_hab, 
                            breaks = quantile(mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE), 
                            include.lowest = TRUE))

# Criar categorias para o gráfico lateral (percentual de distritos por faixa)
pop_mortes <- shp_distritos_motos %>%
  st_drop_geometry() %>%
  group_by(group_mortes_motos) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes_motos)
  ) %>%
  na.omit()


# Criar o mapa com os distritos de São Paulo e a taxa de óbitos
pmap <- ggplot(shp_distritos_motos) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geometry, 
                          data_id = group_mortes_motos, 
                          tooltip = paste(ds_nome, "<br>Óbitos de motociclistas por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "Óbitos por 100k",
    breaks = quantile(shp_distritos_motos$mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE),
    direction = 1,
    palette = "Reds"
  ) +
  theme_map() +
  guides(fill = "none")

pcol <- ggplot(pop_mortes, aes(group_mortes_motos, share, fill = group_mortes_motos)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
  aes(
    y = pmin(share + 5, max(share) - 2),  
    label = paste0(round(share, 1), "%"),  
    color = case_when(
      as.character(group_mortes_motos) == max(as.character(group_mortes_motos)) ~ "black",  # Converte para caractere
      TRUE ~ "white"
    ), 
    data_id = data_id
  ),
  size = 8, 
  hjust = -0.1 
) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 40)

# Aplicar ao gráfico a fonte 'Lora' e evitar cortes
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora") +
  guides(fill = "none")) + coord_sf(expand = FALSE) + theme_void() +
  annotate("text", 
           x = mean(st_bbox(shp_distritos_motos)[c("xmin", "xmax")]),  
           y = st_bbox(shp_distritos_motos)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_motos)[c("ymin", "ymax")]),  
           label = "Mortes de Motociclistas p/ 100k hab.",
           hjust = 0.5, vjust = 1, size = 10, fontface = "bold", family = "Lora")

# Combinar o mapa e o gráfico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)

interactive_plot_2_moto <- girafe(
  ggobj = p_final,
  width_svg = 14,  
  height_svg = 12,   
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)





```


```{r, echo=FALSE, fig.height= 14, fig.width=16, out.width="200%", results="asis"}
library(htmltools)

# Criar layout flexível para exibir os gráficos lado a lado
htmltools::browsable(
  tags$div(
    style = "display: flex; justify-content: space-between; align-items: center; width: 100%;",
    
    # Mapa interativo (primeiro gráfico)
    tags$div(style = "width: 50%;", interactive_plot_pedestres),  
    
    # Gráfico lateral interativo (segundo gráfico)
    tags$div(style = "width: 50%;", interactive_plot_2_moto)  
  )
)



```


```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}


dados_automovel <- dados_filtrados %>% 
  filter(!is.na(ds_nome)) %>% 
  clean_names() %>% 
  group_by(ds_nome, pop, locomocao) %>% 
  tally() %>% 
  filter(locomocao == "AUTOMOVEL") %>% 
  mutate(mortes_cem_mil_hab = n/pop*100000) %>% 
    bind_rows(
    data.frame(ds_nome = "Marsilac", mortes_cem_mil_hab = 0),
    data.frame(ds_nome = "Perdizes", mortes_cem_mil_hab = 0),
    data.frame(ds_nome = "Bela Vista", mortes_cem_mil_hab = 0)
  )

shp_distritos_2 <- shp_distritos_1 %>%
  left_join(dados_automovel, by = "ds_nome")

shp_distritos_automovel <- shp_distritos_2 %>%
  mutate(group_mortes_automovel = cut(mortes_cem_mil_hab, 
                            breaks = quantile(mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE), 
                            include.lowest = TRUE))

# Criar categorias para o gráfico lateral (percentual de distritos por faixa)
pop_mortes <- shp_distritos_automovel %>%
  st_drop_geometry() %>%
  group_by(group_mortes_automovel) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes_automovel)
  ) %>%
  na.omit()


# Criar o mapa com os distritos de São Paulo e a taxa de óbitos
pmap <- ggplot(shp_distritos_automovel) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geometry, 
                          data_id = group_mortes_automovel, 
                          tooltip = paste(ds_nome, "<br>Óbitos de condutores de automóvel por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
scale_fill_fermenter(
    name = "Óbitos por 100k",
    breaks = quantile(shp_distritos_automovel$mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE),
    direction = 1,
    palette = "Reds"
  ) +
  theme_map() +
  guides(fill = "none")

pcol <- ggplot(pop_mortes, aes(group_mortes_automovel, share, fill = group_mortes_automovel)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
  aes(
    y = pmin(share + 5, max(share) - 2),  
    label = paste0(round(share, 1), "%"),  
    color = case_when(
      as.character(group_mortes_automovel) == max(as.character(group_mortes_automovel)) ~ "black",  # Converte para caractere
      TRUE ~ "white"
    ), 
    data_id = data_id
  ),
  size = 8, 
  hjust = -0.1 
) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 40)

# Aplicar ao gráfico a fonte 'Lora' e evitar cortes
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora") +
  guides(fill = "none")) + coord_sf(expand = FALSE) + theme_void() +
  annotate("text", 
           x = mean(st_bbox(shp_distritos_automovel)[c("xmin", "xmax")]),  
           y = st_bbox(shp_distritos_automovel)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_automovel)[c("ymin", "ymax")]),  
           label = "Mortes de usuários de automóveis \n p/ 100k hab.",
           hjust = 0.5, vjust = 1, size = 10, fontface = "bold", family = "Lora")

# Combinar o mapa e o gráfico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)

interactive_plot_2_auto <- girafe(
  ggobj = p_final,
  width_svg = 14,  
  height_svg = 12,   
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)




```


```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}


dados_ciclistas <- dados_filtrados %>% 
  filter(!is.na(ds_nome)) %>% 
  clean_names() %>% 
  group_by(ds_nome, pop, locomocao) %>% 
  tally() %>% 
  filter(locomocao == "BICICLETA") %>% 
  mutate(mortes_cem_mil_hab = n/pop*100000) %>% 
  bind_rows(
    data.frame(ds_nome = "Marsilac", mortes_cem_mil_hab = 0),
    data.frame(ds_nome = "Morumbi", mortes_cem_mil_hab = 0), 
    data.frame(ds_nome = "Rio Pequeno", mortes_cem_mil_hab = 0),
    data.frame(ds_nome = "Sao Domingos", mortes_cem_mil_hab = 0), 
    data.frame(ds_nome = "Liberdade", mortes_cem_mil_hab = 0), 
    data.frame(ds_nome = "Cidade Lider", mortes_cem_mil_hab = 0)
  )

shp_distritos_2 <- shp_distritos_1 %>%
  left_join(dados_ciclistas, by = "ds_nome")


shp_distritos_ciclistas <- shp_distritos_2 %>%
  mutate(group_mortes_ciclistas = cut(mortes_cem_mil_hab, 
                            breaks = quantile(mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE), 
                            include.lowest = TRUE))

# Criar categorias para o gráfico lateral (percentual de distritos por faixa)
pop_mortes <- shp_distritos_ciclistas %>%
  st_drop_geometry() %>%
  group_by(group_mortes_ciclistas) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes_ciclistas)
  ) %>%
  na.omit()

# Criar o mapa com os distritos de São Paulo e a taxa de óbitos
pmap <- ggplot(shp_distritos_ciclistas) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geometry, 
                          data_id = group_mortes_ciclistas, 
                          tooltip = paste(ds_nome, "<br>Óbitos de ciclistas por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
scale_fill_fermenter(
    name = "Óbitos por 100k",
    breaks = quantile(shp_distritos_ciclistas$mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE),
    direction = 1,
    palette = "Reds"
  ) +
  theme_map() +
  guides(fill = "none")


pcol <- ggplot(pop_mortes, aes(group_mortes_ciclistas, share, fill = group_mortes_ciclistas)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
  aes(
    y = pmin(share + 5, max(share) - 2),  
    label = paste0(round(share, 1), "%"),  
    color = case_when(
      as.character(group_mortes_ciclistas) == max(as.character(group_mortes_ciclistas)) ~ "black",  # Converte para caractere
      TRUE ~ "white"
    ), 
    data_id = data_id
  ),
  size = 8, 
  hjust = -0.1 
) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 40)


# Aplicar ao gráfico a fonte 'Lora' e evitar cortes
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
) + coord_sf(expand = FALSE) + theme_void() +
  guides(fill = "none") +
  annotate("text", 
           x = mean(st_bbox(shp_distritos_ciclistas)[c("xmin", "xmax")]),  # Centraliza no eixo X
           y = st_bbox(shp_distritos_ciclistas)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_ciclistas)[c("ymin", "ymax")]),  # Move para cima
           label = "Mortes de Ciclistas p/ 100k hab.",
           hjust = 0.5, vjust = 1, size = 10, fontface = "bold", family = "Lora")


# Combinar o mapa e o gráfico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)

interactive_plot_2_ciclistas <- girafe(
  ggobj = p_final,
  width_svg = 14,   # Aumenta a largura do gráfico lateral
  height_svg = 12,   # Aumenta a altura do gráfico lateral
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)




```



```{r, echo=FALSE, fig.height= 14, fig.width=16, out.width="150%", results="asis"}
library(htmltools)

# Criar layout flexível para exibir os gráficos lado a lado
htmltools::browsable(
  tags$div(
    style = "display: flex; justify-content: space-between; align-items: center; width: 100%;",
    
    # Mapa interativo (primeiro gráfico)
    tags$div(style = "width: 50%;", interactive_plot_2_auto),  
    
    # Gráfico lateral interativo (segundo gráfico)
    tags$div(style = "width: 50%;", interactive_plot_2_ciclistas)  
  )
)



```


## **Características dos Acidentes**


Tipo de Sinistro mais Frequente

Na tabela abaixo tentamos entender o tipo de acidente mais frequente para cada meio de locomoção da vítima e o percentual de vezes em que esse tipo de acidente acontece. Para essa análise excluímos os óbitos sem essa informação e também os que estavam constando como Outros ou Não Disponível.Como podemos ver na tabela pesdestres morrem atropelados e usuários de automóveis e motociclistas morrem mais por choque. Também olhamos a frequência em que cada um desses tipos de sinistro mais ocorrem, os atropelamentos são **51%** dos acidentes que geram mortes, seguido de choque com **18%** e tombamento com **8%**. 

```{r}

dados_filtrados %>% 
  filter(!is.na(`Tipo de Sinistro`)) %>% 
  filter(`Tipo de Sinistro` != "OUTROS" ) %>% 
  filter(locomocao != "OUTROS" & locomocao != "NAO DISPONIVEL") %>% 
  group_by(locomocao, `Tipo de Sinistro`) %>% 
  tally() %>% 
  mutate(Percentual = n/ sum(n)) %>% 
  arrange(locomocao, desc(n)) %>% 
  group_by(locomocao) %>%
  slice_max(order_by = n, n = 1) %>%  
  select(locomocao, Percentual, `Tipo de Sinistro`) %>% 
  mutate(`Tipo de Sinistro` = stringr::str_to_title(`Tipo de Sinistro`), 
         locomocao = stringr::str_to_title(locomocao)) %>% 
  reactable(
      fullWidth = FALSE,
      defaultPageSize = 10,
      searchable = FALSE,
      outlined = TRUE, 
      showPageInfo = TRUE, 
      showPageSizeOptions = TRUE,
      defaultColDef = colDef(
      align = "center",
      headerStyle = list(background = "#D6DEEF")),
      columns = list(
      locomocao = colDef("Locomoção da Vítima", minWidth = 100, align = "left"),
      Percentual = colDef("Percentual de Frequência" , format = colFormat(percent = TRUE, digits = 1), minWidth = 140),
      `Tipo de Sinistro` = colDef("Tipo de Sinistro mais Frequente", minWidth = 140, align = "center"),
      bordered = TRUE, striped = FALSE, highlight = TRUE))


```


```{r eval=FALSE, include=FALSE}


dados_filtrados %>% 
  filter(!is.na(`Tipo de Sinistro`)) %>% 
  filter(`Tipo de Sinistro` != "OUTROS") %>% 
  mutate(`Tipo de Sinistro` = stringr::str_to_title(`Tipo de Sinistro`)) %>%
  group_by(`Tipo de Sinistro`) %>% 
  tally() %>% 
  mutate(pct = n / sum(n)*100)

  

```

Outro Veículo Envolido no Acidente

Na tabela abaixo fizemos uma análise do outro veículo envolvido no acidente que causou a morte no trânsito. Assim como na tabela anterior também desconsideramos as linhas com ausência de informações, outros e não disponível. Como podemos ver, o automóvel é quase sempre o envolvido no acidente que causou morte, com exceção dos casos em que a vítima estava em um caminhão. Também fizemos um ranking dos 'outros veículos' mais frequentes em acidentes que causaram mortes, o automóvel aparece em **50%** dos casos seguido dos ônibus com **19%**, seguido da motocicleta com **16%** dos casos e o caminhão em quarto lugar com **13%**. Ciclistas e pedestres aparecem com menos de **1%** cada. 

```{r}

dados_filtrados %>% 
  filter(!is.na(`Tipo de Sinistro`)) %>% 
  filter(`Outro Veículo Envolvido` != "OUTROS", `Outro Veículo Envolvido` != "NAO DISPONIVEL") %>% 
  filter(locomocao != "OUTROS" & locomocao != "NAO DISPONIVEL") %>% 
  group_by(locomocao, `Outro Veículo Envolvido`) %>% 
  tally() %>% 
  mutate(Percentual = n/ sum(n)) %>% 
  arrange(locomocao, desc(n)) %>%
  group_by(locomocao) %>%
  slice_max(order_by = n, n = 1) %>% 
  select(locomocao, Percentual, `Outro Veículo Envolvido`) %>% 
  mutate(`Outro Veículo Envolvido` = stringr::str_to_title(`Outro Veículo Envolvido`), 
         locomocao = stringr::str_to_title(locomocao)) %>% 
    reactable(
      fullWidth = FALSE,
      defaultPageSize = 10,
      searchable = FALSE,
      outlined = TRUE, 
      showPageInfo = TRUE, 
      showPageSizeOptions = TRUE,
      defaultColDef = colDef(
      align = "center",
      headerStyle = list(background = "#D6DEEF")),
      columns = list(
      locomocao = colDef("Locomoção da Vítima", minWidth = 100, align = "left"),
      Percentual = colDef("Percentual de Frequência" , format = colFormat(percent = TRUE, digits = 1), minWidth = 140),
      `Outro Veículo Envolvido` = colDef("Outro Veículo Envolvido mais Frequente", minWidth = 150, align = "center"),
      bordered = TRUE, striped = FALSE, highlight = TRUE))
  

```


```{r eval=FALSE, include=FALSE}

dados_filtrados %>% 
  filter(!is.na(`Outro Veículo Envolvido`)) %>% 
  filter(`Outro Veículo Envolvido` != "OUTROS", `Outro Veículo Envolvido` != "NAO DISPONIVEL") %>%  
  group_by(`Outro Veículo Envolvido`) %>% 
  tally() %>% 
  arrange(-n) %>% 
  mutate(pct = n/sum(n)*100) 

```


## **Avenidas com mais mortes**

Descendo um pouco mais o nível da análise fizemos um ranking das avenidas pela quantidade total de mortes na última década. A Av. Senador Teotônio Vilela está no topo da lista apesar de não ser uma das maiores em extensão, já que possui cerca de 10 km, essa avenida inicia-se na Av. Interlagos (o 9° lugar no ranking), interliga Socorro e Cidade Dutra, e termina no distrito de Parelheiros. Ela se destaca com **27%** a mais de mortes do que a Av. Aricanduva, que aparece em segundo lugar, e **39%** a mais que a a Jacú Pêssego em 3° lugar, confirmando como demonstrado nas outras análises, a primazia da zona sul como a região com trânsito mais perigoso de São Paulo. 

Importa destacar algumas especifidades das mortes nas 10 avenidas com mais mortes. Das **74** mortes que ocorreram na Av. Senador Teotônio Vilela **37** eram motociclistas e **27** eram pedestres, também morreram **8** pessoas que estava em automóvel, 1 de bicicleta e **1** morte por meio desconhecido. As mortes na Av. Aricanduva,  Av. do Estado, Av. Raimundo Pereira de Magalhaes, Av. das Nacoes Unidas, Av. Prof Francisco Morato e Av. Morvan Dias de Figueiredo seguem o mesmo sentido, morre-se mais motociclistas, seguidos de pedestres, ocupantes de automóveis e ciclistas. Interessante notar que na Jacu Pessego morreram a mesma quantidade de pedestres e motociclistas entre 2015 e 2024 (**17** pessoas em cada meio de locomoção) e que nas avenidas Sapopemba e Interlagos morreram mais pedestres do que motociclistas. Importante também ressaltar que na Av. Morvan Dias de Figueiredo morre-se de forma desproporcional mais motociclistas do que usuários de outros meios, morreram **23**	motociclistas, em relação a **5** pedestres, **2** pessoas de automóvel e **1** de caminhão. 


```{r echo=FALSE}

# Função para juntar as colunas ignorando NA
concatenate_columns <- function(...) {
  words <- c(...)  # Junta os argumentos em um vetor
  words <- words[!is.na(words)]  # Remove os NAs
  str_c(words, collapse = " ")  # Junta os elementos com espaço
}


dados_logadouro %>% 
    mutate(`Data do Sinistro` = dmy(`Data do Sinistro`), 
    Ano = year(`Data do Sinistro`)) %>% 
    filter(!Ano %in% c(2012, 2013, 2014, 2010, 1995, 1986, 2000, 2009, 2011)) %>%
    filter(lg_tipo == 'AV') %>% 
    rowwise() %>%
    mutate(
    nome_completo = concatenate_columns(lg_tipo, lg_titulo, lg_prep, lg_nome),
    nome_completo = str_to_title(nome_completo), 
    nome_completo = str_replace_all(nome_completo, "\\b(Do|De|Dos|Das|Da)\\b", str_to_lower)) %>%
    ungroup() %>% 
    group_by(nome_completo) %>% 
    tally() %>% 
    arrange(-n) %>% 
    reactable(
      fullWidth = FALSE,
      defaultPageSize = 10,
      searchable = TRUE,
      outlined = TRUE, 
      showPageInfo = TRUE, 
      showPageSizeOptions = TRUE,
      defaultColDef = colDef(
      align = "center",
      headerStyle = list(background = "#D6DEEF")),
      columns = list(
      nome_completo = colDef("Nome da Avenida", minWidth = 90, align = "left"),
      n = colDef("Qtd de Mortes (2015 a 2024)", minWidth = 70, align = "center"),
      pageSizeOptions = c(5, 10,15,20,25,30), bordered = TRUE, striped = FALSE, highlight = TRUE))




```


## **Considerações Finais**

A análise que produzimos permite algumas conclusões e considerações a respeito da evolução das mortes no trânsito de São Paulo nos últimos dez anos (2015-2024). O primeiro ponto a ser elucidado é que o município de São Paulo tem uma taxa relativamente baixa de mortes no trânsito se comparado com outras cidades do Estado, proporcionamente à sua população. Quando olhamos mais detalhadamente para as mortes na cidade, no recorte por distrito, em termos absolutos há uma concentração excessiva de mortes na zona sul, principalmente por conta do adensamento populacionam dessa região e também os grandes deslocamentos diários dessa população em direção ao centro para o trabalho. Em termos proporcionais a população, ou seja, taxa de mortes por 100 mil habitantes, distritos do centro, como a Sé, próximo ao centro como o Butantã e Jaraguá são os mais críticos. As especificidades dessas regiões que levam a esse destaque em relação aos outros pontos da cidade devem ser averiguados para mitigar o número alarmante de mortes nesses distritos. 

Nas séries históricas esmiuçadas tentamos enxergar possíveis tendências dos últimos dez anos de mortes no trânsito, alguns pontos merecem destaque. Apesar da série histórica ter ocilações importantes com a queda consistente nas mortes entre 2015, 2016 e 2017, depois a pandemia também derrubando bastante os números, em 2024 voltamos ao mesmo patamar alto de 2015, chama à atenção que desde 2022 estejamos apenas aumentando os números. Apesar de um declínio nos óbitos entre outubro, novembro e dezembro, em relação ao mesmo período do ano anterior, 2024 teve 10% a mais de óbitos do que 2023. É necessário manter o monitoramento de modo a verificar se essa tendência de queda é aleatória ou vai se manter em 2025. 

Ainda analisando séries históricas, o recorte de mortes por meio de locomoção da vítima nos mostrou que os pedestres não são mais as principais vítimas do trânsito, em 2019 esse cenário muda e os motociclistas ultrapssam essa marca. É possível que os serviços de entrega sejam um fator importante de explicação para esse dado, as políticas públicas devem se adequar a essa nova realidade, já que as mortes de motociclistas apresentam uma tendência clara de aumento. Depois do motociclista o pedestre é a maior vítima do trânsito da cidade, apresentando uma tendência geral de aumento das mortes desde 2021. O principal avanço dos últimos dez anos foi a queda no número de mortes dos usuários de carros, morreu-se 40% a menos em relação a 2015, isso pode estar associado ao aumento da segurança dos veículos mais modernos, mas que não tem tornado a vida dos outros meios de locomoção mais seguros, morreram 64% mais ciclistas em 2024 do que em 2015 e as mortes de pedestres diminuíram apenas 13%. 

Divindindo a cidade em macroregiões (norte, sul, leste, oeste e centro) para analisar o número absoluto de mortes nos últimos dez anos é clara a deterioraçǎo do trânsito na zona sul da cidade. Esta é, não apenas a zona com mais mortes, como também a única em que as mortes aumentaram em 2024 em relação a 2015, cerca de 12% de aumento, e esse aumento não é pontual, as mortes vem aumentando desde 2021 de forma consistente. O destaque de melhora no volume de mortes é para a região central, que apresentou queda de 60% em 2024 em relação a 2015. 

Também analisamos os distritos mais perigosos para pedestres, motociclistas, usuários de automóveis e ciclistas, a partir da taxa de mortos por 100 mil habitantes. Alguns pontos relevantes dessa análise é que a Sé é uma região muito perigosa para os pedestres, de forma bem desproporcional em relação aos outros distritos, Jaraguá segue sendo o distrito mais periogoso para motociclistas e usuários de automóveis enquando o Brás é o distrito mais periogoso para os ciclistas. 

Na análise a respeito das cartacterísticas dos acidentes olhamos para dois aspectos, o tipo de acidente mais frequente e os veículos mais frequentemente envolvidos no acidente. Enquanto automóveis, motocicletas e ônibus sofrem mais com o choque, pedestres são atropelados, ciclistas sofrem mais com tombamento e caminhões com colisão traseira. E como já era esperado o automóvel está envolvido na maior parte dos acidentes, independente do meio de locomoção da vítima, exceto no caso de caminhões. 

Por fim, a análise das avenidas com mais mortes confirmou a zona sul como a mais letal, mostrando a Av. Senador Teotônio Vilela como grande fonte de mortes principalmente para motociclistas e pedestres nos últimos dez anos. 

De forma geral o trânsito de São Paulo tem sido letal principalmente para pedestres e motociclistas. A partir dessa análise elucidamos os pontos críticos de cada região de São Paulo e esperamos que esse relatório proporcione acesso facilitado à visualização dos dados do Infosiga e ajude a encaminhar melhor às políticas relacionadas ao trânsito na cidade de São Paulo.    


## **Referências**

-  Dados Abertos Infosiga: https://www.infosiga.sp.gov.br/#referencia
-  BEZERRA, G. M., FERREIRA, A. F., MACHADO, S. T. Acidentes de Trânsito: um perfil dos envolvidos na Cidade de São Paulo. Revista Fatec Zona Sul, 2023. 
-  IPEA – INSTITUTO DE PESQUISA ECONÔMICA APLICADA. Estimativas dos custos dos acidentes de trânsito no Brasil com base na atualização simplificada das pesquisas anteriores do Ipea. Brasília: Ipea, 2015. (Relatório de Pesquisa).
-  IPEA – INSTITUTO DE PESQUISA ECONÔMICA APLICADA. Impactos sociais e econômicos dos acidentes de trânsito nas rodovias brasileiras: relatório executivo. Brasília: Ipea; Denatran; ANTP, 2006.
-  IPEA – INSTITUTO DE PESQUISA ECONÔMICA APLICADA. Balanço da Primeira Década de Ação pela Segurança no Trânsito no Brasil e Perspectivas para a Ssegunda Década: Nota Técnica, 2023. 
-  IBGE – INSTITUTO BRASILEIRO DE GEOGRAFIA E ESTATÍSTICA. Pesquisa Nacional por Amostra de Domicílios: síntese de indicadores 2022.
-  ONU – ORGANIZAÇÃO DAS NAÇÕES UNIDAS. Resolução A/RES/64/255, de 2 de março de 2010.[s.l.]: ONU, 2010. 
-  Lei Federal nº 13.614/18: https://legislacao.presidencia.gov.br/atos/?tipo=LEI&numero=13614&ano=2018&ato=e6ao3aq1UeZpWTea1

## **Nota Técnica**

Para a elaboração da análise das avenidas com mais mortes, foi realizada a operação espacial de área de cobertura (Buffer) com parâmetros de 30 metros, uma vez que a representação espacial de ruas e avenidas no município de São Paulo é feita por meio de linhas. Em seguida, foram selecionados os pontos georreferenciados dos locais de morte no trânsito que estivessem dentro do buffer de 30 metros das ruas e avenidas, e realizada a operação 'Unir atributos pelo mais próximo' no software QGIS.
A projeção utilizada foi a SIRGAS 2000, no sistema de coordenadas Universal Transversal de Mercator (UTM), zona 23 Sul. 

&nbsp;
<hr />
<p style="text-align: center;">
  <strong>Equipe Técnica:</strong> <br />
  Caio Estevam Santana Silva <br />
  Hugo Nicolau Barbosa de Gusmão <br />
  Joaquim Lemos Ornellas <br />
  Luiza Mayare Reis Soares <br />
  Robson Cesar Zanovelo <br />
  Thais Fernandes Pereira
</p>

<p style="text-align: center;">
  <span style="color: #2F58A4;">
    <em>Relatório Executivo <br /> ADE SAMPA - 2025</em>
  </span>
</p>

&nbsp;









