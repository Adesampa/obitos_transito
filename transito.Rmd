---
title: Análise das Mortes no Trânsito no Município de São Paulo
author: "Agência São Paulo de Desenvolvimento - ADE SAMPA"
date: "`r format(Sys.Date(), format='%d/%m/%Y')`"
output:
    html_document:
      theme: flatly
      self-contained: yes
      toc: yes
      toc_float: yes
      css: 
        - style.css
editor_options: 
  markdown: 
    wrap: 72
---


```{r setup, include=FALSE}

(knitr::opts_chunk$set(
	echo = FALSE,
	error = FALSE,
	message = FALSE,
	warning = FALSE
 )
) 
```


```{r}

library("ggpubr")
library("tidyverse")
library("kableExtra")
library("knitr")
library("tidylog")
library("readxl")
library("geobr")
library("sf")
library("wesanderson")
library("ggplot2")
library("stringr")
library ("abjData")
library("extrafont")
library("lubridate")
library("transformr")
library("reactable")
library("rnaturalearth")
library("plotly")
library("ggrepel")
library('googlesheets4')
library("leaflet")
library('ggthemes')
library('rmdformats')
library("janitor")
library("reactablefmtr")
library("corrplot")
library("lubridate")
library("janitor")
library("ggmap")
library("stringr")
library("stringi")
library("ggthemes")
library("ggiraph")
library("patchwork")
library("showtext")

```



```{r include=FALSE}

# dowwnload dos dados do infosiga (https://www.infosiga.sp.gov.br/)


dados <- st_read("C:/Users/Thais Pereira/Documents/obitos_transito/obitos.csv")

shp_distritos <- st_read("C:/Users/Thais Pereira/Documents/shapefile/distritos_cnpj_2.shp")

```

```{r include=FALSE}

# Adicionar a fonte do Google Fonts
font_add_google("Lora", "Lora")

# Ativar suporte a fontes no ggplot
showtext_auto()


```

## **Resumo**


Esse relatório proprõe uma análise geoespacial detalhada dos dados de mortes no transito no município de São Paulo entre os anos de 2015 e 2024, a partir dos dados disponibilizados pelo INFOSIGA SP - Sistema de Informações Gerenciais de Acidentes de Trânsito do Estado de São Paulo. Pretendemos contribuir com uma análise que identifica um perfil da população vitimada pelos acidentes além de situações e modais de risco para cada distrito da cidade. Pretendemos contribuir com o desenvolvimento de políticas públicas baseadas em evidências das especificidades de cada região da cidade de São Paulo. 

## **Introdução**

Lançado em 2015, o INFOSIGA faz parte de um conjunto de iniciativas do Movimento Paulista de Segurança no Trânsito, lançado pelo Governo do estado de São Paulo em agosto de 2015, que tinha por objetivo reduzir pela metade as vítimas fatais em acidentes de trânsito até 2020. A meta estadual estava na época, inspirada pela resolução de março de 2010 da Assembleia-Geral das Nações Unidas, definida como “Primeira década de ação pela segurança no trânsito". A campanha tinha por objetivo conscientizar os países a adotarem medidas visando a diminuição dos números de mortalidade no trânsito, e de fato mobilizou as autoridades de diversos países, a do Brasil inclusive, que se posicionou como país signatário da iniciativa, com engajamentos diversificados por parte dos gestores de transito. Ao final da primeira década a ONU lançou em 2021 a “segunda década de ação pela segurança no trânsito” incentivando os países a estipularem novas metas para 2030. 

A situação é complicada no mundo todo, segundo dados da OMS de 2022, 1,3 milhão de pessoas morrem anualmente em acidentes de trânsito, o que supera em número de mortos doenças como o HIV/AIDS, tuberculose e doenças diarreicas, sendo esta a 8ª causa do maior número de mortes no mundo (WHO, 2018).

Em termos proporcionais à população, o Brasil tem dados alarmantes, o número de mortos por 100 mil habitantes anualmente é cerca de dez vezes maior que nos países mais seguros (IPEA, 2006, 2015), e na época do lançamento da primeira campanha da ONU eramos o quinto pais com mais mortes no transito no mundo, gerando um custo anual de cerca de de R$ 50 bilhões a preços atuais (IPEA, 2023).   

O INFOSIGA surge como uma ferramenta que possibilita a transparência das informações e o subsídio ao desenvolvimento de políticas públicas de prevenção baseado em evidências. Os dados dispobilizados mensalmente são baseados na sistematização de boletins de ocorrência da Polícia Civil do Estado de São Paulo, para o cálculo das estatísticas relativas a óbitos no transito, além dos dados que serão analisados neste relatório a plataforma INFOSIGA também disponibiliza informações de acidentes de transito com vítimas, utilizando os dados recebidos pela Polícia Militar e Polícia Rodoviária Federal.

No âmbito nacional a Lei Federal nº 13.614/18 assinada em 11 de janeiro de 2018 criou o Plano Nacional de Redução de Mortes e Lesões no Trânsito (Pnatrans), com uma série de diretrizes que visam a diminuição de mortes e lesões causadas por acidentes de trânsito. O principal objetivo é diminuir a proporção de mortos em relação à população e em relação ao número de veículos de uma localidade num prazo de dez anos. 

Tendo em vista a demonstração de preocupação por parte das autoridades federais e estatuais no que diz respeito às mortes no transito, propomos primeiramente uma análise geral da situação dos óbitos nos distritos da cidade de São Paulo, depois uma análise temporal para identificarmos mudanças e tendências gerais e por último uma análise geoespacial detalhada da população, modais de risco para cada uma dessas regiões da cidade de São Paulo, buscando sistematizar informações que podem direcionar a tomada de decisão do poder público.  


## **Estatísticas Gerais**


## 1. Mapa por distrito de todas as mortes do município


```{r include=FALSE}

dados_1 <- dados %>% 
  filter(!is.na(ds_nome)) %>% 
  clean_names() %>% 
  group_by(ds_nome) %>% 
  tally() %>% 
  mutate(ds_nome = str_to_title(ds_nome)) %>% 
  mutate(pct = n/sum(n)*100)

# Transformar em coordenadas geográficas
shp_distritos <- st_transform(shp_distritos, crs = 4326)

shp_distritos <- shp_distritos %>% rename(ds_nome = NOME_DIST)

shp_distritos_1 <- shp_distritos %>% mutate(
    Indice = as.character(row_number()),
    ds_nome = str_trim(ds_nome),  
    ds_nome = stri_trans_general(ds_nome, "Latin-ASCII"), 
    ds_nome = str_to_title(ds_nome)  
  ) %>% 
  mutate(
    ds_nome = case_when(
      ds_nome == "Agua Rasa\n" ~ "Agua Rasa",
      ds_nome == "Alto De Pinheiros\n" ~ "Alto De Pinheiros",
      ds_nome == "Anhanguera\n" ~ "Anhanguera",
      TRUE ~ ds_nome
    )
  )

shp_distritos_2 <- shp_distritos_1 %>%
  left_join(dados_1, by = "ds_nome")


```



```{r echo=FALSE, fig.width=11, fig.height=9, out.width="100%"}

# Criar categorias de óbitos
shp_distritos_3 <- shp_distritos_2 %>%
  mutate(group_n = cut(n, breaks = c(0, 50, 100, 150, 200, 250), include.lowest = TRUE))

# Criar categorias para o gráfico lateral
pop_n <- shp_distritos_3 %>%
  st_drop_geometry() %>%
  group_by(group_n) %>%
  summarise(score = sum(n, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_n)
  ) %>%
  na.omit()


# Criar o mapa com os distritos de São Paulo e os óbitos
pmap <- ggplot(shp_distritos_3) +
  geom_sf_interactive(aes(fill = n, geometry = geometry, 
                          data_id = group_n, 
                          tooltip = paste(ds_nome, "<br>Óbitos:", n)),  # Nome + Óbitos
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "Óbitos",
    breaks = c(50, 100, 150, 200, 250),
    direction = 1,
    palette = "Reds"
  ) +
  labs(
    title = "",
    subtitle = "",
    caption = "Fonte: Infosiga"
  ) +
  theme_map() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = 14, hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  ) + 
  guides(fill = "none")

# Criar o gráfico de barras laterais com os percentuais
x_labels <- c("0-50", "51-100", "101-150", "151-200", "201-250+")

pcol <- ggplot(pop_n, aes(group_n, share, fill = group_n)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
    geom_text_interactive(
    aes(
      y = pmin(share + 5, max(share) - 2),  # Impede que o texto saia do gráfico
      label = label, 
      color = case_when(
        group_n == "201-250+" ~ "black",  # Apenas essa categoria ficará preta
        TRUE ~ "white"
      ), 
      data_id = data_id
    ),
    size = 4, 
    hjust = -0.1 # Mantém os textos afastados para a direita
  ) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 18),
    axis.text.y = element_text(size = 10),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_n$share) + 18)

# Aplicar ao gráfico
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora")) +
  coord_sf(expand = FALSE) +  # Evita cortes no mapa
  theme_void() 


# Combinar o mapa e o gráfico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)

# Criar um gráfico interativo com ggiraph
interactive_plot <- girafe(
  ggobj = p_final,
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)

# Salvar como HTML interativo
htmltools::save_html(interactive_plot, "mapa_interativo.html")

# Exibir o gráfico no RStudio Viewer
interactive_plot

```



## **Quantidade de mortes ao longo do Tempo**


## **Análise Socio econômica**


## **Análise por Distrito**


## **Considerações Finais**


## **Referências**













