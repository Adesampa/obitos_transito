---
title: An√°lise das Mortes no Tr√¢nsito no Munic√≠pio de S√£o Paulo \n Relat√≥rio Executivo
author: "Ag√™ncia S√£o Paulo de Desenvolvimento - ADE SAMPA"
date: "`r format(Sys.Date(), format='%d/%m/%Y')`"
output:
    html_document: 
      theme: flatly
      self-contained: true
      toc: true
      toc_float: true
      css: style.css
editor_options: 
  markdown: 
    wrap: 72
  chunk_output_type: inline
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(global.par = TRUE)
knitr::opts_knit$set(globalenv = TRUE)

(knitr::opts_chunk$set(
	echo = FALSE,
	error = FALSE,
	message = FALSE,
	warning = FALSE
 )
)


```


```{r}

library("ggpubr")
library("tidyverse")
library("kableExtra")
library("knitr")
library("tidylog")
library("readxl")
library("geobr")
library("sf")
library("wesanderson")
library("ggplot2")
library("stringr")
library ("abjData")
library("extrafont")
library("lubridate")
library("transformr")
library("reactable")
library("rnaturalearth")
library("plotly")
library("ggrepel")
library('googlesheets4')
library("leaflet")
library('ggthemes')
library('rmdformats')
library("janitor")
library("reactablefmtr")
library("corrplot")
library("lubridate")
library("janitor")
library("ggmap")
library("stringr")
library("stringi")
library("ggthemes")
library("ggiraph")
library("patchwork")
library("showtext")
library("htmltools")
library("gganimate")
library("gifski")
library("av")
library("scales")
library("png")
library("magick")
library("ggtext")
library("waffle")
library("MetBrewer")
library("dplyr")
library("glue")
library("marquee")
library("geobr")

```



```{r include=FALSE}

# dowwnload dos dados do infosiga (https://www.infosiga.sp.gov.br/)


dados <- read_csv("C:/Users/Thais Pereira/Documents/obitos_transito/obitos.csv", locale = locale(encoding = "UTF-8"))

dados_estado <- read_excel("C:/Users/Thais Pereira/Documents/obitos_transito/obitos_todos.xlsx")

dados_logadouro <- read_csv("C:/Users/Thais Pereira/Documents/obitos_transito/obitos_logadouro.csv", locale = locale(encoding = "UTF-8"))

shp_distritos <- st_read("C:/Users/Thais Pereira/Documents/shapefile/distritos_cnpj_2.shp")

pop <- read_excel("C:/Users/Thais Pereira/Documents/obitos_transito/pop.xlsx")

pop_estado <- read_excel("C:/Users/Thais Pereira/Documents/obitos_transito/pop_estado.xlsx")

```






```{r  include=FALSE}

# Adicionar a fonte do Google Fonts
font_add_google("Lora", "Lora")

# Ativar suporte a fontes no ggplot
showtext_auto()

dados_filtrados <- dados %>%
   mutate(`Data do Sinistro` = dmy(`Data do Sinistro`),  
   Ano = year(`Data do Sinistro`), 
   Mes = month(`Data do Sinistro`)) %>% 
   mutate(Mes = factor(Mes, levels = 1:12, labels = c("jan", "fev", "mar", "abr", "mai", "jun",
                                                     "jul", "ago", "set", "out", "nov", "dez"))) %>% 
   filter(!Ano %in% c(2012, 2013, 2014, 2010, 1995, 1986, 2000, 2009, 2011)) %>% 
   rename(locomocao = `Meio de locomo√ß√£o da v√≠tima`) %>% 
   dplyr::mutate(ds_nome = stringr::str_to_title(ds_nome)) %>% 
   left_join(pop, by = "ds_nome")

dados_locomocao <- dados_filtrados %>%
   dplyr::filter(locomocao != "NAO DISPONIVEL" & locomocao != "OUTROS") %>%
  dplyr::mutate(locomocao = stringr::str_to_title(locomocao)) %>% 
   dplyr::group_by(Ano, locomocao) %>%
   dplyr::tally()

mortes_regiao <- dados_filtrados %>% 
  filter(!is.na(ds_nome)) %>% 
  group_by(Ano, regiao) %>% 
  tally()

```

## **Resumo**


Esse relat√≥rio propr√µe uma an√°lise geoespacial detalhada dos dados de mortes no transito no munic√≠pio de S√£o Paulo entre os anos de 2015 e 2024, a partir dos dados disponibilizados pelo INFOSIGA SP - Sistema de Informa√ß√µes Gerenciais de Acidentes de Tr√¢nsito do Estado de S√£o Paulo. Pretendemos contribuir com uma an√°lise que identifica um perfil da popula√ß√£o vitimada pelos acidentes al√©m de situa√ß√µes e modais de risco para cada distrito da cidade. Pretendemos contribuir com o desenvolvimento de pol√≠ticas p√∫blicas baseadas em evid√™ncias das especificidades de cada regi√£o da cidade de S√£o Paulo. 

## **Introdu√ß√£o**

Lan√ßado em 2015, o INFOSIGA faz parte de um conjunto de iniciativas do Movimento Paulista de Seguran√ßa no Tr√¢nsito, lan√ßado pelo Governo do estado de S√£o Paulo em agosto de 2015, que tinha por objetivo reduzir pela metade as v√≠timas fatais em acidentes de tr√¢nsito at√© 2020. A meta estadual estava na √©poca, inspirada pela resolu√ß√£o de mar√ßo de 2010 da Assembleia-Geral das Na√ß√µes Unidas, definida como ‚ÄúPrimeira d√©cada de a√ß√£o pela seguran√ßa no tr√¢nsito". A campanha tinha por objetivo conscientizar os pa√≠ses a adotarem medidas visando a diminui√ß√£o dos n√∫meros de mortalidade no tr√¢nsito, e de fato mobilizou as autoridades de diversos pa√≠ses, a do Brasil inclusive, que se posicionou como pa√≠s signat√°rio da iniciativa, com engajamentos diversificados por parte dos gestores de transito. Ao final da primeira d√©cada a ONU lan√ßou em 2021 a ‚Äúsegunda d√©cada de a√ß√£o pela seguran√ßa no tr√¢nsito‚Äù incentivando os pa√≠ses a estipularem novas metas para 2030. 

A situa√ß√£o √© complicada no mundo todo, segundo dados da OMS de 2022, 1,3 milh√£o de pessoas morrem anualmente em acidentes de tr√¢nsito, o que supera em n√∫mero de mortos doen√ßas como o HIV/AIDS, tuberculose e doen√ßas diarreicas, sendo esta a 8¬™ causa do maior n√∫mero de mortes no mundo (WHO, 2018).

Em termos proporcionais √† popula√ß√£o, o Brasil tem dados alarmantes, o n√∫mero de mortos por 100 mil habitantes anualmente √© cerca de dez vezes maior que nos pa√≠ses mais seguros (IPEA, 2006, 2015), e na √©poca do lan√ßamento da primeira campanha da ONU eramos o quinto pais com mais mortes no transito no mundo, gerando um custo anual de cerca de de R$ 50 bilh√µes a pre√ßos atuais (IPEA, 2023).   

O INFOSIGA surge como uma ferramenta que possibilita a transpar√™ncia das informa√ß√µes e o subs√≠dio ao desenvolvimento de pol√≠ticas p√∫blicas de preven√ß√£o baseado em evid√™ncias. Os dados dispobilizados mensalmente s√£o baseados na sistematiza√ß√£o de boletins de ocorr√™ncia da Pol√≠cia Civil do Estado de S√£o Paulo, para o c√°lculo das estat√≠sticas relativas a √≥bitos no transito, al√©m dos dados que ser√£o analisados neste relat√≥rio a plataforma INFOSIGA tamb√©m disponibiliza informa√ß√µes de acidentes de transito com v√≠timas, utilizando os dados recebidos pela Pol√≠cia Militar e Pol√≠cia Rodovi√°ria Federal.

No √¢mbito nacional a Lei Federal n¬∫ 13.614/18 assinada em 11 de janeiro de 2018 criou o Plano Nacional de Redu√ß√£o de Mortes e Les√µes no Tr√¢nsito (Pnatrans), com uma s√©rie de diretrizes que visam a diminui√ß√£o de mortes e les√µes causadas por acidentes de tr√¢nsito. O principal objetivo √© diminuir a propor√ß√£o de mortos em rela√ß√£o √† popula√ß√£o e em rela√ß√£o ao n√∫mero de ve√≠culos de uma localidade num prazo de dez anos. 

Tendo em vista a demonstra√ß√£o de preocupa√ß√£o por parte das autoridades federais e estatuais no que diz respeito √†s mortes no transito, propomos primeiramente uma an√°lise geral da situa√ß√£o dos √≥bitos nos distritos da cidade de S√£o Paulo, depois uma an√°lise temporal para identificarmos mudan√ßas e tend√™ncias gerais e por √∫ltimo uma an√°lise geoespacial detalhada da popula√ß√£o, modais de risco para cada uma dessas regi√µes da cidade de S√£o Paulo, buscando sistematizar informa√ß√µes que podem direcionar a tomada de decis√£o do poder p√∫blico.  


## **Estat√≠sticas Gerais**

Mapa das mortes nos munic√≠pios do Estado de S√£o Paulo


```{r include=FALSE}

# Substituir nomes espec√≠ficos
substituicoes <- c(
  "Santa Barbara D Oeste" = "Santa Barbara dOeste",
  "Estrela D Oeste" = "Estrela dOeste",
  "Aparecida D Oeste" = "Aparecida dOeste",
  "Guarani D Oeste" = "Guarani dOeste",
  "Sao Joao Do Pau D Alho" = "Sao Joao do Pau dAlho",
  "Guarani D'oeste" = "Guarani dOeste",
  "Palmeira D'oeste" = "Palmeira dOeste",
  "Santa Rita D Oeste" = "Santa Rita dOeste",
  "Palmeira D Oeste" =	"Palmeira dOeste",		
  "Sao Luis do Paraitinga" =	"Sao Luiz do Paraitinga",
  "Santa Clara D Oeste" = "Santa Clara dOeste"
)

# Download dos Estados e Munic√≠pios: 

muni_geobr <- read_municipality(code_muni= 35, year=2020) %>%  as.tibble()

geo_ufs <- read_state(code_state = 35, year = 2020) %>% as.tibble()

pop_estado_1 <- pop_estado %>% 
  mutate(
    Munic√≠pio = str_trim(Mun),  
    Munic√≠pio = stri_trans_general(Munic√≠pio, "Latin-ASCII")) %>%
  filter(UF == "SP") %>% 
  select(CodMun,Munic√≠pio, PopMun)

dados_estados_1 <-  dados_estado %>% 
  mutate(Munic√≠pio = stringr::str_to_title(Munic√≠pio)) %>%
  mutate(Munic√≠pio = str_replace_all(Munic√≠pio, substituicoes)) %>% 
  mutate(Munic√≠pio = str_replace_all(Munic√≠pio, "\\b(Do|De|Dos|Das|Da)\\b", tolower)) %>% 
  mutate(Munic√≠pio = case_when(Munic√≠pio == "Sao Luis do Paraitinga" ~ "Sao Luiz do Paraitinga", TRUE ~ Munic√≠pio)) 
  

dados_mapa <-  pop_estado_1 %>% 
  left_join(dados_estados_1, by = "Munic√≠pio") %>% 
  group_by(CodMun, Munic√≠pio, PopMun) %>% 
  tally() %>% 
  mutate(mortes_cem_mil_hab = n/PopMun*100000) %>% 
  rename(code_muni = CodMun) %>% 
  left_join(muni_geobr, by = "code_muni") 
  

# Convertendo dados_mapa para um objeto sf

  dados_mapa_2 <- st_as_sf(dados_mapa)
  
 

```


```{r echo=FALSE}


# Criar categorias de √≥bitos por 100 mil habitantes
dados_mapa_2 <- dados_mapa_2 %>%
  mutate(
    group_mortes = cut(mortes_cem_mil_hab, 
                       breaks = c(27, 100, 200, 300, 500, 1020),  # Ajuste conforme a varia√ß√£o dos dados
                       include.lowest = TRUE)
  )

# Criar categorias para o gr√°fico lateral
pop_mortes <- dados_mapa_2 %>%
  st_drop_geometry() %>%
  group_by(group_mortes) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes)
  ) %>%
  na.omit()

# Criar o mapa interativo
pmap <- ggplot(dados_mapa_2) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geom, 
                          data_id = group_mortes, 
                          tooltip = paste(Munic√≠pio, "<br>√ìbitos por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "√ìbitos por 100k",
    breaks = c(100, 200, 300, 500, 1020),
    direction = 1,
    palette = "Reds"
  ) +
  theme_void() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = 14, hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(size = 12, hjust = 0.5)
  ) +  guides(fill = "none")

pmap <- pmap + 
  coord_sf(expand = FALSE) + 
  theme_void() + 
  theme(
    plot.margin = unit(c(100, 50, -10, 10), "pt"))

# Criar o gr√°fico de barras laterais com os percentuais
x_labels <- c("27-100", "101-200", "201-300", "301-500", "501-1018+")

pcol <- ggplot(pop_mortes, aes(group_mortes, share, fill = group_mortes)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
    aes(
      y = pmin(share + 5, max(share) - 2),  
      label = label, 
      color = case_when(
        group_mortes == "501-1018+" ~ "black",
        TRUE ~ "white"
      ), 
      data_id = data_id
    ),
    size = 4, 
    hjust = -0.1
  ) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 10),
    axis.text.x = element_blank()
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 15)

# Ajustar fonte e evitar cortes no mapa
 pmap <- pmap + coord_sf(expand = FALSE) +
  annotate("text", 
           x = mean(st_bbox(dados_mapa_2)[c("xmin", "xmax")]),  
           y = st_bbox(dados_mapa_2)["ymax"] + 0.05 * diff(st_bbox(dados_mapa_2)[c("ymin", "ymax")]),  
            label = "Taxa de mortes por 100k habitantes",
           hjust = 0.5, vjust = 1, size = 5, fontface = "bold", family = "Lora")

# Combinar o mapa e o gr√°fico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.7, bottom = 0.05, right = 1, top = 0.2)

# Criar um gr√°fico interativo com ggiraph
interactive_plot <- girafe(
  ggobj = p_final,
  width_svg = 10,  
  height_svg = 8,
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)

# Exibir o gr√°fico interativo
interactive_plot


```




Mapas das mortes por distritos 

Os mapas apresentados abaixo mostram a distribui√ß√£o das mortes no tr√¢nsito na cidade de S√£o Paulo, destacando tanto os n√∫meros absolutos quanto a taxa de √≥bitos por 100 mil habitantes. Tendo como base que segundo o IBGE S√£o Paulo contava em 2022 com 11.451.999 habitantes, e entre 2015 e 2024 a cidade somou um total de **9.216** mortes no tr√¢nsito, temos uma taxa geral de **80,5** mortes para cada 100 mil habitantes. Em termos absolutos, os distritos com maior n√∫mero de √≥bitos foram Jardim **Jardim Sao Luis (231)**, **Graja√∫ (229)** e **Cidade Dutra (196)**, enquanto os que registraram menos mortes foram **Marsilac (4)**, **Perdizes (21)** e **Bela Vista (26)**.

Quando analisamos os piores distritos em termos de taxa de mortalidade proporcional √† popula√ß√£o, os destaques negativos s√£o **S√© (314 mortes por 100 mil habitantes)**, **Jaragu√° (287)** e **Butant√£ (201)**, enquanto os distritos com menor impacto proporcional foram **Perdizes (20)**, **Jardim Helena (27)** e **Cidade L√≠der (33)**. 

Um adendo a utiliza√ß√£o da base de dados do Infogsiga √© que para 983 mortes n√£o foi poss√≠vel encontrar o distrito de acontecimento do acidente, ou por falta de informa√ß√µes de latitude e longitude ou por imprecis√£o do dado, no entanto somamos esse caso para as estat√≠sticas gerais. 



```{r include=FALSE}

dados_2 <- dados_filtrados %>% 
  filter(!is.na(ds_nome)) %>% 
  clean_names() %>% 
  group_by(ds_nome, pop) %>% 
  tally() %>% 
  mutate(pct = n/sum(n)*100) %>% 
  mutate(mortes_cem_mil_hab = n/pop*100000)

# Transformar em coordenadas geogr√°ficas
shp_distritos <- st_transform(shp_distritos, crs = 4326)

shp_distritos <- shp_distritos %>% rename(ds_nome = NOME_DIST)

shp_distritos_1 <- shp_distritos %>% mutate(
    Indice = as.character(row_number()),
    ds_nome = str_trim(ds_nome),  
    ds_nome = stri_trans_general(ds_nome, "Latin-ASCII"), 
    ds_nome = str_to_title(ds_nome)  
  ) %>% 
  mutate(
    ds_nome = case_when(
      ds_nome == "Agua Rasa\n" ~ "Agua Rasa",
      ds_nome == "Alto De Pinheiros\n" ~ "Alto De Pinheiros",
      ds_nome == "Anhanguera\n" ~ "Anhanguera",
      TRUE ~ ds_nome
    )
  )

shp_distritos_2 <- shp_distritos_1 %>%
  left_join(dados_2, by = "ds_nome")


```



```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}

theme_update(plot.title = element_text(size = 24, face = "bold", hjust = 0.5, family = "Lora"))

# Criar categorias de √≥bitos
shp_distritos_3 <- shp_distritos_2 %>%
  mutate(group_n = cut(n, breaks = c(0, 50, 100, 150, 200, 250), include.lowest = TRUE))

# Criar categorias para o gr√°fico lateral
pop_n <- shp_distritos_3 %>%
  st_drop_geometry() %>%
  group_by(group_n) %>%
  summarise(score = sum(n, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_n)
  ) %>%
  na.omit()


# Criar o mapa com os distritos de S√£o Paulo e os √≥bitos
pmap <- ggplot(shp_distritos_3) +
  geom_sf_interactive(aes(fill = n, geometry = geometry, 
                          data_id = group_n, 
                          tooltip = paste(ds_nome, "<br>√ìbitos:", n)),  # Nome + √ìbitos
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "√ìbitos",
    breaks = c(50, 100, 150, 200, 250),
    direction = 1,
    palette = "Reds"
  ) +
  labs(
    title = "",
    subtitle = "",
    caption = ""
  ) +
  theme_map() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = rel(2), hjust = 0.5, family = "Lora"),
    plot.caption = element_text(size = 25, hjust = 0.5, family = "Lora")
  ) + 
  guides(fill = "none")

# Criar o gr√°fico de barras laterais com os percentuais
x_labels <- c("0-50", "51-100", "101-150", "151-200", "201-250+")

pcol <- ggplot(pop_n, aes(group_n, share, fill = group_n)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
    geom_text_interactive(
    aes(
      y = pmin(share + 5, max(share) - 2),  # Impede que o texto saia do gr√°fico
      label = label, 
      color = case_when(
        group_n == "201-250+" ~ "black",  # Apenas essa categoria ficar√° preta
        TRUE ~ "white"
      ), 
      data_id = data_id
    ),
    size = 8, 
    hjust = -0.1 # Mant√©m os textos afastados para a direita
  ) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 18),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_n$share) + 30)

# Aplicar ao gr√°fico
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora")) +
  coord_sf(expand = FALSE) +  # Evita cortes no mapa
  theme_void() +
    annotate("text", 
           x = mean(st_bbox(shp_distritos_3)[c("xmin", "xmax")]),  # Centraliza no eixo X
           y = st_bbox(shp_distritos_3)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_3)[c("ymin", "ymax")]),  # Move para cima
           label = "Total absoluto de mortes",
           hjust = 0.5, vjust = 1, size = 12, fontface = "bold", family = "Lora")


# Combinar o mapa e o gr√°fico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)

# Criar um gr√°fico interativo com ggiraph
interactive_plot <- girafe(
  ggobj = p_final,
  width_svg = 14,   # Aumenta a largura do gr√°fico lateral
  height_svg = 12,
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)


```


```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}

theme_update(plot.title = element_text(size = 24, face = "bold", hjust = 0.5, family = "Lora"))

shp_distritos_3 <- shp_distritos_2 %>%
  mutate(group_mortes = cut(mortes_cem_mil_hab, 
                            breaks = quantile(mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE), 
                            include.lowest = TRUE))


# Criar categorias para o gr√°fico lateral (percentual de distritos por faixa)
pop_mortes <- shp_distritos_3 %>%
  st_drop_geometry() %>%
  group_by(group_mortes) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes)
  ) %>%
  na.omit()

# Criar o mapa com os distritos de S√£o Paulo e a taxa de √≥bitos
pmap <- ggplot(shp_distritos_3) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geometry, 
                          data_id = group_mortes, 
                          tooltip = paste(ds_nome, "<br>√ìbitos por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "√ìbitos por 100k",
    breaks = quantile(shp_distritos_3$mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE),
    direction = 1,
    palette = "Reds"
  ) +
  labs(
    title = "",
    subtitle = "",
    caption = ""
  ) +
  theme_map() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = rel(2), hjust = 0.5, family = "Lora"),
    plot.caption = element_text(size = 25, hjust = 0.5, family = "Lora")
  ) + 
  guides(fill = "none")

# Criar o gr√°fico de barras laterais com os percentuais de distritos por taxa de √≥bitos
x_labels <- c("Baixo", "M√©dio-Baixo", "M√©dio", "M√©dio-Alto", "Alto")

pcol <- ggplot(pop_mortes, aes(group_mortes, share, fill = group_mortes)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
  aes(
    y = pmin(share + 5, max(share) - 2),  
    label = paste0(round(share, 1), "%"),  
    color = case_when(
      as.character(group_mortes) == max(as.character(group_mortes)) ~ "black",  # Converte para caractere
      TRUE ~ "white"
    ), 
    data_id = data_id
  ),
  size = 8, 
  hjust = -0.1 
) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 30)

# Aplicar ao gr√°fico a fonte 'Lora' e evitar cortes
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora")
) + coord_sf(expand = FALSE) + theme_void() +
  annotate("text", 
           x = mean(st_bbox(shp_distritos_3)[c("xmin", "xmax")]),  # Centraliza no eixo X
           y = st_bbox(shp_distritos_3)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_3)[c("ymin", "ymax")]),  # Move para cima
           label = "Taxa de mortes por 100k hab.",
           hjust = 0.5, vjust = 1, size = 12, fontface = "bold", family = "Lora")


# Combinar o mapa e o gr√°fico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)


# Criar um gr√°fico interativo com ggiraph
interactive_plot_2 <- girafe(
  ggobj = p_final,
  width_svg = 14,   # Aumenta a largura do gr√°fico lateral
  height_svg = 12,   # Aumenta a altura do gr√°fico lateral
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)


```


```{r, echo=FALSE, fig.height= 14, fig.width=16, out.width="300%", results="asis"}
library(htmltools)

# Criar layout flex√≠vel para exibir os gr√°ficos lado a lado
htmltools::browsable(
  tags$div(
    style = "display: flex; justify-content: space-between; align-items: center; width: 100%;",
    
    # Mapa interativo (primeiro gr√°fico)
    tags$div(style = "width: 50%;", interactive_plot),  
    
    # Gr√°fico lateral interativo (segundo gr√°fico)
    tags$div(style = "width: 50%;", interactive_plot_2)  
  )
)



```

```{r include=FALSE}

# taxa de √≥bitos por 100k hab. e total de √≥bitos absolutos

dados_filtrados %>% 
  clean_names() %>% 
  group_by(ds_nome) %>% 
  tally() %>% 
  mutate(ds_nome = str_to_title(ds_nome)) %>% 
  left_join(pop, by = "ds_nome") %>% 
  summarise(
    total_obitos = sum(n, na.rm = TRUE),
    total_populacao = sum(pop, na.rm = TRUE),  
    taxa_obitos = (sum(n, na.rm = TRUE) / sum(pop, na.rm = TRUE)) * 100000
  )


```


## **Quantidade de mortes ao longo do Tempo**

O gr√°fico abaixo mostra a s√©rie hist√≥ria da quantidade absoluta de √≥bitos no transito de 2015 a 2024. Como podemos ver, os n√∫meros estavam numa tend√™ncia de queda entre **2015 (1131)**, **2016 (976)** e **2017 (886)**, estancionando em 2018 com **895** √≥bitos e voltando a cair novamente em 2019 com o saldo de **860** √≥bitos. A queda dr√°stica nas mortes em 2020 e 2021 podem estar associadas a pandemia de Covid-19, o isolamento social e ado√ß√£o de teletrabalho em muitos setores, mas voltam a subir em 2022, **24%** a mais em rela√ß√£o a 2021, depois **7%** a mais em 2023 e finalmente **10%** a mais em 2024, o maior n√∫mero desde 2016. Voltamos a patamares muito pr√≥ximos de 2015, uma diferen√ßa de **3%** a menos, apenas. 

O gr√°fico tamb√©m mostra os tr√™s distritos com mais √≥bitos em cada ano, dos 14 distritos que aparecem nessa estat√≠stica, 8 s√£o da zona sul (Grajau, Jardim Angela, Capao Redondo, Jardim Sao Luis, Cidade Ademar, Campo Limpo, Cidade Dutra, Parelheiros), 3 da zona norte (Jaragua, Pirituba, Jacana) e 3 da zona leste (Sapopemba, Itaquera, Cangaiba). Durante os dez anos da s√©rie hist√≥rica o distrito do Grajau apareceu em 7 deles no topo do ranking, 2015, 2016, 2017 e 2019, voltando a patamares semelhantes nos √∫ltimos 3 anos (2022, 2023 e 2024). Lembrando que o grajau tamb√©m √© o distrito com maior popula√ß√£o na cidade de S√£o Paulo (384.873 habitantes segundo censo de 2022). Para efeito de compara√ß√£o o distrito do Jardim Angela, apesar de popula√ß√£o parecida (311.432) s√≥ apareceu entre os tr√™s distritos com mais √≥bitos em 2016. 


```{r fig.align = 'center',  fig.height= 4, fig.width=10, out.width = "80%"}

# Obter os 3 distritos com mais mortes por ano
top3_distritos <- dados_filtrados %>% 
   filter(!is.na(ds_nome)) %>% 
   group_by(Ano, ds_nome) %>%  
   tally() %>% 
   arrange(Ano, desc(n)) %>%  
   group_by(Ano) %>% 
   slice(1:3) %>%  
   summarise(Top_Distritos = paste(ds_nome, collapse = ", "), .groups = "drop") 


# base de dados para o gr√°fico
dados_filtrados_1 <- dados_filtrados %>% 
  group_by(Ano) %>% 
  tally() %>% 
  left_join(top3_distritos, by = "Ano")


# Criar o gr√°fico interativo com Plotly
grafico_interativo <- ggplot(dados_filtrados_1, aes(x = Ano, y = n, text = paste0(
  "Ano: ", Ano, "<br>",
  "Mortes: ", n, "<br>",
  "Top Distritos: ", Top_Distritos
))) +
  geom_line(color = "#f86254") +
  geom_point(color = "#f86254", size = 4, alpha = 0.7) +
  labs(title = "Evolu√ß√£o das Mortes no Tr√¢nsito",
       subtitle = "N√∫mero absoluto de √≥bitos no tr√¢nsito de 2015 a 2024",
       x = "",
       y = "") +
  scale_x_continuous(breaks = seq(2015, 2024, 1)) +  # Garante que todos os anos aparecem
  theme_minimal() +
  geom_label(aes(label = n), vjust = -0.5, fill = "white", color = "black", family = "Lora", size = 4)+
  theme(plot.title = element_text(family = "Lora", size = 10, face = "bold", hjust = 0.5, colour = "black"),
        plot.subtitle = element_text(family = "Lora", size = 14, hjust = 0.5, colour = "gray30"),
        text = element_text(family = "Lora"),
        axis.text = element_text(size = 10),
        axis.text.x = element_text(size = 9),
        legend.position = "none")

# Converter para Plotly para adicionar interatividade
grafico_interativo_plotly <- ggplotly(grafico_interativo, tooltip = "text")

# Exibir o gr√°fico interativo
grafico_interativo_plotly

```

No gr√°fico abaixo analisamos os √∫ltimos dois anos, m√™s a m√™s, para entender se existe alguma tend√™ncia geral de queda ou aumento nas mortes no transito. Sabemos que em 2024 as mortes aumentaram  **10%** em rela√ß√£o ao ano anterior, mas o que mais chama √† aten√ß√£o neste gr√°fico s√£o os meses de mar√ßo, abril, maio, junho e julho de 2024, eles representam juntos **46%** a mais de mortes em rela√ß√£o aos mesmo per√≠odo do ano anterior. A partir de setembro temos uma pequena tend√™ncia de queda no n√∫mero de √≥bitos, que s√£o menores em rela√ß√£o ao mesmo per√≠odo do ano anterior, em outubro, novembro e dezembro tivemos **18%** a menos de √≥bitos do que no mesmo per√≠odo do ano anterior. De qualquer modo, ainda n√£o √© poss√≠vel dizer que h√° uma tend√™ncia clara de queda no n√∫mero de √≥bitos ao longo do √∫ltimo ano, mesmo comparativamente com 2023.  


```{r fig.align = 'center',  fig.height= 4, fig.width=10, out.width = "80%"}

titulo <- glue("Evolu√ß√£o das Mortes no Tr√¢nsito nos √öltimos 2 anos, M√™s a M√™s \n <b style='color:#183047;'>2023</b> e <b style='color:#56B1F7;'>2024</b>")

# base de dados para o gr√°fico
dados_filtrados_1 <- dados_filtrados %>% 
  group_by(Ano, Mes) %>% 
  tally() %>% 
  left_join(top3_distritos, by = "Ano") %>% 
  filter(Ano == 2023 | Ano == 2024)


# Criar o gr√°fico interativo com Plotly
grafico_interativo <- ggplot(dados_filtrados_1, aes(x = Mes, y = n, color = Ano, group = Ano, text = paste0(
  "Mes: ", Mes, "<br>",
  "Ano: ", Ano, "<br>",
  "Mortes: ", n, "<br>"
))) +
  geom_line() +
  geom_point(size = 4, alpha = 0.7) +
  MetBrewer::scale_fill_met_d("Redon", direction=1)+
  labs(title = titulo,
       x = "",
       y = "") +
#  scale_x_continuous(breaks = seq(2015, 2024, 1)) +  # Garante que todos os anos aparecem
  theme_minimal() +
  geom_label(aes(label = n), vjust = -0.5, fill = "white", color = "black", family = "Lora", size = 4)+
  theme(plot.title = element_text(family = "Lora", size = 10, face = "bold", hjust = 0.5, colour = "black"),
        plot.subtitle = element_text(family = "Lora", size = 14, hjust = 0.5, colour = "gray30"),
        text = element_text(family = "Lora"),
        axis.text = element_text(size = 10),
        axis.text.x = element_text(size = 9),
        legend.position = "none")

# Converter para Plotly para adicionar interatividade
grafico_interativo_plotly <- ggplotly(grafico_interativo, tooltip = "text")

# Exibir o gr√°fico interativo
grafico_interativo_plotly

```



O gr√°fico abaixo tamb√©m apresenta uma s√©rie hist√≥rica mas com a evolu√ß√£o das mortes por meio de locomo√ß√£o da v√≠tima. O que mais chama aten√ß√£o neste gr√°fico √© que, se at√© 2019 os pedestres eram as principais v√≠timas do transito na cidade, esse cen√°rio mudou e os motociclistas assumiram essa posi√ß√£o. Desde 2020 o n√∫mero de √≥bitos de motociclistas apenas aumentou, alcan√ßando o patamar mais alto em 2024, com **496 √≥bitos**, um aumento de **38%** em rela√ß√£o a 2015.  

√â alarmante tamb√©m que as v√≠timas pedestres, apesar de deca√≠rem em 2020, prrovavelmente devido a pandemia de Covid-19, tamb√©m s√≥ aumentaram desde 2021. Desde ent√£o Presenciamos um aumento de **42%** em 2022 em rela√ß√£o a 2021, e esse n√∫meros continuaram crescendo, em 2023 foram **12%** a mais e em 2024 **7%** a mais que no ano anterior. Os anos com mais mortes de pedestres foram: 2015 com **468** √≥bitos, 2016 com **406** √≥bitos e 2024 com **405**. Se comprado a 2015, em 2024 as mortes dimiu√≠ram em **13%**. 

As mortes de ocupantes de autom√≥veis vinha caindo de forma expressiva desde 2015 at√© voltarem a crescer em 2018 e estacionarem em n√∫meros homog√™neos at√© um crescimento de **19%** em 2023 e uma queda de **12%** em 2024. Se comprado a 2015, em 2024 as mortes dimiu√≠ram em **40%**. 

As mortes de ciclistas tamb√©m ca√≠ram de forma expressiva entre 2017 e 2018 (**35%**), continuaram subindo at√© 2021, quando ca√≠ram novamente **21%** e voltam a crescer alcan√ßando o maior patamar da s√©rie hist√≥rica em 2024, um aumento de **64%** em rela√ß√£o a 2015. 

As mortes de ocupantes de caminh√£o vinham caindo consistentemente desde 2015, quando subiu drasticamente em 2019 (**2** para 14 mortes entre 2018 e 2019), e desde 2022 vem subindo novamente, 2024 alcan√ßou o patamar mais alto desde 2015, com **17** mortes. 

Por fim, o meio de transporte menos letal, o √¥nibus, desde uma subida nos n√∫meros em 2017, tem se apresentado relativamente estacion√°rio, se comparado a 2015 em 2024 tivemos uma diminui√ß√£o nas mortes em **25%**. 


```{r fig.align = 'center',  fig.height= 4, fig.width=10, out.width = "80%"}

titulo <- glue("Evolu√ß√£o das Mortes no Tr√¢nsito por Meio de Locomo√ß√£o da V√≠tima \n <b style='color:#18C5C9;'>Motocicleta</b>,  <b style='color:#F46FE5;'>Pedestre</b>, <b style='color:#F8837B;'>Autom√≥vel</b>, <b style='color:#BEA818;'>Bicicleta</b>, <b style='color:#599FED;'>√înibus</b>, <b style='color:#04BB3B;'>Caminh√£o</b>")

# Criar o gr√°fico interativo com linhas
grafico_interativo <- ggplot(dados_locomocao, aes(x = Ano, y = n, color = locomocao, 
                                                  group = locomocao,  # üîπ Garante que cada locomo√ß√£o tenha sua pr√≥pria linha
                                                  text = paste0("Ano: ", Ano, "<br>",
                                                                "Mortes: ", n, "<br>",
                                                                "Locomocao: ", locomocao, "<br>"))) +  
  geom_line(size = 0.5, alpha = 0.8) +  # üîπ Agora com linhas conectadas
  geom_point(size = 3, alpha = 0.9) +  # üîπ Mant√©m os pontos para destaque
  labs(title = titulo,
       x = "",
       y = "") +
  scale_x_continuous(breaks = seq(2015, 2024, 1)) + 
  MetBrewer::scale_fill_met_d("Redon", direction=1) +
  theme_minimal() +
  theme(plot.title = element_text(family = "Lora", size = 10, face = "bold", hjust = 0.5, colour = "black"),
        text = element_text(family = "Lora"),
        axis.text = element_text(size = 9),
        axis.text.x = element_text(size = 9),
        legend.position = "none")


# Converter para Plotly para adicionar interatividade
grafico_interativo_plotly <- ggplotly(grafico_interativo, tooltip = "text")

# Exibir o gr√°fico interativo
grafico_interativo_plotly



```


O gr√°fico abaixo mostra os mesmo dados do gr√°fico anterior mas nele podemos enxergar melhor as diferen√ßas proporcionais entre a quantidade de mortes de cada meio de locomo√ß√£o. A cidade de S√£o Paulo tem sido cada vez mais perigosa para motociclistas e ciclistas, ao passo que mais segura para os ocupantes de autom√≥veis e √¥nibus. Desde 2021 tamb√©m t√™m sido consistentemente mais perigoso ser um pedestre. 


```{r echo=FALSE,  fig.height= 10, fig.width=18, out.width="100%"}

col_vec <- c(
  "Motocicleta" = "#18C5C9",
  "Pedestre" = "#F46FE5",
  "Autom√≥vel" = "#F8837B",
  "Bicicleta" = "#BEA818",
  "√înibus" = "#599FED",
  "Caminh√£o" = "#04BB3B"
)



# Criar gr√°fico
  ggplot(dados_locomocao, 
                               aes(fill = locomocao, values = n)) +  # üîπ Removi `text =` daqui
  geom_waffle(color = "white", size = 0.01, n_rows = 12, flip = TRUE) +
  facet_wrap(~Ano, nrow = 1, strip.position = "bottom") +
  scale_x_discrete() + 
    scale_fill_manual(
    values = c("#18C5C9", alpha("#F46FE5", 1/3), alpha("#F8837B", 1/2), alpha("#BEA818", 1/3), alpha("#599FED", 1/2), alpha("#04BB3B", 1/3)
  ))+
  coord_equal() +
  labs(title = "Evolu√ß√£o das Mortes no Tr√¢nsito por Meio de Locomo√ß√£o da V√≠tima") +
  theme_minimal() +
  theme(
      # Texto
    plot.title = element_text(family = "Lora", size = 13, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(family = "Lora", size = 14, hjust = 0.5, colour = "gray30"),
    text = element_text(family = "Lora"),
    axis.text.x = element_text(size = 35), 
    axis.text.y = element_text(size = 12), 
    legend.position = "right", 
    legend.text = element_text(size = 11),
    legend.title = element_blank(), 
    legend.spacing.x = unit(2.5, 'cm'),  # üîπ Aumenta o espa√ßamento horizontal dos itens da legenda
    legend.key.width = unit(1.5, "cm"))

showtext_opts(dpi = 320)



```


O gr√°fico abaixo nos mostra a evolu√ß√£o da quantidade absoluta das mortes no transito em cada macroregi√£o da cidade. A zona leste e a zona sul s√£o as regi√µes com mais mortes em toda a s√©rie hist√≥rica. Apesar de n√∫meros bem pr√≥ximos, a zona sul t√™m sido a regi√£o mais letal da cidade em quase todos os anos. Chama √† aten√ß√£o tamb√©m que essa regi√£o esteja presenciando a maior s√∫bida initerrupta dos casos desde 2021 logo ap√≥s uma queda consistente de 2016 a 2021. O volume de √≥bitos aumentou **35%** em 2022, **15%** em 2023 e **13%** em 2024. Comparativamente com 2015, tivemos um aumento de **12%** nos √≥bitos da zona sul em 2024. 

Na zona leste, do mesmo modo que na zona sul, os √≥bitos vinham caindo de forma consistente desde 2015, quando come√ßaram a subir em 2021, para se ter uma ideia os √≥bitos nessa regi√£o subiram **49%** em 2022, o que pode, assim como nas outras regi√µes, marcar a passagem do per√≠odo de pandemia para o de abertura do isolamento social na cidade, os anos posteriores tiveram aumentos tamb√©m mas consideravelmente menores, **3%** em 2023 e **6%** em 2024. Comparativamente com 2015, os √≥bitos na zona leste dimin√≠ram **17%** em 2024. 

A zona norte √© terceira regi√£o com mais √≥bitos em termos absolutos. A regi√£o tamb√©m presenciou uma queda nos n√∫meros entre 2015 e 2017, quando come√ßa a subir at√© cair novamente durante o periodo da pandemia. Desde 2020 os √≥bitos tem aumentado de forma consistente, tendo permanecido est√°vel em 2023 at√© subir **24%** em 2024. Comparativamente com 2015, os √≥bitos permaneceram est√°veis em 2024, tendo ca√≠do apenas **0.5%**. 

A zona oeste e o centro t√™m s√©ries hist√≥ricas parecidas, acompanharam a tend√™ncia geral da cidade de queda nos √≥bitos entre 2015 e 2017, voltando a subir para novamente cair na √©poca da pandemia. A zona oeste viveu um aumento significativo em 2022 (**70%**), o maior p√≥s pandemia comparativamente com as outras regi√µes, mas tem ca√≠do na quantidade de √≥bitos mesmo que de forma sut√≠l, 2023 teve **4%** a menos e 2024  tamb√©m **4%*** a menos que o ano anterior. Comparativamente com 2015, os √≥bitos na zona oeste
diminu√≠ram em **37%**, no centro essa diminui√ß√£o foi de **60%**. 



```{r fig.align = 'center',  fig.height= 4, fig.width=10, out.width = "80%"}

titulo <- glue("Evolu√ß√£o das Mortes no Tr√¢nsito por Regi√£o de S√£o Paulo \n <b style='color:#E271F2;'>Sul</b>,  <b style='color:#AAAE27;'>Leste</b>, <b style='color:#40C48A;'>Norte</b>, <b style='color:#49B6F5;'>Oeste</b>, <b style='color:#F1877E;'>Centro</b>")

# Criar o gr√°fico interativo com linhas
grafico_interativo <- ggplot(mortes_regiao, aes(x = Ano, y = n, color = regiao, 
                                                  group = regiao,  # üîπ Garante que cada locomo√ß√£o tenha sua pr√≥pria linha
                                                  text = paste0("Ano: ", Ano, "<br>",
                                                                "Mortes: ", n, "<br>",
                                                                "regiao: ", regiao, "<br>"))) +  
  geom_line(size = 0.5, alpha = 0.8) +  # üîπ Agora com linhas conectadas
  geom_point(size = 3, alpha = 0.9) +  # üîπ Mant√©m os pontos para destaque
  labs(title = titulo,
       x = "",
       y = "") +
  scale_x_continuous(breaks = seq(2015, 2024, 1)) + 
  MetBrewer::scale_fill_met_d("Redon", direction=1) +
  theme_minimal() +
  theme(plot.title = element_text(family = "Lora", size = 10, face = "bold", hjust = 0.5, colour = "black"),
        text = element_text(family = "Lora"),
        axis.text = element_text(size = 9),
        axis.text.x = element_text(size = 9),
        legend.position = "none")


# Converter para Plotly para adicionar interatividade
grafico_interativo_plotly <- ggplotly(grafico_interativo, tooltip = "text")

# Exibir o gr√°fico interativo
grafico_interativo_plotly



```


## **An√°lise por Distrito**

O objetivo desta an√°lise √© entender quais s√£o os distritos mais perigosos para pedestres, motociclistas, usu√°rios de autom√≥veis e ciclistas. Para isso estamos comparando os distritos a partir de sua taxa de √≥bitos, em cada um desses meios de locomo√ß√£o, por 100 mil habitantes. 

No primeiro mapa √© poss√≠vel verificar que os distritos mais periogosos para pedestres (com taxa de mortes entre 41.5 e 227 por 100 mil hab.), classificados no mapa abaixo como 'Alto' risco,  por ordem de taxa de √≥bitos s√£o: **S√©,	Bom Retiro, Jaguar√°, Jacan√£, Rep√∫blica, Br√°s, Butant√£, Pari, Consola√ß√£o e Santo Amaro**. A S√© se destaca em rela√ß√£o aos outros distritos com uma taxa de 226, para se ter uma ideia o Bom Retiro mesmo ocupando o segundo lugar do ranking tem uma taxa de 110 mortes. De forma geral 


```{r eval=FALSE, include=FALSE}

shp_distritos_pedestres %>%  as.data.frame() %>% 
  filter(group_mortes_pedestres == ("(41.5,227]")) %>% 
  arrange(-mortes_cem_mil_hab) %>% 
  distinct(ds_nome)

```



```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}

dados_pedestres <- dados_filtrados %>% 
  filter(!is.na(ds_nome)) %>% 
  clean_names() %>% 
  group_by(ds_nome, pop, locomocao) %>% 
  tally() %>% 
  filter(locomocao == "PEDESTRE") %>% 
  mutate(mortes_cem_mil_hab = n/pop*100000)


shp_distritos_2 <- shp_distritos_1 %>%
  left_join(dados_pedestres, by = "ds_nome")

shp_distritos_pedestres <- shp_distritos_2 %>%
  mutate(group_mortes_pedestres = cut(mortes_cem_mil_hab, 
                            breaks = quantile(mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE), 
                            include.lowest = TRUE))

# Criar categorias para o gr√°fico lateral (percentual de distritos por faixa)
pop_mortes <- shp_distritos_pedestres %>%
  st_drop_geometry() %>%
  group_by(group_mortes_pedestres) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes_pedestres)
  ) %>%
  na.omit()

# Criar o mapa com os distritos de S√£o Paulo e a taxa de √≥bitos
pmap <- ggplot(shp_distritos_pedestres) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geometry, 
                          data_id = group_mortes_pedestres, 
                          tooltip = paste(ds_nome, "<br>√ìbitos de pedestres por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "√ìbitos por 100k",
    breaks = quantile(shp_distritos_pedestres$mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE),
    direction = 1,
    palette = "Reds"
  ) +
  labs(
    title = "",
    subtitle = "",
    caption = ""
  ) +
  theme_map() +
  guides(fill = "none")

# Criar o gr√°fico de barras laterais com os percentuais de distritos por taxa de √≥bitos
x_labels <- c("Baixo", "M√©dio-Baixo", "M√©dio", "M√©dio-Alto", "Alto")


pcol <- ggplot(pop_mortes, aes(group_mortes_pedestres, share, fill = group_mortes_pedestres)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
  aes(
    y = pmin(share + 5, max(share) - 2),  
    label = paste0(round(share, 1), "%"),  
    color = case_when(
      as.character(group_mortes_pedestres) == max(as.character(group_mortes_pedestres)) ~ "black",  # Converte para caractere
      TRUE ~ "white"
    ), 
    data_id = data_id
  ),
  size = 8, 
  hjust = -0.1 
) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 40)


# Aplicar ao gr√°fico a fonte 'Lora' e evitar cortes
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora")
) + coord_sf(expand = FALSE) + theme_void() +
  annotate("text", 
           x = mean(st_bbox(shp_distritos_pedestres)[c("xmin", "xmax")]),  # Centraliza no eixo X
           y = st_bbox(shp_distritos_pedestres)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_pedestres)[c("ymin", "ymax")]),  # Move para cima
           label = "Mortes de Pedestres p/ 100k hab.",
           hjust = 0.5, vjust = 1, size = 10, fontface = "bold", family = "Lora")

# Combinar o mapa e o gr√°fico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)


# Criar um gr√°fico interativo com ggiraph
interactive_plot_pedestres <- girafe(
  ggobj = p_final,
  width_svg = 14,   # Aumenta a largura do gr√°fico lateral
  height_svg = 12,   # Aumenta a altura do gr√°fico lateral
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)



interactive_plot_pedestres

```


```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}

dados_motos <- dados_filtrados %>% 
  filter(!is.na(ds_nome)) %>% 
  clean_names() %>% 
  group_by(ds_nome, pop, locomocao) %>% 
  tally() %>% 
  filter(locomocao == "MOTOCICLETA") %>% 
  mutate(mortes_cem_mil_hab = n/pop*100000)


shp_distritos_2 <- shp_distritos_1 %>%
  left_join(dados_motos, by = "ds_nome")

shp_distritos_motos <- shp_distritos_2 %>%
  mutate(group_mortes_motos = cut(mortes_cem_mil_hab, 
                            breaks = quantile(mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE), 
                            include.lowest = TRUE))

# Criar categorias para o gr√°fico lateral (percentual de distritos por faixa)
pop_mortes <- shp_distritos_motos %>%
  st_drop_geometry() %>%
  group_by(group_mortes_motos) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes_motos)
  ) %>%
  na.omit()


# Criar o mapa com os distritos de S√£o Paulo e a taxa de √≥bitos
pmap <- ggplot(shp_distritos_motos) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geometry, 
                          data_id = group_mortes_motos, 
                          tooltip = paste(ds_nome, "<br>√ìbitos de motociclistas por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "√ìbitos por 100k",
    breaks = quantile(shp_distritos_motos$mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE),
    direction = 1,
    palette = "Reds"
  ) +
  theme_map() +
  guides(fill = "none")

pcol <- ggplot(pop_mortes, aes(group_mortes_motos, share, fill = group_mortes_motos)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
  aes(
    y = pmin(share + 5, max(share) - 2),  
    label = paste0(round(share, 1), "%"),  
    color = case_when(
      as.character(group_mortes_motos) == max(as.character(group_mortes_motos)) ~ "black",  # Converte para caractere
      TRUE ~ "white"
    ), 
    data_id = data_id
  ),
  size = 8, 
  hjust = -0.1 
) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 40)

# Aplicar ao gr√°fico a fonte 'Lora' e evitar cortes
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora") +
  guides(fill = "none")) + coord_sf(expand = FALSE) + theme_void() +
  annotate("text", 
           x = mean(st_bbox(shp_distritos_motos)[c("xmin", "xmax")]),  
           y = st_bbox(shp_distritos_motos)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_motos)[c("ymin", "ymax")]),  
           label = "Mortes de Motociclistas p/ 100k hab.",
           hjust = 0.5, vjust = 1, size = 10, fontface = "bold", family = "Lora")

# Combinar o mapa e o gr√°fico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)

interactive_plot_2_moto <- girafe(
  ggobj = p_final,
  width_svg = 14,  
  height_svg = 12,   
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)





```


```{r, echo=FALSE, fig.height= 14, fig.width=16, out.width="200%", results="asis"}
library(htmltools)

# Criar layout flex√≠vel para exibir os gr√°ficos lado a lado
htmltools::browsable(
  tags$div(
    style = "display: flex; justify-content: space-between; align-items: center; width: 100%;",
    
    # Mapa interativo (primeiro gr√°fico)
    tags$div(style = "width: 50%;", interactive_plot_pedestres),  
    
    # Gr√°fico lateral interativo (segundo gr√°fico)
    tags$div(style = "width: 50%;", interactive_plot_2_moto)  
  )
)



```


```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}


dados_automovel <- dados_filtrados %>% 
  filter(!is.na(ds_nome)) %>% 
  clean_names() %>% 
  group_by(ds_nome, pop, locomocao) %>% 
  tally() %>% 
  filter(locomocao == "AUTOMOVEL") %>% 
  mutate(mortes_cem_mil_hab = n/pop*100000) %>% 
    bind_rows(
    data.frame(ds_nome = "Marsilac", mortes_cem_mil_hab = 0),
    data.frame(ds_nome = "Perdizes", mortes_cem_mil_hab = 0),
    data.frame(ds_nome = "Bela Vista", mortes_cem_mil_hab = 0)
  )

shp_distritos_2 <- shp_distritos_1 %>%
  left_join(dados_automovel, by = "ds_nome")

shp_distritos_automovel <- shp_distritos_2 %>%
  mutate(group_mortes_automovel = cut(mortes_cem_mil_hab, 
                            breaks = quantile(mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE), 
                            include.lowest = TRUE))

# Criar categorias para o gr√°fico lateral (percentual de distritos por faixa)
pop_mortes <- shp_distritos_automovel %>%
  st_drop_geometry() %>%
  group_by(group_mortes_automovel) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes_automovel)
  ) %>%
  na.omit()


# Criar o mapa com os distritos de S√£o Paulo e a taxa de √≥bitos
pmap <- ggplot(shp_distritos_automovel) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geometry, 
                          data_id = group_mortes_automovel, 
                          tooltip = paste(ds_nome, "<br>√ìbitos de condutores de autom√≥vel por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
scale_fill_fermenter(
    name = "√ìbitos por 100k",
    breaks = quantile(shp_distritos_automovel$mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE),
    direction = 1,
    palette = "Reds"
  ) +
  theme_map() +
  guides(fill = "none")

pcol <- ggplot(pop_mortes, aes(group_mortes_automovel, share, fill = group_mortes_automovel)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
  aes(
    y = pmin(share + 5, max(share) - 2),  
    label = paste0(round(share, 1), "%"),  
    color = case_when(
      as.character(group_mortes_automovel) == max(as.character(group_mortes_automovel)) ~ "black",  # Converte para caractere
      TRUE ~ "white"
    ), 
    data_id = data_id
  ),
  size = 8, 
  hjust = -0.1 
) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 40)

# Aplicar ao gr√°fico a fonte 'Lora' e evitar cortes
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora") +
  guides(fill = "none")) + coord_sf(expand = FALSE) + theme_void() +
  annotate("text", 
           x = mean(st_bbox(shp_distritos_automovel)[c("xmin", "xmax")]),  
           y = st_bbox(shp_distritos_automovel)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_automovel)[c("ymin", "ymax")]),  
           label = "Mortes de condutores de autom√≥veis \n p/ 100k hab.",
           hjust = 0.5, vjust = 1, size = 10, fontface = "bold", family = "Lora")

# Combinar o mapa e o gr√°fico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)

interactive_plot_2_auto <- girafe(
  ggobj = p_final,
  width_svg = 14,  
  height_svg = 12,   
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)




```


```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}


dados_ciclistas <- dados_filtrados %>% 
  filter(!is.na(ds_nome)) %>% 
  clean_names() %>% 
  group_by(ds_nome, pop, locomocao) %>% 
  tally() %>% 
  filter(locomocao == "BICICLETA") %>% 
  mutate(mortes_cem_mil_hab = n/pop*100000) %>% 
  bind_rows(
    data.frame(ds_nome = "Marsilac", mortes_cem_mil_hab = 0),
    data.frame(ds_nome = "Morumbi", mortes_cem_mil_hab = 0), 
    data.frame(ds_nome = "Rio Pequeno", mortes_cem_mil_hab = 0),
    data.frame(ds_nome = "Sao Domingos", mortes_cem_mil_hab = 0), 
    data.frame(ds_nome = "Liberdade", mortes_cem_mil_hab = 0), 
    data.frame(ds_nome = "Cidade Lider", mortes_cem_mil_hab = 0)
  )

shp_distritos_2 <- shp_distritos_1 %>%
  left_join(dados_ciclistas, by = "ds_nome")


shp_distritos_ciclistas <- shp_distritos_2 %>%
  mutate(group_mortes_ciclistas = cut(mortes_cem_mil_hab, 
                            breaks = quantile(mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE), 
                            include.lowest = TRUE))

# Criar categorias para o gr√°fico lateral (percentual de distritos por faixa)
pop_mortes <- shp_distritos_ciclistas %>%
  st_drop_geometry() %>%
  group_by(group_mortes_ciclistas) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes_ciclistas)
  ) %>%
  na.omit()

# Criar o mapa com os distritos de S√£o Paulo e a taxa de √≥bitos
pmap <- ggplot(shp_distritos_ciclistas) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geometry, 
                          data_id = group_mortes_ciclistas, 
                          tooltip = paste(ds_nome, "<br>√ìbitos de ciclistas por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
scale_fill_fermenter(
    name = "√ìbitos por 100k",
    breaks = quantile(shp_distritos_ciclistas$mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE),
    direction = 1,
    palette = "Reds"
  ) +
  theme_map() +
  guides(fill = "none")


pcol <- ggplot(pop_mortes, aes(group_mortes_ciclistas, share, fill = group_mortes_ciclistas)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
  aes(
    y = pmin(share + 5, max(share) - 2),  
    label = paste0(round(share, 1), "%"),  
    color = case_when(
      as.character(group_mortes_ciclistas) == max(as.character(group_mortes_ciclistas)) ~ "black",  # Converte para caractere
      TRUE ~ "white"
    ), 
    data_id = data_id
  ),
  size = 8, 
  hjust = -0.1 
) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 40)


# Aplicar ao gr√°fico a fonte 'Lora' e evitar cortes
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
) + coord_sf(expand = FALSE) + theme_void() +
  guides(fill = "none") +
  annotate("text", 
           x = mean(st_bbox(shp_distritos_ciclistas)[c("xmin", "xmax")]),  # Centraliza no eixo X
           y = st_bbox(shp_distritos_ciclistas)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_ciclistas)[c("ymin", "ymax")]),  # Move para cima
           label = "Mortes de Ciclistas p/ 100k hab.",
           hjust = 0.5, vjust = 1, size = 10, fontface = "bold", family = "Lora")


# Combinar o mapa e o gr√°fico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)

interactive_plot_2_ciclistas <- girafe(
  ggobj = p_final,
  width_svg = 14,   # Aumenta a largura do gr√°fico lateral
  height_svg = 12,   # Aumenta a altura do gr√°fico lateral
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)




```



```{r, echo=FALSE, fig.height= 14, fig.width=16, out.width="150%", results="asis"}
library(htmltools)

# Criar layout flex√≠vel para exibir os gr√°ficos lado a lado
htmltools::browsable(
  tags$div(
    style = "display: flex; justify-content: space-between; align-items: center; width: 100%;",
    
    # Mapa interativo (primeiro gr√°fico)
    tags$div(style = "width: 50%;", interactive_plot_2_auto),  
    
    # Gr√°fico lateral interativo (segundo gr√°fico)
    tags$div(style = "width: 50%;", interactive_plot_2_ciclistas)  
  )
)



```


## **Considera√ß√µes Finais**


## **Refer√™ncias**



&nbsp;
<hr />
<p style="text-align: center;">
  <strong>Equipe T√©cnica:</strong> <br />
  Hugo Nicolau Barbosa de Gusm√£o <br />
  Joaquim Lemos Ornellas <br />
  Luiza Mayare Reis Soares <br />
  Robson Cesar Zanovelo <br />
  Thais Fernandes Pereira
</p>

<p style="text-align: center;">
  <span style="color: #2F58A4;">
    <em>Relat√≥rio Executivo <br /> ADE SAMPA - 2025</em>
  </span>
</p>

&nbsp;









