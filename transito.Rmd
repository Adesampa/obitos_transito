---
title: An√°lise das Mortes no Tr√¢nsito no Munic√≠pio de S√£o Paulo
author: "Ag√™ncia S√£o Paulo de Desenvolvimento - ADE SAMPA"
date: "`r format(Sys.Date(), format='%d/%m/%Y')`"
output:
    html_document:
      theme: flatly
      self-contained: yes
      toc: yes
      toc_float: yes
      css: 
        - style.css
editor_options: 
  markdown: 
    wrap: 72
---


```{r setup, include=FALSE}

(knitr::opts_chunk$set(
	echo = FALSE,
	error = FALSE,
	message = FALSE,
	warning = FALSE
 )
) 
```


```{r}

library("ggpubr")
library("tidyverse")
library("kableExtra")
library("knitr")
library("tidylog")
library("readxl")
library("geobr")
library("sf")
library("wesanderson")
library("ggplot2")
library("stringr")
library ("abjData")
library("extrafont")
library("lubridate")
library("transformr")
library("reactable")
library("rnaturalearth")
library("plotly")
library("ggrepel")
library('googlesheets4')
library("leaflet")
library('ggthemes')
library('rmdformats')
library("janitor")
library("reactablefmtr")
library("corrplot")
library("lubridate")
library("janitor")
library("ggmap")
library("stringr")
library("stringi")
library("ggthemes")
library("ggiraph")
library("patchwork")
library("showtext")
library("htmltools")
library("gganimate")
library("gifski")
library("av")
library("scales")
library("png")
library("magick")

```



```{r include=FALSE}

# dowwnload dos dados do infosiga (https://www.infosiga.sp.gov.br/)


dados <- read.csv("C:/Users/Thais Pereira/Documents/obitos_transito/obitos.csv")

shp_distritos <- st_read("C:/Users/Thais Pereira/Documents/shapefile/distritos_cnpj_2.shp")

pop <- read_excel("C:/Users/Thais Pereira/Documents/obitos_transito/pop.xlsx")

```

```{r include=FALSE}

# Adicionar a fonte do Google Fonts
font_add_google("Lora", "Lora")

# Ativar suporte a fontes no ggplot
showtext_auto()


```

## **Resumo**


Esse relat√≥rio propr√µe uma an√°lise geoespacial detalhada dos dados de mortes no transito no munic√≠pio de S√£o Paulo entre os anos de 2015 e 2024, a partir dos dados disponibilizados pelo INFOSIGA SP - Sistema de Informa√ß√µes Gerenciais de Acidentes de Tr√¢nsito do Estado de S√£o Paulo. Pretendemos contribuir com uma an√°lise que identifica um perfil da popula√ß√£o vitimada pelos acidentes al√©m de situa√ß√µes e modais de risco para cada distrito da cidade. Pretendemos contribuir com o desenvolvimento de pol√≠ticas p√∫blicas baseadas em evid√™ncias das especificidades de cada regi√£o da cidade de S√£o Paulo. 

## **Introdu√ß√£o**

Lan√ßado em 2015, o INFOSIGA faz parte de um conjunto de iniciativas do Movimento Paulista de Seguran√ßa no Tr√¢nsito, lan√ßado pelo Governo do estado de S√£o Paulo em agosto de 2015, que tinha por objetivo reduzir pela metade as v√≠timas fatais em acidentes de tr√¢nsito at√© 2020. A meta estadual estava na √©poca, inspirada pela resolu√ß√£o de mar√ßo de 2010 da Assembleia-Geral das Na√ß√µes Unidas, definida como ‚ÄúPrimeira d√©cada de a√ß√£o pela seguran√ßa no tr√¢nsito". A campanha tinha por objetivo conscientizar os pa√≠ses a adotarem medidas visando a diminui√ß√£o dos n√∫meros de mortalidade no tr√¢nsito, e de fato mobilizou as autoridades de diversos pa√≠ses, a do Brasil inclusive, que se posicionou como pa√≠s signat√°rio da iniciativa, com engajamentos diversificados por parte dos gestores de transito. Ao final da primeira d√©cada a ONU lan√ßou em 2021 a ‚Äúsegunda d√©cada de a√ß√£o pela seguran√ßa no tr√¢nsito‚Äù incentivando os pa√≠ses a estipularem novas metas para 2030. 

A situa√ß√£o √© complicada no mundo todo, segundo dados da OMS de 2022, 1,3 milh√£o de pessoas morrem anualmente em acidentes de tr√¢nsito, o que supera em n√∫mero de mortos doen√ßas como o HIV/AIDS, tuberculose e doen√ßas diarreicas, sendo esta a 8¬™ causa do maior n√∫mero de mortes no mundo (WHO, 2018).

Em termos proporcionais √† popula√ß√£o, o Brasil tem dados alarmantes, o n√∫mero de mortos por 100 mil habitantes anualmente √© cerca de dez vezes maior que nos pa√≠ses mais seguros (IPEA, 2006, 2015), e na √©poca do lan√ßamento da primeira campanha da ONU eramos o quinto pais com mais mortes no transito no mundo, gerando um custo anual de cerca de de R$ 50 bilh√µes a pre√ßos atuais (IPEA, 2023).   

O INFOSIGA surge como uma ferramenta que possibilita a transpar√™ncia das informa√ß√µes e o subs√≠dio ao desenvolvimento de pol√≠ticas p√∫blicas de preven√ß√£o baseado em evid√™ncias. Os dados dispobilizados mensalmente s√£o baseados na sistematiza√ß√£o de boletins de ocorr√™ncia da Pol√≠cia Civil do Estado de S√£o Paulo, para o c√°lculo das estat√≠sticas relativas a √≥bitos no transito, al√©m dos dados que ser√£o analisados neste relat√≥rio a plataforma INFOSIGA tamb√©m disponibiliza informa√ß√µes de acidentes de transito com v√≠timas, utilizando os dados recebidos pela Pol√≠cia Militar e Pol√≠cia Rodovi√°ria Federal.

No √¢mbito nacional a Lei Federal n¬∫ 13.614/18 assinada em 11 de janeiro de 2018 criou o Plano Nacional de Redu√ß√£o de Mortes e Les√µes no Tr√¢nsito (Pnatrans), com uma s√©rie de diretrizes que visam a diminui√ß√£o de mortes e les√µes causadas por acidentes de tr√¢nsito. O principal objetivo √© diminuir a propor√ß√£o de mortos em rela√ß√£o √† popula√ß√£o e em rela√ß√£o ao n√∫mero de ve√≠culos de uma localidade num prazo de dez anos. 

Tendo em vista a demonstra√ß√£o de preocupa√ß√£o por parte das autoridades federais e estatuais no que diz respeito √†s mortes no transito, propomos primeiramente uma an√°lise geral da situa√ß√£o dos √≥bitos nos distritos da cidade de S√£o Paulo, depois uma an√°lise temporal para identificarmos mudan√ßas e tend√™ncias gerais e por √∫ltimo uma an√°lise geoespacial detalhada da popula√ß√£o, modais de risco para cada uma dessas regi√µes da cidade de S√£o Paulo, buscando sistematizar informa√ß√µes que podem direcionar a tomada de decis√£o do poder p√∫blico.  


## **Estat√≠sticas Gerais**


## 1. Mapas das mortes por distritos 

Os mapas apresentados abaixo mostram a distribui√ß√£o das mortes no tr√¢nsito na cidade de S√£o Paulo, destacando tanto os n√∫meros absolutos quanto a taxa de √≥bitos por 100 mil habitantes. Tendo como base que segundo o IBGE S√£o Paulo contava em 2022 com 11.451.999 habitantes, e entre 2015 e 2024 a cidade somou um total de **9.216** mortes no tr√¢nsito, temos uma taxa geral de **80,5** mortes para cada 100 mil habitantes. Em termos absolutos, os distritos com maior n√∫mero de √≥bitos foram Jardim **Jardim Sao Luis (231)**, **Graja√∫ (229)** e **Cidade Dutra (196)**, enquanto os que registraram menos mortes foram **Marsilac (4)**, **Perdizes (21)** e **Bela Vista (26)**. Quando analisamos os piores distritos em termos de taxa de mortalidade proporcional √† popula√ß√£o, os destaques negativos s√£o **S√© (314 mortes por 100 mil habitantes)**, **Jaragu√° (287)** e **Butant√£ (201)**, enquanto os distritos com menor impacto proporcional foram **Perdizes (20)**, **Jardim Helena (27)** e **Cidade L√≠der (33)**. Um adenso a utiliza√ß√£o da base de dados do Infogsiga √© que para 983 mortes n√£o foi poss√≠vel encontrar o distrito de acontecimento do acidente, ou por falta de informa√ß√µes de latitude e longitude ou por imprecis√£o do dado, no entanto somamos esse caso para as estat√≠sticas gerais. 



```{r include=FALSE}

dados_1 <- dados %>% 
  mutate(Data.do.Sinistro = dmy(Data.do.Sinistro),  
  Ano = year(Data.do.Sinistro)) %>% 
  filter(!is.na(ds_nome)) %>% 
  filter(Ano != 2012 & Ano != 2013 & Ano !=  2014 & Ano !=  2010 & Ano !=  1995 &  Ano !=  1986 & Ano !=  2000 & Ano !=  2009 & Ano !=  2011) %>% 
  clean_names() %>% 
  group_by(ds_nome) %>% 
  tally() %>% 
  mutate(ds_nome = str_to_title(ds_nome)) %>% 
  left_join(pop, by = "ds_nome") %>% 
  mutate(pct = n/sum(n)*100) %>% 
  mutate(mortes_cem_mil_hab = n/pop*100000)

# Transformar em coordenadas geogr√°ficas
shp_distritos <- st_transform(shp_distritos, crs = 4326)

shp_distritos <- shp_distritos %>% rename(ds_nome = NOME_DIST)

shp_distritos_1 <- shp_distritos %>% mutate(
    Indice = as.character(row_number()),
    ds_nome = str_trim(ds_nome),  
    ds_nome = stri_trans_general(ds_nome, "Latin-ASCII"), 
    ds_nome = str_to_title(ds_nome)  
  ) %>% 
  mutate(
    ds_nome = case_when(
      ds_nome == "Agua Rasa\n" ~ "Agua Rasa",
      ds_nome == "Alto De Pinheiros\n" ~ "Alto De Pinheiros",
      ds_nome == "Anhanguera\n" ~ "Anhanguera",
      TRUE ~ ds_nome
    )
  )

shp_distritos_2 <- shp_distritos_1 %>%
  left_join(dados_1, by = "ds_nome")


```



```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}

theme_update(plot.title = element_text(size = 24, face = "bold", hjust = 0.5, family = "Lora"))

# Criar categorias de √≥bitos
shp_distritos_3 <- shp_distritos_2 %>%
  mutate(group_n = cut(n, breaks = c(0, 50, 100, 150, 200, 250), include.lowest = TRUE))

# Criar categorias para o gr√°fico lateral
pop_n <- shp_distritos_3 %>%
  st_drop_geometry() %>%
  group_by(group_n) %>%
  summarise(score = sum(n, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_n)
  ) %>%
  na.omit()


# Criar o mapa com os distritos de S√£o Paulo e os √≥bitos
pmap <- ggplot(shp_distritos_3) +
  geom_sf_interactive(aes(fill = n, geometry = geometry, 
                          data_id = group_n, 
                          tooltip = paste(ds_nome, "<br>√ìbitos:", n)),  # Nome + √ìbitos
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "√ìbitos",
    breaks = c(50, 100, 150, 200, 250),
    direction = 1,
    palette = "Reds"
  ) +
  labs(
    title = "",
    subtitle = "",
    caption = ""
  ) +
  theme_map() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = rel(2), hjust = 0.5, family = "Lora"),
    plot.caption = element_text(size = 25, hjust = 0.5, family = "Lora")
  ) + 
  guides(fill = "none")

# Criar o gr√°fico de barras laterais com os percentuais
x_labels <- c("0-50", "51-100", "101-150", "151-200", "201-250+")

pcol <- ggplot(pop_n, aes(group_n, share, fill = group_n)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
    geom_text_interactive(
    aes(
      y = pmin(share + 5, max(share) - 2),  # Impede que o texto saia do gr√°fico
      label = label, 
      color = case_when(
        group_n == "201-250+" ~ "black",  # Apenas essa categoria ficar√° preta
        TRUE ~ "white"
      ), 
      data_id = data_id
    ),
    size = 8, 
    hjust = -0.1 # Mant√©m os textos afastados para a direita
  ) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 18),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_n$share) + 30)

# Aplicar ao gr√°fico
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora")) +
  coord_sf(expand = FALSE) +  # Evita cortes no mapa
  theme_void() +
    annotate("text", 
           x = mean(st_bbox(shp_distritos_3)[c("xmin", "xmax")]),  # Centraliza no eixo X
           y = st_bbox(shp_distritos_3)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_3)[c("ymin", "ymax")]),  # Move para cima
           label = "Total absoluto de mortes",
           hjust = 0.5, vjust = 1, size = 12, fontface = "bold", family = "Lora")


# Combinar o mapa e o gr√°fico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)

# Criar um gr√°fico interativo com ggiraph
interactive_plot <- girafe(
  ggobj = p_final,
  width_svg = 14,   # Aumenta a largura do gr√°fico lateral
  height_svg = 12,
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)


```




```{r fig.height=9, fig.width=11, include=FALSE, out.width="100%"}

theme_update(plot.title = element_text(size = 24, face = "bold", hjust = 0.5, family = "Lora"))

shp_distritos_3 <- shp_distritos_2 %>%
  mutate(group_mortes = cut(mortes_cem_mil_hab, 
                            breaks = quantile(mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE), 
                            include.lowest = TRUE))


# Criar categorias para o gr√°fico lateral (percentual de distritos por faixa)
pop_mortes <- shp_distritos_3 %>%
  st_drop_geometry() %>%
  group_by(group_mortes) %>%
  summarise(score = sum(mortes_cem_mil_hab, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(
    share = score / sum(score) * 100,
    y_text = if_else(share < 5, share + 3, share - 3),
    label = paste0(round(share, 1), "%"),
    data_id = as.character(group_mortes)
  ) %>%
  na.omit()

# Criar o mapa com os distritos de S√£o Paulo e a taxa de √≥bitos
pmap <- ggplot(shp_distritos_3) +
  geom_sf_interactive(aes(fill = mortes_cem_mil_hab, geometry = geometry, 
                          data_id = group_mortes, 
                          tooltip = paste(ds_nome, "<br>√ìbitos por 100k:", round(mortes_cem_mil_hab, 1))), 
                      lwd = 0.1, color = "white") +
  scale_fill_fermenter(
    name = "√ìbitos por 100k",
    breaks = quantile(shp_distritos_3$mortes_cem_mil_hab, probs = seq(0, 1, 0.2), na.rm = TRUE),
    direction = 1,
    palette = "Reds"
  ) +
  labs(
    title = "",
    subtitle = "",
    caption = ""
  ) +
  theme_map() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = rel(2), hjust = 0.5, family = "Lora"),
    plot.caption = element_text(size = 25, hjust = 0.5, family = "Lora")
  ) + 
  guides(fill = "none")

# Criar o gr√°fico de barras laterais com os percentuais de distritos por taxa de √≥bitos
x_labels <- c("Baixo", "M√©dio-Baixo", "M√©dio", "M√©dio-Alto", "Alto")

pcol <- ggplot(pop_mortes, aes(group_mortes, share, fill = group_mortes)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Share:", label))) +
  geom_hline(yintercept = 0) +
  geom_text_interactive(
  aes(
    y = pmin(share + 5, max(share) - 2),  
    label = paste0(round(share, 1), "%"),  
    color = case_when(
      as.character(group_mortes) == max(as.character(group_mortes)) ~ "black",  # Converte para caractere
      TRUE ~ "white"
    ), 
    data_id = data_id
  ),
  size = 8, 
  hjust = -0.1 
) +
  coord_flip() +
  scale_x_discrete(labels = x_labels) +
  scale_fill_brewer(palette = "Reds") +
  scale_color_manual(values = c(rep("black", 4), "white")) +
  guides(fill = "none", color = "none") +
  labs(
    title = "",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 20),
    axis.text.x = element_blank(),
    aspect.ratio = 1.5
  )

pcol <- pcol + expand_limits(y = max(pop_mortes$share) + 30)

# Aplicar ao gr√°fico a fonte 'Lora' e evitar cortes
pmap <- pmap + theme(
  text = element_text(family = "Lora"),
  axis.text = element_text(family = "Lora"),
  legend.text = element_text(family = "Lora"),
  legend.title = element_text(family = "Lora")
) + coord_sf(expand = FALSE) + theme_void() +
  annotate("text", 
           x = mean(st_bbox(shp_distritos_3)[c("xmin", "xmax")]),  # Centraliza no eixo X
           y = st_bbox(shp_distritos_3)["ymax"] + 0.05 * diff(st_bbox(shp_distritos_3)[c("ymin", "ymax")]),  # Move para cima
           label = "Taxa de mortes por 100k hab.",
           hjust = 0.5, vjust = 1, size = 12, fontface = "bold", family = "Lora")


# Combinar o mapa e o gr√°fico de barras laterais
p_final <- pmap + inset_element(pcol, left = 0.5, bottom = 0, right = 1, top = 0.5)


# Criar um gr√°fico interativo com ggiraph
interactive_plot_2 <- girafe(
  ggobj = p_final,
  width_svg = 14,   # Aumenta a largura do gr√°fico lateral
  height_svg = 12,   # Aumenta a altura do gr√°fico lateral
  options = list(
    opts_hover(css = "fill:#f58d17;"),
    opts_hover_inv(css = "opacity:0.5;"),
    opts_selection(type = "single", only_shiny = FALSE)
  )
)


```


```{r, echo=FALSE, fig.height= 14, fig.width=16, out.width="100%", results="asis"}
library(htmltools)

# Criar layout flex√≠vel para exibir os gr√°ficos lado a lado
htmltools::browsable(
  tags$div(
    style = "display: flex; justify-content: space-between; align-items: center; width: 100%;",
    
    # Mapa interativo (primeiro gr√°fico)
    tags$div(style = "width: 50%;", interactive_plot),  
    
    # Gr√°fico lateral interativo (segundo gr√°fico)
    tags$div(style = "width: 50%;", interactive_plot_2)  
  )
)



```

```{r include=FALSE}

# taxa de √≥bitos por 100k hab. e total de √≥bitos absolutos

dados %>% 
  mutate(Data.do.Sinistro = dmy(Data.do.Sinistro),  
  Ano = year(Data.do.Sinistro)) %>% 
  filter(Ano != 2012 & Ano != 2013 & Ano !=  2014 & Ano !=  2010 & Ano !=  1995 &  Ano !=  1986 & Ano !=  2000 & Ano !=  2009 & Ano !=  2011) %>% 
  clean_names() %>% 
  group_by(ds_nome) %>% 
  tally() %>% 
  mutate(ds_nome = str_to_title(ds_nome)) %>% 
  left_join(pop, by = "ds_nome") %>% 
  summarise(
    total_obitos = sum(n, na.rm = TRUE),
    total_populacao = sum(pop, na.rm = TRUE),  
    taxa_obitos = (sum(n, na.rm = TRUE) / sum(pop, na.rm = TRUE)) * 100000
  )

dados_1 %>% arrange(-n)

```


## **Quantidade de mortes ao longo do Tempo**


```{r echo=FALSE}

options(bitmapType = "cairo")

# Adicionar a fonte Lora
font_add_google("Lora", "Lora")
showtext_auto()

# Criar o gr√°fico animado
primeiro_gif <- dados %>% 
  mutate(Data.do.Sinistro = dmy(Data.do.Sinistro),  
         Ano = as.numeric(year(Data.do.Sinistro))) %>%  # üîπ Garante que Ano √© num√©rico
  filter(!Ano %in% c(2012, 2013, 2014, 2010, 1995, 1986, 2000, 2009, 2011)) %>%  # üîπ Remove anos indesejados
  group_by(Ano) %>% 
  tally() %>% 
  ggplot(aes(x = Ano, y = n)) +  
  geom_point(color = "#2F58A4", size = 5, alpha = 0.5) +  
  labs(title = "Evolu√ß√£o das Mortes no Tr√¢nsito",
       x = "",
       y = "") +
#  scale_x_continuous(breaks = Ano, labels = as.character(Ano))+  # üîπ Remove ".0" dos anos
  theme_minimal() +
  scale_x_continuous(breaks=seq(2015,2024,1)) +
  theme(plot.title = element_text(family = "Lora", size = 16, face = "bold", hjust = 0.5, colour = "black"),
        text = element_text(family = "Lora"),
        axis.text = element_text(size = 11),
        axis.text.x = element_text(size = 10),
        legend.text = element_text(size = 10, face = "bold"),
        legend.title = element_text(size = 10, face = "bold"),
        legend.position = "bottom") +
  transition_reveal(Ano) +  
  shadow_trail()

png(filename = "temp.png", width = 600, height = 400)
dev.off()

# Gerar a anima√ß√£o
animate(
    plot = primeiro_gif,
    renderer = gifski_renderer(),
    height = 400,
    width = 600, 
    duration = 10
)



```




## **An√°lise Socio econ√¥mica**


## **An√°lise por Distrito**


## **Considera√ß√µes Finais**


## **Refer√™ncias**













